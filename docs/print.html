<!DOCTYPE HTML>
<html lang="en" class="sidebar-visible no-js light">
    <head>
        <!-- Book generated using mdBook -->
        <meta charset="UTF-8">
        <title>The Kybra Book</title>
        <meta name="robots" content="noindex" />


        <!-- Custom HTML head -->
        
        <meta name="description" content="">
        <meta name="viewport" content="width=device-width, initial-scale=1">
        <meta name="theme-color" content="#ffffff" />

        <link rel="icon" href="favicon.svg">
        <link rel="shortcut icon" href="favicon.png">
        <link rel="stylesheet" href="css/variables.css">
        <link rel="stylesheet" href="css/general.css">
        <link rel="stylesheet" href="css/chrome.css">
        <link rel="stylesheet" href="css/print.css" media="print">

        <!-- Fonts -->
        <link rel="stylesheet" href="FontAwesome/css/font-awesome.css">
        <link rel="stylesheet" href="fonts/fonts.css">

        <!-- Highlight.js Stylesheets -->
        <link rel="stylesheet" href="highlight.css">
        <link rel="stylesheet" href="tomorrow-night.css">
        <link rel="stylesheet" href="ayu-highlight.css">

        <!-- Custom theme stylesheets -->

    </head>
    <body>
    <div id="body-container">
        <!-- Provide site root to javascript -->
        <script>
            var path_to_root = "";
            var default_theme = window.matchMedia("(prefers-color-scheme: dark)").matches ? "navy" : "light";
        </script>

        <!-- Work around some values being stored in localStorage wrapped in quotes -->
        <script>
            try {
                var theme = localStorage.getItem('mdbook-theme');
                var sidebar = localStorage.getItem('mdbook-sidebar');

                if (theme.startsWith('"') && theme.endsWith('"')) {
                    localStorage.setItem('mdbook-theme', theme.slice(1, theme.length - 1));
                }

                if (sidebar.startsWith('"') && sidebar.endsWith('"')) {
                    localStorage.setItem('mdbook-sidebar', sidebar.slice(1, sidebar.length - 1));
                }
            } catch (e) { }
        </script>

        <!-- Set the theme before any content is loaded, prevents flash -->
        <script>
            var theme;
            try { theme = localStorage.getItem('mdbook-theme'); } catch(e) { }
            if (theme === null || theme === undefined) { theme = default_theme; }
            var html = document.querySelector('html');
            html.classList.remove('no-js')
            html.classList.remove('light')
            html.classList.add(theme);
            html.classList.add('js');
        </script>

        <!-- Hide / unhide sidebar before it is displayed -->
        <script>
            var html = document.querySelector('html');
            var sidebar = null;
            if (document.body.clientWidth >= 1080) {
                try { sidebar = localStorage.getItem('mdbook-sidebar'); } catch(e) { }
                sidebar = sidebar || 'visible';
            } else {
                sidebar = 'hidden';
            }
            html.classList.remove('sidebar-visible');
            html.classList.add("sidebar-" + sidebar);
        </script>

        <nav id="sidebar" class="sidebar" aria-label="Table of contents">
            <div class="sidebar-scrollbox">
                <ol class="chapter"><li class="chapter-item expanded "><a href="the_kybra_book.html"><strong aria-hidden="true">1.</strong> The Kybra Book</a></li><li class="chapter-item expanded "><a href="kybra.html"><strong aria-hidden="true">2.</strong> Kybra (Beta)</a></li><li class="chapter-item expanded "><a href="installation.html"><strong aria-hidden="true">3.</strong> Installation</a></li><li class="chapter-item expanded "><a href="hello_world.html"><strong aria-hidden="true">4.</strong> Hello World</a></li><li class="chapter-item expanded "><a href="deployment.html"><strong aria-hidden="true">5.</strong> Deployment</a></li><li class="chapter-item expanded "><a href="examples.html"><strong aria-hidden="true">6.</strong> Examples</a></li><li class="chapter-item expanded "><a href="internet_computer_overview.html"><strong aria-hidden="true">7.</strong> Internet Computer Overview</a></li><li class="chapter-item expanded "><a href="canisters_overview.html"><strong aria-hidden="true">8.</strong> Canisters Overview</a></li><li class="chapter-item expanded "><a href="query_methods.html"><strong aria-hidden="true">9.</strong> Query Methods</a></li><li class="chapter-item expanded "><a href="update_methods.html"><strong aria-hidden="true">10.</strong> Update Methods</a></li><li class="chapter-item expanded "><a href="candid.html"><strong aria-hidden="true">11.</strong> Candid</a></li><li class="chapter-item expanded "><a href="stable_structures.html"><strong aria-hidden="true">12.</strong> Stable Structures</a></li><li class="chapter-item expanded "><a href="cross_canister.html"><strong aria-hidden="true">13.</strong> Cross-canister</a></li><li class="chapter-item expanded "><a href="http.html"><strong aria-hidden="true">14.</strong> HTTP</a></li><li class="chapter-item expanded "><a href="management_canister.html"><strong aria-hidden="true">15.</strong> Management Canister</a></li><li class="chapter-item expanded "><a href="canister_lifecycle.html"><strong aria-hidden="true">16.</strong> Canister Lifecycle</a></li><li class="chapter-item expanded "><a href="timers.html"><strong aria-hidden="true">17.</strong> Timers</a></li><li class="chapter-item expanded "><a href="cycles.html"><strong aria-hidden="true">18.</strong> Cycles</a></li><li class="chapter-item expanded "><a href="caveats.html"><strong aria-hidden="true">19.</strong> Caveats</a></li><li class="chapter-item expanded "><a href="reference/reference.html"><strong aria-hidden="true">20.</strong> Reference</a></li><li><ol class="section"><li class="chapter-item expanded "><a href="reference/call_apis/call_apis.html"><strong aria-hidden="true">20.1.</strong> Call APIs</a></li><li><ol class="section"><li class="chapter-item expanded "><a href="reference/call_apis/accept_message.html"><strong aria-hidden="true">20.1.1.</strong> accept message</a></li><li class="chapter-item expanded "><a href="reference/call_apis/arg_data_raw.html"><strong aria-hidden="true">20.1.2.</strong> arg data raw</a></li><li class="chapter-item expanded "><a href="reference/call_apis/arg_data_raw_size.html"><strong aria-hidden="true">20.1.3.</strong> arg data raw size</a></li><li class="chapter-item expanded "><a href="reference/call_apis/call.html"><strong aria-hidden="true">20.1.4.</strong> call</a></li><li class="chapter-item expanded "><a href="reference/call_apis/call_raw.html"><strong aria-hidden="true">20.1.5.</strong> call raw</a></li><li class="chapter-item expanded "><a href="reference/call_apis/call_raw128.html"><strong aria-hidden="true">20.1.6.</strong> call raw 128</a></li><li class="chapter-item expanded "><a href="reference/call_apis/call_with_payment.html"><strong aria-hidden="true">20.1.7.</strong> call with payment</a></li><li class="chapter-item expanded "><a href="reference/call_apis/call_with_payment128.html"><strong aria-hidden="true">20.1.8.</strong> call with payment 128</a></li><li class="chapter-item expanded "><a href="reference/call_apis/caller.html"><strong aria-hidden="true">20.1.9.</strong> caller</a></li><li class="chapter-item expanded "><a href="reference/call_apis/method_name.html"><strong aria-hidden="true">20.1.10.</strong> method name</a></li><li class="chapter-item expanded "><a href="reference/call_apis/msg_cycles_accept.html"><strong aria-hidden="true">20.1.11.</strong> msg cycles accept</a></li><li class="chapter-item expanded "><a href="reference/call_apis/msg_cycles_accept128.html"><strong aria-hidden="true">20.1.12.</strong> msg cycles accept 128</a></li><li class="chapter-item expanded "><a href="reference/call_apis/msg_cycles_available.html"><strong aria-hidden="true">20.1.13.</strong> msg cycles available</a></li><li class="chapter-item expanded "><a href="reference/call_apis/msg_cycles_available128.html"><strong aria-hidden="true">20.1.14.</strong> msg cycles available 128</a></li><li class="chapter-item expanded "><a href="reference/call_apis/msg_cycles_refunded.html"><strong aria-hidden="true">20.1.15.</strong> msg cycles refunded</a></li><li class="chapter-item expanded "><a href="reference/call_apis/msg_cycles_refunded128.html"><strong aria-hidden="true">20.1.16.</strong> msg cycles refunded 128</a></li><li class="chapter-item expanded "><a href="reference/call_apis/notify.html"><strong aria-hidden="true">20.1.17.</strong> notify</a></li><li class="chapter-item expanded "><a href="reference/call_apis/notify_raw.html"><strong aria-hidden="true">20.1.18.</strong> notify raw</a></li><li class="chapter-item expanded "><a href="reference/call_apis/notify_with_payment_128.html"><strong aria-hidden="true">20.1.19.</strong> notify with payment 128</a></li><li class="chapter-item expanded "><a href="reference/call_apis/performance_counter.html"><strong aria-hidden="true">20.1.20.</strong> performance counter</a></li><li class="chapter-item expanded "><a href="reference/call_apis/reject.html"><strong aria-hidden="true">20.1.21.</strong> reject</a></li><li class="chapter-item expanded "><a href="reference/call_apis/reject_code.html"><strong aria-hidden="true">20.1.22.</strong> reject code</a></li><li class="chapter-item expanded "><a href="reference/call_apis/reject_message.html"><strong aria-hidden="true">20.1.23.</strong> reject message</a></li><li class="chapter-item expanded "><a href="reference/call_apis/reply.html"><strong aria-hidden="true">20.1.24.</strong> reply</a></li><li class="chapter-item expanded "><a href="reference/call_apis/reply_raw.html"><strong aria-hidden="true">20.1.25.</strong> reply raw</a></li></ol></li><li class="chapter-item expanded "><a href="reference/candid/candid.html"><strong aria-hidden="true">20.2.</strong> Candid</a></li><li><ol class="section"><li class="chapter-item expanded "><a href="reference/candid/blob.html"><strong aria-hidden="true">20.2.1.</strong> blob</a></li><li class="chapter-item expanded "><a href="reference/candid/bool.html"><strong aria-hidden="true">20.2.2.</strong> bool</a></li><li class="chapter-item expanded "><a href="reference/candid/empty.html"><strong aria-hidden="true">20.2.3.</strong> empty</a></li><li class="chapter-item expanded "><a href="reference/candid/float32.html"><strong aria-hidden="true">20.2.4.</strong> float32</a></li><li class="chapter-item expanded "><a href="reference/candid/float64.html"><strong aria-hidden="true">20.2.5.</strong> float64</a></li><li class="chapter-item expanded "><a href="reference/candid/func.html"><strong aria-hidden="true">20.2.6.</strong> func</a></li><li class="chapter-item expanded "><a href="reference/candid/int.html"><strong aria-hidden="true">20.2.7.</strong> int</a></li><li class="chapter-item expanded "><a href="reference/candid/int8.html"><strong aria-hidden="true">20.2.8.</strong> int8</a></li><li class="chapter-item expanded "><a href="reference/candid/int16.html"><strong aria-hidden="true">20.2.9.</strong> int16</a></li><li class="chapter-item expanded "><a href="reference/candid/int32.html"><strong aria-hidden="true">20.2.10.</strong> int32</a></li><li class="chapter-item expanded "><a href="reference/candid/int64.html"><strong aria-hidden="true">20.2.11.</strong> int64</a></li><li class="chapter-item expanded "><a href="reference/candid/nat.html"><strong aria-hidden="true">20.2.12.</strong> nat</a></li><li class="chapter-item expanded "><a href="reference/candid/nat8.html"><strong aria-hidden="true">20.2.13.</strong> nat8</a></li><li class="chapter-item expanded "><a href="reference/candid/nat16.html"><strong aria-hidden="true">20.2.14.</strong> nat16</a></li><li class="chapter-item expanded "><a href="reference/candid/nat32.html"><strong aria-hidden="true">20.2.15.</strong> nat32</a></li><li class="chapter-item expanded "><a href="reference/candid/nat64.html"><strong aria-hidden="true">20.2.16.</strong> nat64</a></li><li class="chapter-item expanded "><a href="reference/candid/null.html"><strong aria-hidden="true">20.2.17.</strong> null</a></li><li class="chapter-item expanded "><a href="reference/candid/opt.html"><strong aria-hidden="true">20.2.18.</strong> opt</a></li><li class="chapter-item expanded "><a href="reference/candid/principal.html"><strong aria-hidden="true">20.2.19.</strong> principal</a></li><li class="chapter-item expanded "><a href="reference/candid/record.html"><strong aria-hidden="true">20.2.20.</strong> record</a></li><li class="chapter-item expanded "><a href="reference/candid/reserved.html"><strong aria-hidden="true">20.2.21.</strong> reserved</a></li><li class="chapter-item expanded "><a href="reference/candid/service.html"><strong aria-hidden="true">20.2.22.</strong> service</a></li><li class="chapter-item expanded "><a href="reference/candid/text.html"><strong aria-hidden="true">20.2.23.</strong> text</a></li><li class="chapter-item expanded "><a href="reference/candid/variant.html"><strong aria-hidden="true">20.2.24.</strong> variant</a></li><li class="chapter-item expanded "><a href="reference/candid/vec.html"><strong aria-hidden="true">20.2.25.</strong> vec</a></li></ol></li><li class="chapter-item expanded "><a href="reference/canister_apis/canister_apis.html"><strong aria-hidden="true">20.3.</strong> Canister APIs</a></li><li><ol class="section"><li class="chapter-item expanded "><a href="reference/canister_apis/candid_decode.html"><strong aria-hidden="true">20.3.1.</strong> candid decode</a></li><li class="chapter-item expanded "><a href="reference/canister_apis/candid_encode.html"><strong aria-hidden="true">20.3.2.</strong> candid encode</a></li><li class="chapter-item expanded "><a href="reference/canister_apis/canister_balance.html"><strong aria-hidden="true">20.3.3.</strong> canister balance</a></li><li class="chapter-item expanded "><a href="reference/canister_apis/canister_balance128.html"><strong aria-hidden="true">20.3.4.</strong> canister balance 128</a></li><li class="chapter-item expanded "><a href="reference/canister_apis/canister_id.html"><strong aria-hidden="true">20.3.5.</strong> canister id</a></li><li class="chapter-item expanded "><a href="reference/canister_apis/data_certificate.html"><strong aria-hidden="true">20.3.6.</strong> data certificate</a></li><li class="chapter-item expanded "><a href="reference/canister_apis/print.html"><strong aria-hidden="true">20.3.7.</strong> print</a></li><li class="chapter-item expanded "><a href="reference/canister_apis/set_certified_data.html"><strong aria-hidden="true">20.3.8.</strong> set certified data</a></li><li class="chapter-item expanded "><a href="reference/canister_apis/time.html"><strong aria-hidden="true">20.3.9.</strong> time</a></li><li class="chapter-item expanded "><a href="reference/canister_apis/trap.html"><strong aria-hidden="true">20.3.10.</strong> trap</a></li></ol></li><li class="chapter-item expanded "><a href="reference/canister_methods/canister_methods.html"><strong aria-hidden="true">20.4.</strong> Canister Methods</a></li><li><ol class="section"><li class="chapter-item expanded "><a href="reference/canister_methods/heartbeat.html"><strong aria-hidden="true">20.4.1.</strong> heartbeat</a></li><li class="chapter-item expanded "><a href="reference/canister_methods/http_request.html"><strong aria-hidden="true">20.4.2.</strong> http_request</a></li><li class="chapter-item expanded "><a href="reference/canister_methods/http_request_update.html"><strong aria-hidden="true">20.4.3.</strong> http_request_update</a></li><li class="chapter-item expanded "><a href="reference/canister_methods/init.html"><strong aria-hidden="true">20.4.4.</strong> init</a></li><li class="chapter-item expanded "><a href="reference/canister_methods/inspect_message.html"><strong aria-hidden="true">20.4.5.</strong> inspect message</a></li><li class="chapter-item expanded "><a href="reference/canister_methods/post_upgrade.html"><strong aria-hidden="true">20.4.6.</strong> post upgrade</a></li><li class="chapter-item expanded "><a href="reference/canister_methods/pre_upgrade.html"><strong aria-hidden="true">20.4.7.</strong> pre upgrade</a></li><li class="chapter-item expanded "><a href="reference/canister_methods/query.html"><strong aria-hidden="true">20.4.8.</strong> query</a></li><li class="chapter-item expanded "><a href="reference/canister_methods/update.html"><strong aria-hidden="true">20.4.9.</strong> update</a></li></ol></li><li class="chapter-item expanded "><a href="reference/guard_functions.html"><strong aria-hidden="true">20.5.</strong> Guard Functions</a></li><li class="chapter-item expanded "><a href="reference/management_canister/management_canister.html"><strong aria-hidden="true">20.6.</strong> Management Canister</a></li><li><ol class="section"><li class="chapter-item expanded "><a href="reference/management_canister/bitcoin_get_balance.html"><strong aria-hidden="true">20.6.1.</strong> bitcoin_get_balance</a></li><li class="chapter-item expanded "><a href="reference/management_canister/bitcoin_get_current_fee_percentiles.html"><strong aria-hidden="true">20.6.2.</strong> bitcoin_get_current_fee_percentiles</a></li><li class="chapter-item expanded "><a href="reference/management_canister/bitcoin_get_utxos.html"><strong aria-hidden="true">20.6.3.</strong> bitcoin_get_utxos</a></li><li class="chapter-item expanded "><a href="reference/management_canister/bitcoin_send_transaction.html"><strong aria-hidden="true">20.6.4.</strong> bitcoin_send_transaction</a></li><li class="chapter-item expanded "><a href="reference/management_canister/canister_status.html"><strong aria-hidden="true">20.6.5.</strong> canister_status</a></li><li class="chapter-item expanded "><a href="reference/management_canister/create_canister.html"><strong aria-hidden="true">20.6.6.</strong> create_canister</a></li><li class="chapter-item expanded "><a href="reference/management_canister/delete_canister.html"><strong aria-hidden="true">20.6.7.</strong> delete_canister</a></li><li class="chapter-item expanded "><a href="reference/management_canister/deposit_cycles.html"><strong aria-hidden="true">20.6.8.</strong> deposit_cycles</a></li><li class="chapter-item expanded "><a href="reference/management_canister/ecdsa_public_key.html"><strong aria-hidden="true">20.6.9.</strong> ecdsa_public_key</a></li><li class="chapter-item expanded "><a href="reference/management_canister/http_request.html"><strong aria-hidden="true">20.6.10.</strong> http_request</a></li><li class="chapter-item expanded "><a href="reference/management_canister/install_code.html"><strong aria-hidden="true">20.6.11.</strong> install_code</a></li><li class="chapter-item expanded "><a href="reference/management_canister/provisional_create_canister_with_cycles.html"><strong aria-hidden="true">20.6.12.</strong> provisional_create_canister_with_cycles</a></li><li class="chapter-item expanded "><a href="reference/management_canister/provisional_top_up_canister.html"><strong aria-hidden="true">20.6.13.</strong> provisional_top_up_canister</a></li><li class="chapter-item expanded "><a href="reference/management_canister/raw_rand.html"><strong aria-hidden="true">20.6.14.</strong> raw_rand</a></li><li class="chapter-item expanded "><a href="reference/management_canister/sign_with_ecdsa.html"><strong aria-hidden="true">20.6.15.</strong> sign_with_ecdsa</a></li><li class="chapter-item expanded "><a href="reference/management_canister/start_canister.html"><strong aria-hidden="true">20.6.16.</strong> start_canister</a></li><li class="chapter-item expanded "><a href="reference/management_canister/stop_canister.html"><strong aria-hidden="true">20.6.17.</strong> stop_canister</a></li><li class="chapter-item expanded "><a href="reference/management_canister/uninstall_code.html"><strong aria-hidden="true">20.6.18.</strong> uninstall_code</a></li><li class="chapter-item expanded "><a href="reference/management_canister/update_settings.html"><strong aria-hidden="true">20.6.19.</strong> update_settings</a></li></ol></li><li class="chapter-item expanded "><a href="reference/stable_memory/stable_memory.html"><strong aria-hidden="true">20.7.</strong> Stable Memory</a></li><li><ol class="section"><li class="chapter-item expanded "><a href="reference/stable_memory/stable_structures.html"><strong aria-hidden="true">20.7.1.</strong> stable structures</a></li><li class="chapter-item expanded "><a href="reference/stable_memory/stable_bytes.html"><strong aria-hidden="true">20.7.2.</strong> stable bytes</a></li><li class="chapter-item expanded "><a href="reference/stable_memory/stable_grow.html"><strong aria-hidden="true">20.7.3.</strong> stable grow</a></li><li class="chapter-item expanded "><a href="reference/stable_memory/stable_read.html"><strong aria-hidden="true">20.7.4.</strong> stable read</a></li><li class="chapter-item expanded "><a href="reference/stable_memory/stable_size.html"><strong aria-hidden="true">20.7.5.</strong> stable size</a></li><li class="chapter-item expanded "><a href="reference/stable_memory/stable_write.html"><strong aria-hidden="true">20.7.6.</strong> stable write</a></li><li class="chapter-item expanded "><a href="reference/stable_memory/stable64_grow.html"><strong aria-hidden="true">20.7.7.</strong> stable64 grow</a></li><li class="chapter-item expanded "><a href="reference/stable_memory/stable64_read.html"><strong aria-hidden="true">20.7.8.</strong> stable64 read</a></li><li class="chapter-item expanded "><a href="reference/stable_memory/stable64_size.html"><strong aria-hidden="true">20.7.9.</strong> stable64 size</a></li><li class="chapter-item expanded "><a href="reference/stable_memory/stable64_write.html"><strong aria-hidden="true">20.7.10.</strong> stable64 write</a></li></ol></li><li class="chapter-item expanded "><a href="reference/timers/timers.html"><strong aria-hidden="true">20.8.</strong> Timers</a></li><li><ol class="section"><li class="chapter-item expanded "><a href="reference/timers/clear_timer.html"><strong aria-hidden="true">20.8.1.</strong> clear timer</a></li><li class="chapter-item expanded "><a href="reference/timers/set_timer.html"><strong aria-hidden="true">20.8.2.</strong> set timer</a></li><li class="chapter-item expanded "><a href="reference/timers/set_timer_interval.html"><strong aria-hidden="true">20.8.3.</strong> set timer interval</a></li></ol></li></ol></li></ol>
            </div>
            <div id="sidebar-resize-handle" class="sidebar-resize-handle"></div>
        </nav>

        <div id="page-wrapper" class="page-wrapper">

            <div class="page">
                                <div id="menu-bar-hover-placeholder"></div>
                <div id="menu-bar" class="menu-bar sticky bordered">
                    <div class="left-buttons">
                        <button id="sidebar-toggle" class="icon-button" type="button" title="Toggle Table of Contents" aria-label="Toggle Table of Contents" aria-controls="sidebar">
                            <i class="fa fa-bars"></i>
                        </button>
                        <button id="theme-toggle" class="icon-button" type="button" title="Change theme" aria-label="Change theme" aria-haspopup="true" aria-expanded="false" aria-controls="theme-list">
                            <i class="fa fa-paint-brush"></i>
                        </button>
                        <ul id="theme-list" class="theme-popup" aria-label="Themes" role="menu">
                            <li role="none"><button role="menuitem" class="theme" id="light">Light</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="rust">Rust</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="coal">Coal</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="navy">Navy</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="ayu">Ayu</button></li>
                        </ul>
                        <button id="search-toggle" class="icon-button" type="button" title="Search. (Shortkey: s)" aria-label="Toggle Searchbar" aria-expanded="false" aria-keyshortcuts="S" aria-controls="searchbar">
                            <i class="fa fa-search"></i>
                        </button>
                    </div>

                    <h1 class="menu-title">The Kybra Book</h1>

                    <div class="right-buttons">
                        <a href="print.html" title="Print this book" aria-label="Print this book">
                            <i id="print-button" class="fa fa-print"></i>
                        </a>

                    </div>
                </div>

                <div id="search-wrapper" class="hidden">
                    <form id="searchbar-outer" class="searchbar-outer">
                        <input type="search" id="searchbar" name="searchbar" placeholder="Search this book ..." aria-controls="searchresults-outer" aria-describedby="searchresults-header">
                    </form>
                    <div id="searchresults-outer" class="searchresults-outer hidden">
                        <div id="searchresults-header" class="searchresults-header"></div>
                        <ul id="searchresults">
                        </ul>
                    </div>
                </div>

                <!-- Apply ARIA attributes after the sidebar and the sidebar toggle button are added to the DOM -->
                <script>
                    document.getElementById('sidebar-toggle').setAttribute('aria-expanded', sidebar === 'visible');
                    document.getElementById('sidebar').setAttribute('aria-hidden', sidebar !== 'visible');
                    Array.from(document.querySelectorAll('#sidebar a')).forEach(function(link) {
                        link.setAttribute('tabIndex', sidebar === 'visible' ? 0 : -1);
                    });
                </script>

                <div id="content" class="content">
                    <main>
                        <h1 id="the-kybra-book"><a class="header" href="#the-kybra-book">The Kybra Book</a></h1>
<div style="display: flex; justify-content: center">
    <img src="favicon.svg" alt="The Kybra Logo" height="250px" />
</div>
<p>This book is intended to be an in-depth guide to <a href="https://internetcomputer.org/docs/current/concepts/canisters-code">canister</a> development in <a href="https://www.python.org/">Python</a> on the <a href="https://internetcomputer.org/">Internet Computer</a> (IC).</p>
<p>The first 19 chapters are an introductory guide into canister development with <a href="./kybra.html">Kybra</a>. These chapters build on each other concept by concept, introducing the fundamentals required to create and deploy canisters to the IC.</p>
<p>Chapter 20 is an in-depth reference of the APIs available to Kybra canisters.</p>
<p>Our intention is for new developers to use this book as a tutorial or course, starting at chapter 1 and working through chapter 19, using chapter 20 as a reference.</p>
<p>There will also be a companion video series on YouTube. Each chapter here will begin with the video companion as soon as it is available.</p>
<p>You should expect this book and its companion video series to continue to grow and change over time, as its authors and the IC grow and change.</p>
<p>The Kybra Book is subject to the following license:</p>
<pre><code>MIT License

Copyright (c) 2024 Demergent Labs LLC

Permission is hereby granted, free of charge, to any person obtaining a copy
of this software and associated documentation files (the &quot;Software&quot;), to deal
in the Software without restriction, including without limitation the rights
to use, copy, modify, merge, publish, distribute, sublicense, and/or sell
copies of the Software, and to permit persons to whom the Software is
furnished to do so, subject to the following conditions:

The above copyright notice and this permission notice shall be included in all
copies or substantial portions of the Software.

THE SOFTWARE IS PROVIDED &quot;AS IS&quot;, WITHOUT WARRANTY OF ANY KIND, EXPRESS OR
IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF MERCHANTABILITY,
FITNESS FOR A PARTICULAR PURPOSE AND NONINFRINGEMENT. IN NO EVENT SHALL THE
AUTHORS OR COPYRIGHT HOLDERS BE LIABLE FOR ANY CLAIM, DAMAGES OR OTHER
LIABILITY, WHETHER IN AN ACTION OF CONTRACT, TORT OR OTHERWISE, ARISING FROM,
OUT OF OR IN CONNECTION WITH THE SOFTWARE OR THE USE OR OTHER DEALINGS IN THE
SOFTWARE.
</code></pre>
<div style="break-before: page; page-break-before: always;"></div><h1 id="kybra-beta"><a class="header" href="#kybra-beta">Kybra (Beta)</a></h1>
<p>Kybra is a <a href="https://www.python.org/">Python</a> <a href="https://internetcomputer.org/docs/current/developer-docs/backend/choosing-language">Canister Development Kit</a> (CDK) for the <a href="https://internetcomputer.org/">Internet Computer</a> (IC). In other words, it's a Python runtime for building applications (<a href="https://internetcomputer.org/docs/current/concepts/canisters-code">canisters</a>) on the IC.</p>
<ul>
<li><a href="https://github.com/demergent-labs/kybra">GitHub repo</a></li>
<li><a href="https://pypi.org/project/kybra/">PyPI package</a></li>
<li><a href="https://discord.gg/ux2Jc7psjd">Discord channel</a></li>
</ul>
<h2 id="disclaimer"><a class="header" href="#disclaimer">Disclaimer</a></h2>
<p>Kybra may have unknown security vulnerabilities due to the following:</p>
<ul>
<li>Kybra does not yet have many live, successful, continuously operating applications deployed to the IC</li>
<li>Kybra does not yet have extensive automated property tests</li>
<li>Kybra does not yet have multiple independent security reviews/audits</li>
<li>Kybra uses a new Python interpreter that is less mature than CPython</li>
</ul>
<h2 id="roadmap"><a class="header" href="#roadmap">Roadmap</a></h2>
<p>We hope to get to a production-ready 1.0 in 2024. The following are the major blockers to 1.0:</p>
<ul>
<li>CPython integration for performance, security, and stability</li>
<li>Broad PyPI package support (C API/extensions)</li>
<li>Extensive automated property testing</li>
<li>Multiple independent security reviews/audits</li>
</ul>
<h2 id="demergent-labs"><a class="header" href="#demergent-labs">Demergent Labs</a></h2>
<p>Kybra is currently developed by <a href="https://github.com/demergent-labs">Demergent Labs</a>, a for-profit company with a <a href="https://dfinity.org/grants">grant</a> from <a href="https://dfinity.org/">DFINITY</a>.</p>
<p>Demergent Labs' <a href="https://github.com/demergent-labs/blog/blob/main/demergent-labs-grand-plan-part-1.md">vision</a> is to accelerate the adoption of Web3, the Internet Computer, and sustainable open source.</p>
<h2 id="benefits-and-drawbacks"><a class="header" href="#benefits-and-drawbacks">Benefits and drawbacks</a></h2>
<p>Kybra and the IC provide unique benefits and drawbacks, and both are not currently suitable for all application use-cases.</p>
<p>The following information will help you to determine when Kybra and the IC might be beneficial for your use-case.</p>
<h3 id="benefits"><a class="header" href="#benefits">Benefits</a></h3>
<p>Kybra intends to be a full Python environment for the IC (a decentralized cloud platform), with support for all of the Python language and as many relevant libraries and APIs as possible.</p>
<p>One of the core benefits of Kybra is that it allows Python developers to bring their skills to the IC.</p>
<p>As for the IC, we believe its main benefits can be broken down into the following categories:</p>
<ul>
<li><a href="kybra.html#ownership">Ownership</a></li>
<li><a href="kybra.html#security">Security</a></li>
<li><a href="kybra.html#developer-experience">Developer Experience</a></li>
</ul>
<p>Most of these benefits stem from the decentralized nature of the IC, though the IC is best thought of as a progressively decentralizing cloud platform. As opposed to traditional cloud platforms, its goal is to be owned and controlled by many independent entities.</p>
<h4 id="ownership"><a class="header" href="#ownership">Ownership</a></h4>
<ul>
<li><a href="kybra.html#full-stack-group-ownership">Full-stack group ownership</a></li>
<li><a href="kybra.html#autonomous-ownership">Autonomous ownership</a></li>
<li><a href="kybra.html#permanent-apis">Permanent APIs</a></li>
<li><a href="kybra.html#credible-neutrality">Credible neutrality</a></li>
<li><a href="kybra.html#reduced-platform-risk">Reduced platform risk</a></li>
</ul>
<h5 id="full-stack-group-ownership"><a class="header" href="#full-stack-group-ownership">Full-stack group ownership</a></h5>
<p>The IC allows you to build applications that are controlled directly and only (with some caveats) by a group of people. This is in opposition to most cloud applications written today, which must be under the control of a very limited number of people and often a single legal entity that answers directly to a cloud provider, which itself is a single legal entity.</p>
<p>In the blockchain world, group-owned applications are known as <a href="https://en.wikipedia.org/wiki/Decentralized_autonomous_organization">DAOs</a>. As opposed to DAOs built on most blockchains, the IC allows full-stack applications to be controlled by groups. This means that the group fully controls the running instances of the frontend and the backend code.</p>
<h5 id="autonomous-ownership"><a class="header" href="#autonomous-ownership">Autonomous ownership</a></h5>
<p>In addition to allowing applications to be owned by groups of people, the IC also allows applications to be owned by no one. This essentially creates autonomous applications or everlasting processes that execute indefinitely. The IC will allow such an application to run until it depletes its balance of cycles, or until the <a href="https://internetcomputer.org/nns">NNS</a> votes to shut it down.</p>
<h5 id="permanent-apis"><a class="header" href="#permanent-apis">Permanent APIs</a></h5>
<p>Because most web APIs are owned and operated by individual entities, their fate is tied to that of their owners. If their owners go out of business, then those APIs may cease to exist. If their owners decide that they do not like or agree with certain users, they may restrict their access. In the end, they may decide to shut down or restrict access for arbitrary reasons.</p>
<p>Because the IC allows for group and autonomous ownership of cloud software, the IC is able to produce potentially permanent web APIs. A decentralized group of independent entities will find it difficult to censor API consumers or shut down an API. An autonomous API would take those difficulties to the extreme, as it would continue operating as long as consumers were willing to pay for it.</p>
<h5 id="credible-neutrality"><a class="header" href="#credible-neutrality">Credible neutrality</a></h5>
<p>Group and autonomous ownership makes it possible to build neutral cloud software on the IC. This type of software would allow independent parties to coordinate with reduced trust in each other or a single third-party coordinator.</p>
<p>This removes the risk of the third-party coordinator acting in its own self-interest against the interests of the coordinating participants. The coordinating participants would also find it difficult to implement changes that would benefit themselves to the detriment of other participants.</p>
<p>Examples could include mobile app stores, ecommerce marketplaces, and podcast directories.</p>
<h5 id="reduced-platform-risk"><a class="header" href="#reduced-platform-risk">Reduced platform risk</a></h5>
<p>Because the IC is not owned or controlled by any one entity or individual, the risk of being deplatformed is reduced. This is in opposition to most cloud platforms, where the cloud provider itself generally has the power to arbitrarily remove users from its platform. While deplatforming can still occur on the IC, the only endogenous means of forcefully taking down an application is through an NNS vote.</p>
<h4 id="security"><a class="header" href="#security">Security</a></h4>
<ul>
<li><a href="kybra.html#built-in-replication">Built-in replication</a></li>
<li><a href="kybra.html#built-in-authentication">Built-in authentication</a></li>
<li><a href="kybra.html#built-in-firewallport-management">Built-in firewall/port management</a></li>
<li><a href="kybra.html#built-in-sandboxing">Built-in sandboxing</a></li>
<li><a href="kybra.html#threshold-protocols">Threshold protocols</a></li>
<li><a href="kybra.html#verifiable-source-code">Verifiable source code</a></li>
<li><a href="kybra.html#blockchain-integration">Blockchain integration</a></li>
</ul>
<h5 id="built-in-replication"><a class="header" href="#built-in-replication">Built-in replication</a></h5>
<p>Replication has many benefits that stem from reducing various central points of failure.</p>
<p>The IC is at its core a <a href="https://en.wikipedia.org/wiki/Byzantine_fault">Byzantine Fault Tolerant</a> replicated compute environment. Applications are deployed to subnets which are composed of nodes running replicas. Each replica is an independent replicated state machine that executes an application's state transitions (usually initiated with HTTP requests) and persists the results.</p>
<p>This replication provides a high level of security out-of-the-box. It is also the foundation of a number of protocols that provide threshold cryptographic operations to IC applications.</p>
<h5 id="built-in-authentication"><a class="header" href="#built-in-authentication">Built-in authentication</a></h5>
<p>IC client tooling makes it easy to sign and send messages to the IC, and <a href="https://internetcomputer.org/docs/current/tokenomics/identity-auth/what-is-ic-identity">Internet Identity</a> provides a novel approach to self-custody of private keys. The IC automatically authenticates messages with the public key of the signer, and provides a compact representation of that public key, called a principal, to the application. The principal can be used for authorization purposes. This removes many authentication concerns from the developer.</p>
<h5 id="built-in-firewallport-management"><a class="header" href="#built-in-firewallport-management">Built-in firewall/port management</a></h5>
<p>The concept of ports and various other low-level network infrastructure on the IC is abstracted away from the developer. This can greatly reduce application complexity thus minimizing the chance of introducing vulnerabilities through incorrect configurations. Canisters expose endpoints through various methods, usually query or update methods. Because authentication is also built-in, much of the remaining vulnerability surface area is minimized to implementing correct authorization rules in the canister method endpoints.</p>
<h5 id="built-in-sandboxing"><a class="header" href="#built-in-sandboxing">Built-in sandboxing</a></h5>
<p>Canisters have at least two layers of sandboxing to protect colocated canisters from each other. All canisters are at their core Wasm modules and thus inherit the built-in Wasm sandbox. In case there is any bug in the underlying implementation of the Wasm execution environment (or a vulnerability in the imported host functionality), there is also an OS-level sandbox. Developers need not do anything to take advantage of these sandboxes.</p>
<h5 id="threshold-protocols"><a class="header" href="#threshold-protocols">Threshold protocols</a></h5>
<p>The IC provides a number of threshold protocols that allow groups of independent nodes to perform cryptographic operations. These protocols remove central points of failure while providing familiar and useful cryptographic operations to developers. Included are <a href="https://internetcomputer.org/docs/current/developer-docs/integrations/t-ecdsa">ECDSA</a>, <a href="https://internetcomputer.org/how-it-works/response-certification/">BLS</a>, <a href="https://internetcomputer.org/how-it-works/chain-key-technology/">VRF-like</a>, and in the future <a href="https://forum.dfinity.org/t/threshold-key-derivation-privacy-on-the-ic/16560">threshold key derivation</a>.</p>
<h5 id="verifiable-source-code"><a class="header" href="#verifiable-source-code">Verifiable source code</a></h5>
<p>IC applications (canisters) are compiled into Wasm and deployed to the IC as Wasm modules. The IC hashes each canister's Wasm binary and stores it for public retrieval. The Wasm binary hash can be retrieved and compared with the hash of an independently compiled Wasm binary derived from available source code. If the hashes match, then one can know with a high degree of certainty that the application is executing the Wasm binary that was compiled from that source code.</p>
<p>For the time being, Kybra source code is not verifiable for reasons explained in the <a href="./caveats.html#wasm-module-hash-now-less-useful">caveats section</a>.</p>
<h5 id="blockchain-integration"><a class="header" href="#blockchain-integration">Blockchain integration</a></h5>
<p>When compared with web APIs built for the same purpose, the IC provides a high degree of security when integrating with various other blockchains. It has a direct client integration with Bitcoin, allowing applications to query its state with BFT guarantees. A similar integration is coming for Ethereum.</p>
<p>In addition to these blockchain client integrations, a <a href="https://internetcomputer.org/docs/current/developer-docs/integrations/t-ecdsa/">threshold ECDSA protocol</a> (tECDSA) allows the IC to create keys and sign transactions on various <a href="http://ethanfast.com/top-crypto.html">ECDSA chains</a>. These chains include Bitcoin and Ethereum, and in the future the protocol may be extended to allow interaction with various <a href="http://ethanfast.com/top-crypto.html">EdDSA chains</a>. These direct integrations combined with tECDSA provide a much more secure way to provide blockchain functionality to end users than creating and storing their private keys on traditional cloud infrastructure.</p>
<h4 id="developer-experience"><a class="header" href="#developer-experience">Developer experience</a></h4>
<ul>
<li><a href="kybra.html#built-in-devops">Built-in devops</a></li>
<li><a href="kybra.html#orthogonal-persistence">Orthogonal persistence</a></li>
</ul>
<h5 id="built-in-devops"><a class="header" href="#built-in-devops">Built-in devops</a></h5>
<p>The IC provides many devops benefits automatically. Though currently limited in its scalability, the protocol attempts to remove the need for developers to concern themselves with concepts such as autoscaling, load balancing, uptime, sandboxing, and firewalls/port management.</p>
<p>Correctly constructed canisters have a simple deploy process and automatically inherit these devops capabilities up unto the current scaling limits of the IC. DFINITY engineers are constantly working to remove scalability bottlenecks.</p>
<h5 id="orthogonal-persistence"><a class="header" href="#orthogonal-persistence">Orthogonal persistence</a></h5>
<p>The IC automatically persists its heap. This creates an extremely convenient way for developers to store application state, by simply writing into global variables in their programming language of choice. This is a great way to get started.</p>
<p>If a canister upgrades its code, swapping out its Wasm binary, then the heap must be cleared. To overcome this limitation, there is a special area of memory called stable memory that persists across these canister upgrades. Special stable data structures provide a familiar API that allows writing into stable memory directly.</p>
<p>All of this together provides the foundation for a very simple persistence experience for the developer. The persistence tools now available and coming to the IC may be simpler than their equivalents on traditional cloud infrastructure.</p>
<h3 id="drawbacks"><a class="header" href="#drawbacks">Drawbacks</a></h3>
<p>It's important to note that both Kybra and the IC are early-stage projects. The IC officially launched in May of 2021, and Kybra reached beta in December of 2022.</p>
<h4 id="kybra"><a class="header" href="#kybra">Kybra</a></h4>
<p>Some of Kybra's main drawbacks can be summarized as follows:</p>
<ul>
<li><a href="kybra.html#beta">Beta</a></li>
<li><a href="kybra.html#security-risks">Security risks</a></li>
<li><a href="kybra.html#high-cycle-usage">High cycle usage</a></li>
<li><a href="kybra.html#missing-apis">Missing APIs</a></li>
</ul>
<h5 id="beta"><a class="header" href="#beta">Beta</a></h5>
<p>Kybra reached beta in December of 2022. It's an immature project that may have unforeseen bugs and other issues. We're working constantly to improve it. We hope to get to a production-ready 1.0 in 2024. The following are the major blockers to 1.0:</p>
<ul>
<li>CPython integration for performance, security, and stability</li>
<li>Broad PyPI package support (C API/extensions)</li>
<li>Extensive automated property testing</li>
<li>Multiple independent security reviews/audits</li>
</ul>
<h5 id="security-risks"><a class="header" href="#security-risks">Security risks</a></h5>
<p>As discussed earlier, these are some things to keep in mind:</p>
<ul>
<li>Kybra does not yet have many live, successful, continuously operating applications deployed to the IC</li>
<li>Kybra does not yet have extensive automated property tests</li>
<li>Kybra does not yet have multiple independent security reviews/audits</li>
<li>Kybra uses a new Python interpreter that is less mature than CPython</li>
</ul>
<h5 id="high-cycle-usage"><a class="header" href="#high-cycle-usage">High cycle usage</a></h5>
<p>We haven't done extensive benchmarking yet, but based on some preliminary evidence Kybra is likely much more performant than <a href="https://demergent-labs.github.io/azle/azle.html#high-cycle-usage">Azle</a>. We have done some preliminary benchmarking for Azle, and based on that our rough heuristic is that Azle will cost 2-4x more cycles than the equivalent project in Motoko or Rust. The performance of your application depends on many factors, and this should just be a rough estimate.</p>
<p>There is evidence to suggest that a 7-20x improvement in performance is possible in our <a href="https://github.com/RustPython/RustPython">underlying Python interpreter</a>. We also plan to migrate to CPython which would improve performance.</p>
<h5 id="missing-apis"><a class="header" href="#missing-apis">Missing APIs</a></h5>
<p>Kybra is limited to what the IC is capable of (i.e. no sockets, no threads, etc) and does not yet have C extension support. Our goal is to support as many libraries and APIs as possible over time.</p>
<h4 id="ic"><a class="header" href="#ic">IC</a></h4>
<p>Some of the IC's main drawbacks can be summarized as follows:</p>
<ul>
<li><a href="kybra.html#early">Early</a></li>
<li><a href="kybra.html#high-latencies">High latencies</a></li>
<li><a href="kybra.html#limited-and-expensive-compute-resources">Limited and expensive compute resources</a></li>
<li><a href="kybra.html#limited-scalability">Limited scalability</a></li>
<li><a href="kybra.html#lack-of-privacy">Lack of privacy</a></li>
<li><a href="kybra.html#nns-risk">NNS risk</a></li>
</ul>
<h5 id="early"><a class="header" href="#early">Early</a></h5>
<p>The IC launched officially in May of 2021. As a relatively new project with an extremely ambitious vision, you can expect a small community, immature tooling, and an unproven track record. Much has been delivered, but many promises are yet to be fulfilled.</p>
<h5 id="high-latencies"><a class="header" href="#high-latencies">High latencies</a></h5>
<p>Any requests that change state on the IC must go through consensus, thus you can expect latencies of a few seconds for these types of requests. When canisters need to communicate with each other across subnets or under heavy load, these latencies can be even longer. Under these circumstances, in the worst case latencies will build up linearly. For example, if canister A calls canister B calls canister C, and these canisters are all on different subnets or under heavy load, then you might need to multiply the latency by the total number of calls.</p>
<h5 id="limited-and-expensive-compute-resources"><a class="header" href="#limited-and-expensive-compute-resources">Limited and expensive compute resources</a></h5>
<p>CPU usage, data storage, and network usage may be more expensive than the equivalent usage on traditional cloud platforms. Combining these costs with the high latencies explained above, it becomes readily apparent that the IC is currently not built for high-performance computing.</p>
<h5 id="limited-scalability"><a class="header" href="#limited-scalability">Limited scalability</a></h5>
<p>The IC might not be able to scale to the needs of your application. It is constantly seeking to improve scalability bottlenecks, but it will probably not be able to onboard millions of users to your traditional web application.</p>
<h5 id="lack-of-privacy"><a class="header" href="#lack-of-privacy">Lack of privacy</a></h5>
<p>You should assume that all of your application data (unless it is end-to-end encrypted) is accessible to multiple third-parties with no direct relationship and limited commitment to you. Currently all canister state sits unencrypted on node operator's machines. Application-layer access controls for data are possible, but motivated node operators will have an easy time getting access to your data.</p>
<h5 id="nns-risk"><a class="header" href="#nns-risk">NNS risk</a></h5>
<p>The NNS has the ability to uninstall any canister and can generally change anything about the IC. As of the time of this writing, DFINITY effectively controls much of the NNS through its follower relationships. The NNS must mature and decentralize to provide practical and realistic guarantees to canisters and their users.</p>
<div style="break-before: page; page-break-before: always;"></div><h1 id="installation"><a class="header" href="#installation">Installation</a></h1>
<ul>
<li><a href="installation.html#dependencies">Dependencies</a></li>
<li><a href="installation.html#common-installation-issues">Common installation issues</a></li>
</ul>
<h2 id="dependencies"><a class="header" href="#dependencies">Dependencies</a></h2>
<p>Follow the instructions exactly as stated below to avoid issues.</p>
<p>You should be using a *nix environment (Linux, Mac OS, <a href="https://learn.microsoft.com/en-us/windows/wsl/install">WSL if using Windows</a>) with bash and have the following installed on your system:</p>
<ul>
<li>Python 3.10.7</li>
<li>dfx 0.19.0</li>
<li>Python VS Code Extension</li>
</ul>
<h3 id="python-3107"><a class="header" href="#python-3107">Python 3.10.7</a></h3>
<p>It is highly recommended to install Python 3.10.7 using <a href="https://github.com/pyenv/pyenv">pyenv</a>. To do so, use the <a href="https://github.com/pyenv/pyenv-installer">pyenv installer</a> as shown below:</p>
<pre><code class="language-bash"># install pyenv
curl https://pyenv.run | bash

# install Python 3.10.7
~/.pyenv/bin/pyenv install 3.10.7
</code></pre>
<h3 id="dfx"><a class="header" href="#dfx">dfx</a></h3>
<p>Run the following command to install dfx 0.19.0:</p>
<pre><code class="language-bash">DFX_VERSION=0.19.0 sh -ci &quot;$(curl -fsSL https://sdk.dfinity.org/install.sh)&quot;
</code></pre>
<p>If after trying to run <code>dfx</code> commands you encounter an error such as <code>dfx: command not found</code>, you might need to add <code>$HOME/bin</code> to your path. Here's an example of doing this in your <code>.bashrc</code>:</p>
<pre><code class="language-bash">echo 'export PATH=&quot;$PATH:$HOME/bin&quot;' &gt;&gt; &quot;$HOME/.bashrc&quot;
</code></pre>
<h3 id="python-vs-code-extension"><a class="header" href="#python-vs-code-extension">Python VS Code Extension</a></h3>
<p>It is highly recommended to use VS Code and to install the <a href="https://marketplace.visualstudio.com/items?itemName=ms-python.python">Microsoft Python extension</a> to get full type checking support from within the editor:</p>
<h4 id="extension"><a class="header" href="#extension">Extension</a></h4>
<pre><code>VS Code -&gt; Preferences -&gt; Extensions -&gt; Search for Python by Microsoft and install it
</code></pre>
<h4 id="set-pythonanalysistypecheckingmode"><a class="header" href="#set-pythonanalysistypecheckingmode">Set python.analysis.typeCheckingMode</a></h4>
<p>Set the setting <code>python.analysis.typeCheckingMode</code> to <code>strict</code>:</p>
<pre><code>VS Code -&gt; Preferences -&gt; Settings -&gt; Search for python.analysis.typeCheckingMode and set it to strict
</code></pre>
<h2 id="common-installation-issues"><a class="header" href="#common-installation-issues">Common installation issues</a></h2>
<h3 id="ubuntu"><a class="header" href="#ubuntu">Ubuntu</a></h3>
<p>Error:</p>
<pre><code class="language-bash">linker cc not found
</code></pre>
<p>Resolution:</p>
<pre><code class="language-bash">sudo apt install build-essential
</code></pre>
<p>Error:</p>
<pre><code class="language-bash">is cmake not installed?
</code></pre>
<p>Resolution:</p>
<pre><code class="language-bash">sudo apt install cmake
</code></pre>
<p>Error:</p>
<pre><code class="language-bash">ERROR: The Python ssl extension was not compiled. Missing the OpenSSL lib
</code></pre>
<p>Resolution:</p>
<p>You may have the right version of open ssl but you might be missing libssl-dev</p>
<pre><code class="language-bash">sudo apt-get install libssl-dev
</code></pre>
<div style="break-before: page; page-break-before: always;"></div><h1 id="hello-world"><a class="header" href="#hello-world">Hello World</a></h1>
<ul>
<li><a href="hello_world.html#the-project-directory-and-file-structure">The project directory and file structure</a></li>
<li><a href="hello_world.html#mainpy">main.py</a></li>
<li><a href="hello_world.html#dfxjson">dfx.json</a></li>
<li><a href="hello_world.html#local-deployment">Local deployment</a></li>
<li><a href="hello_world.html#interacting-with-your-canister-from-the-command-line">Interacting with your canister from the command line</a></li>
<li><a href="hello_world.html#interacting-with-your-canister-from-the-web-ui">Interacting with your canister from the web UI</a></li>
</ul>
<p>Let's build your first application (canister) with Kybra!</p>
<p>Before embarking please ensure you've followed all of <a href="./installation.html">the installation instructions</a>.</p>
<p>We'll build a simple <code>Hello World</code> canister that shows the basics of importing Kybra, exposing a query method, exposing an update method, and storing some state in a global variable. We'll then interact with it from the command line and from our web browser.</p>
<h2 id="the-project-directory-and-file-structure"><a class="header" href="#the-project-directory-and-file-structure">The project directory and file structure</a></h2>
<p>Assuming you're starting completely from scratch, run these commands to setup your project's directory and file structure:</p>
<pre><code class="language-bash">mkdir kybra_hello_world
cd kybra_hello_world

mkdir src

touch src/main.py
touch dfx.json
</code></pre>
<p>Now create and source a virtual environment:</p>
<pre><code class="language-bash">~/.pyenv/versions/3.10.7/bin/python -m venv venv
source venv/bin/activate
</code></pre>
<p>Now install Kybra:</p>
<pre><code class="language-bash">pip install kybra
</code></pre>
<p>Open up <code>kybra_hello_world</code> in your text editor (we recommend <a href="https://code.visualstudio.com/">VS Code</a> with the <a href="https://marketplace.visualstudio.com/items?itemName=ms-python.python">Microsoft Python extension</a>).</p>
<h2 id="mainpy"><a class="header" href="#mainpy">main.py</a></h2>
<p>Here's the main code of the project, which you should put in the <code>kybra_hello_world/src/main.py</code> file of your canister:</p>
<pre><code class="language-python">from kybra import query, update, void

# This is a global variable that is stored on the heap
message: str = ''

# Query calls complete quickly because they do not go through consensus
@query
def get_message() -&gt; str:
    return message

# Update calls take a few seconds to complete
# This is because they persist state changes and go through consensus
@update
def set_message(new_message: str) -&gt; void:
    global message
    message = new_message # This change will be persisted
</code></pre>
<p>Let's discuss each section of the code.</p>
<pre><code class="language-python">from kybra import query, update, void
</code></pre>
<p>The code starts off by importing the <code>query</code> and <code>update</code> decorators from <code>kybra</code>, along with the <code>void</code> type. The <code>kybra</code> module provides most of the Internet Computer (IC) APIs for your canister.</p>
<pre><code class="language-python"># This is a global variable that is stored on the heap
message: str = ''
</code></pre>
<p>We have created a global variable to store the state of our application. This variable is in scope to all of the functions defined in this module. We have annotated it with a type and set it equal to an empty string.</p>
<pre><code class="language-python"># Query calls complete quickly because they do not go through consensus
@query
def get_message() -&gt; str:
    return message
</code></pre>
<p>We are exposing a canister query method here. When query methods are called they execute quickly because they do not have to go through consensus. This method simply returns our global <code>message</code> variable.</p>
<pre><code class="language-python"># Update calls take a few seconds to complete
# This is because they persist state changes and go through consensus
@update
def set_message(new_message: str) -&gt; void:
    global message
    message = new_message # This change will be persisted
</code></pre>
<p>We are exposing an update method here. When update methods are called they take a few seconds to complete. This is because they persist changes and go through consensus. A majority of nodes in a subnet must agree on all state changes introduced in calls to update methods. This method accepts a <code>string</code> from the caller and will store it in our global <code>message</code> variable.</p>
<p>That's it! We've created a very simple getter/setter <code>Hello World</code> application. But no <code>Hello World</code> project is complete without actually yelling <code>Hello world</code>!</p>
<p>To do that, we'll need to setup the rest of our project.</p>
<h2 id="dfxjson"><a class="header" href="#dfxjson">dfx.json</a></h2>
<p>Create the following in <code>kybra_hello_world/dfx.json</code>:</p>
<pre><code class="language-json">{
    &quot;canisters&quot;: {
        &quot;kybra_hello_world&quot;: {
            &quot;type&quot;: &quot;custom&quot;,
            &quot;build&quot;: &quot;python -m kybra kybra_hello_world src/main.py src/main.did&quot;,
            &quot;candid&quot;: &quot;src/main.did&quot;,
            &quot;wasm&quot;: &quot;.kybra/kybra_hello_world/kybra_hello_world.wasm&quot;,
            &quot;gzip&quot;: true,
            &quot;metadata&quot;: [
                {
                    &quot;name&quot;: &quot;candid:service&quot;,
                    &quot;path&quot;: &quot;src/main.did&quot;
                },
                {
                    &quot;name&quot;: &quot;cdk:name&quot;,
                    &quot;content&quot;: &quot;kybra&quot;
                }
            ]
        }
    }
}
</code></pre>
<h2 id="local-deployment"><a class="header" href="#local-deployment">Local deployment</a></h2>
<p>Let's deploy to our local replica.</p>
<p>First startup the replica:</p>
<pre><code class="language-bash">dfx start --background
</code></pre>
<p>If you want an extra speedy deploy:</p>
<pre><code class="language-bash">dfx start --background --artificial-delay 0
</code></pre>
<p>Then deploy the canister:</p>
<pre><code class="language-bash">dfx deploy
</code></pre>
<p>If you have problems deploying see <a href="./deployment.html#common-deployment-issues">Common deployment issues</a>.</p>
<h2 id="interacting-with-your-canister-from-the-command-line"><a class="header" href="#interacting-with-your-canister-from-the-command-line">Interacting with your canister from the command line</a></h2>
<p>Once we've deployed we can ask for our message:</p>
<pre><code class="language-bash">dfx canister call kybra_hello_world get_message
</code></pre>
<p>We should see <code>(&quot;&quot;)</code> representing an empty message.</p>
<p>Now let's yell <code>Hello World!</code>:</p>
<pre><code class="language-bash">dfx canister call kybra_hello_world set_message '(&quot;Hello World!&quot;)'
</code></pre>
<p>Retrieve the message:</p>
<pre><code class="language-bash">dfx canister call kybra_hello_world get_message
</code></pre>
<p>We should see <code>(&quot;Hello World!&quot;)</code>.</p>
<h2 id="interacting-with-your-canister-from-the-web-ui"><a class="header" href="#interacting-with-your-canister-from-the-web-ui">Interacting with your canister from the web UI</a></h2>
<p>After deploying your canister, you should see output similar to the following in your terminal:</p>
<pre><code class="language-bash">Deployed canisters.
URLs:
  Backend canister via Candid interface:
    kybra_hello_world: http://127.0.0.1:8000/?canisterId=ryjl3-tyaaa-aaaaa-aaaba-cai&amp;id=rrkah-fqaaa-aaaaa-aaaaq-cai
</code></pre>
<p>Open up <a href="http://127.0.0.1:8000/?canisterId=ryjl3-tyaaa-aaaaa-aaaba-cai&amp;id=rrkah-fqaaa-aaaaa-aaaaq-cai">http://127.0.0.1:8000/?canisterId=ryjl3-tyaaa-aaaaa-aaaba-cai&amp;id=rrkah-fqaaa-aaaaa-aaaaq-cai</a> or the equivalent URL from your terminal to access the web UI and interact with your canister.</p>
<div style="break-before: page; page-break-before: always;"></div><h1 id="deployment"><a class="header" href="#deployment">Deployment</a></h1>
<ul>
<li><a href="deployment.html#starting-the-local-replica">Starting the local replica</a></li>
<li><a href="deployment.html#deploying-to-the-local-replica">Deploying to the local replica</a></li>
<li><a href="deployment.html#interacting-with-your-canister">Interacting with your canister</a></li>
<li><a href="deployment.html#deploying-to-mainnet">Deploying to mainnet</a></li>
<li><a href="deployment.html#common-deployment-issues">Common deployment issues</a></li>
</ul>
<p>There are two main Internet Computer (IC) environments that you will generally interact with: the local replica and mainnet.</p>
<p>When developing on your local machine, our recommended flow is to start up a local replica in your project's root directoy and then deploy to it for local testing.</p>
<h2 id="starting-the-local-replica"><a class="header" href="#starting-the-local-replica">Starting the local replica</a></h2>
<p>Open a terminal and navigate to your project's root directory:</p>
<pre><code class="language-bash">dfx start
</code></pre>
<p>Alternatively you can start the local replica as a background process:</p>
<pre><code class="language-bash">dfx start --background
</code></pre>
<p>If you want extra speedy deploys:</p>
<pre><code class="language-bash">dfx start --artificial-delay 0
</code></pre>
<p>or</p>
<pre><code class="language-bash">dfx start --background --artificial-delay 0
</code></pre>
<p>If you want to stop a local replica running in the background:</p>
<pre><code class="language-bash">dfx stop
</code></pre>
<p>If you ever see this error after <code>dfx stop</code>:</p>
<pre><code class="language-bash">Error: Failed to kill all processes.  Remaining: 627221 626923 627260
</code></pre>
<p>Then try this:</p>
<pre><code class="language-bash">sudo kill -9 627221
sudo kill -9 626923
sudo kill -9 627260
</code></pre>
<p>If your replica starts behaving strangely, we recommend starting the replica clean, which will clean the <code>dfx</code> state of your project:</p>
<pre><code class="language-bash">dfx start --clean
</code></pre>
<h2 id="deploying-to-the-local-replica"><a class="header" href="#deploying-to-the-local-replica">Deploying to the local replica</a></h2>
<p>To deploy all canisters defined in your <code>dfx.json</code>:</p>
<pre><code class="language-bash">dfx deploy
</code></pre>
<p>To deploy an individual canister:</p>
<pre><code class="language-bash">dfx deploy canister_name
</code></pre>
<p>If you have problems deploying see <a href="./deployment.html#common-deployment-issues">Common deployment issues</a>.</p>
<h2 id="interacting-with-your-canister"><a class="header" href="#interacting-with-your-canister">Interacting with your canister</a></h2>
<p>As a developer you can generally interact with your canister in three ways:</p>
<ul>
<li><a href="deployment.html#dfx-command-line">dfx command line</a></li>
<li><a href="deployment.html#dfx-web-ui">dfx web UI</a></li>
<li><a href="deployment.html#dfinityagent">@dfinity/agent</a></li>
</ul>
<h3 id="dfx-command-line"><a class="header" href="#dfx-command-line">dfx command line</a></h3>
<p>You can see a more complete reference <a href="https://internetcomputer.org/docs/current/references/cli-reference/">here</a>.</p>
<p>The commands you are likely to use most frequently are:</p>
<pre><code class="language-bash"># assume a canister named my_canister

# builds and deploys all canisters specified in dfx.json
dfx deploy

# builds all canisters specified in dfx.json
dfx build

# builds and deploys my_canister
dfx deploy my_canister

# builds my_canister
dfx build my_canister

# removes the Wasm binary and state of my_canister
dfx uninstall-code my_canister

# calls the method_name method on my_canister with a string argument
dfx canister call my_canister method_name '(&quot;This is a Candid string argument&quot;)'
</code></pre>
<h3 id="dfx-web-ui"><a class="header" href="#dfx-web-ui">dfx web UI</a></h3>
<p>After deploying your canister, you should see output similar to the following in your terminal:</p>
<pre><code class="language-bash">Deployed canisters.
URLs:
  Backend canister via Candid interface:
    my_canister: http://127.0.0.1:8000/?canisterId=ryjl3-tyaaa-aaaaa-aaaba-cai&amp;id=rrkah-fqaaa-aaaaa-aaaaq-cai
</code></pre>
<p>Open up <a href="http://127.0.0.1:8000/?canisterId=ryjl3-tyaaa-aaaaa-aaaba-cai&amp;id=rrkah-fqaaa-aaaaa-aaaaq-cai">http://127.0.0.1:8000/?canisterId=ryjl3-tyaaa-aaaaa-aaaba-cai&amp;id=rrkah-fqaaa-aaaaa-aaaaq-cai</a> to access the web UI.</p>
<h3 id="dfinityagent"><a class="header" href="#dfinityagent">@dfinity/agent</a></h3>
<p><a href="https://www.npmjs.com/package/@dfinity/agent">@dfinity/agent</a> is the TypeScript/JavaScript client library for interacting with canisters on the IC. If you are building a client web application, this is probably what you'll want to use.</p>
<p>There are other agents for other languages as well:</p>
<ul>
<li><a href="https://github.com/ic4j/ic4j-agent">Java</a></li>
<li><a href="https://github.com/rocklabs-io/ic-py">Python</a></li>
<li><a href="https://crates.io/crates/ic-agent">Rust</a></li>
</ul>
<h2 id="deploying-to-mainnet"><a class="header" href="#deploying-to-mainnet">Deploying to mainnet</a></h2>
<p>Assuming you are <a href="https://internetcomputer.org/docs/current/developer-docs/setup/cycles/">setup with cycles</a>, then you are ready to deploy to mainnet.</p>
<p>To deploy all canisters defined in your dfx.json:</p>
<pre><code class="language-bash">dfx deploy --network ic
</code></pre>
<p>To deploy an individual canister:</p>
<pre><code class="language-bash">dfx deploy --network ic canister_name
</code></pre>
<p>If you have problems deploying see <a href="./deployment.html#common-deployment-issues">Common deployment issues</a>.</p>
<h2 id="common-deployment-issues"><a class="header" href="#common-deployment-issues">Common deployment issues</a></h2>
<p>If you run into an error during deployment, try the following:</p>
<ol>
<li>Ensure that you have followed the instructions correctly in <a href="./installation.html">the installation chapter</a>, especially noting <a href="./installation.html#common-installation-issues">the common installation issues</a></li>
<li>Look for more error output by adding the <code>--verbose</code> flag to the <code>build</code> command in your <code>dfx.json</code> file like so: <code>&quot;build&quot;: &quot;python -m kybra canister_name src/main.py src/main.did --verbose</code></li>
<li>Look for errors in each of the files in <code>~/.config/kybra/[kybra_version]/logs</code></li>
<li>If the problem is still not resolved, reach out with any error outputs in <a href="https://discord.gg/ux2Jc7psjd">the Discord channel</a></li>
</ol>
<div style="break-before: page; page-break-before: always;"></div><h1 id="examples"><a class="header" href="#examples">Examples</a></h1>
<p>Kybra has many example projects showing nearly all Kybra APIs. They can be found in the <a href="https://github.com/demergent-labs/kybra/tree/main/examples">examples directory</a> of the <a href="https://github.com/demergent-labs/kybra">Kybra GitHub repository</a>.</p>
<p>We'll highlight a few of them here:</p>
<ul>
<li><a href="https://github.com/demergent-labs/kybra/tree/main/examples/query">Query</a></li>
<li><a href="https://github.com/demergent-labs/kybra/tree/main/examples/update">Update</a></li>
<li><a href="https://github.com/demergent-labs/kybra/tree/main/examples/primitive_types">Primitive Types</a></li>
<li><a href="https://github.com/demergent-labs/kybra/tree/main/examples/stable_structures">Stable Structures</a></li>
<li><a href="https://github.com/demergent-labs/kybra/tree/main/examples/cycles">Cycles</a></li>
<li><a href="https://github.com/demergent-labs/kybra/tree/main/examples/cross_canister_calls">Cross Canister Calls</a></li>
<li><a href="https://github.com/demergent-labs/kybra/tree/main/examples/management_canister">Management Canister</a></li>
<li><a href="https://github.com/demergent-labs/kybra/tree/main/examples/outgoing_http_requests">Outgoing HTTP Requests</a></li>
<li><a href="https://github.com/demergent-labs/kybra/tree/main/examples/motoko_examples/http_counter">Incoming HTTP Requests</a></li>
<li><a href="https://github.com/demergent-labs/kybra/tree/main/examples/pre_and_post_upgrade">Pre and Post Upgrade</a></li>
<li><a href="https://github.com/demergent-labs/kybra/tree/main/examples/timers">Timers</a></li>
</ul>
<div style="break-before: page; page-break-before: always;"></div><h1 id="internet-computer-overview"><a class="header" href="#internet-computer-overview">Internet Computer Overview</a></h1>
<p>The <a href="https://internetcomputer.org/">Internet Computer</a> (IC) is a decentralized cloud platform. Actually, it is better thought of as a progressively decentralizing cloud platform. Its full vision is yet to be fulfilled.</p>
<p>It aims to be owned and operated by many independent entities in many geographies and legal jurisdictions throughout the world. This is in opposition to most traditional cloud platforms today, which are generally owned and operated by one overarching legal entity.</p>
<p>The IC is composed of computer hardware nodes running the IC protocol software. Each running IC protocol software process is known as a replica.</p>
<p>Nodes are assigned into groups known as subnets. Each subnet attempts to maximize its decentralization of nodes according to factors such as data center location and node operator independence.</p>
<p>The subnets vary in size. Generally speaking the larger the size of the subnet the more secure it will be. Subnets currently range in size from 13 to 40 nodes, with most subnets having 13 nodes.</p>
<p>IC applications, known as canisters, are deployed to specific subnets. They are then accessible through Internet Protocol requests such as HTTP. Each subnet replicates all canisters across all of its replicas. A consensus protocol is run by the replicas to ensure <a href="https://en.wikipedia.org/wiki/Byzantine_fault">Byzantine Fault Tolerance</a>.</p>
<p>View the <a href="https://dashboard.internetcomputer.org/subnets">IC Dashboard</a> to explore all data centers, subnets, node operators, and many other aspects of the IC.</p>
<div style="break-before: page; page-break-before: always;"></div><h1 id="canisters-overview"><a class="header" href="#canisters-overview">Canisters Overview</a></h1>
<p>Canisters are <a href="https://internetcomputer.org/">Internet Computer</a> (IC) applications. They are the encapsulation of your code and state, and are essentially Wasm modules.</p>
<p>State can be stored on the 4 GiB heap or in a larger 96 GiB location called stable memory. You can store state on the heap using your language's native global variables. You can store state in stable memory using low-level APIs or special stable data structures that behave similarly to native language data structures.</p>
<p>State changes must go through a process called consensus. The consensus process ensures that state changes are <a href="https://en.wikipedia.org/wiki/Byzantine_fault">Byzantine Fault Tolerant</a>. This process takes a few seconds to complete.</p>
<p>Operations on canister state are exposed to users through canister methods. These methods can be invoked through HTTP requests. Query methods allow state to be read and are low-latency. Update methods allow state to be changed and are higher-latency. Update methods take a few seconds to complete because of the consensus process.</p>
<div style="break-before: page; page-break-before: always;"></div><h1 id="query-methods"><a class="header" href="#query-methods">Query Methods</a></h1>
<h2 id="tldr"><a class="header" href="#tldr">TLDR</a></h2>
<ul>
<li>Decorate functions with <code>@query</code></li>
<li>Read-only</li>
<li>Executed on a single node</li>
<li>No consensus</li>
<li>Latency on the order of ~100 milliseconds</li>
<li>5 billion Wasm instruction limit</li>
<li>4 GiB heap limit</li>
<li>~32k queries per second per canister</li>
</ul>
<p>The most basic way to expose your canister's functionality publicly is through a query method. Here's an example of a simple query method:</p>
<pre><code class="language-python">from kybra import query


@query
def get_string() -&gt; str:
    return &quot;This is a query method!&quot;
</code></pre>
<p><code>get_string</code> can be called from the outside world through the IC's HTTP API. You'll usually invoke this API from the <a href="./deployment.html#interacting-with-your-canister"><code>dfx command line</code>, <code>dfx web UI</code>, or an agent</a>.</p>
<p>From the <code>dfx command line</code> you can call it like this:</p>
<pre><code class="language-bash">dfx canister call my_canister get_string
</code></pre>
<p>Query methods are read-only. They do not persist any state changes. Take a look at the following example:</p>
<pre><code class="language-python">from kybra import query, void

db = {}


@query
def set(key: str, value: str) -&gt; void:
    db[key] = value
</code></pre>
<p>Calling <code>set</code> will perform the operation of setting the <code>key</code> item on the <code>db</code> dictionary to <code>value</code>, but after the call finishes that change will be discarded.</p>
<p>This is because query methods are executed on a single node machine and do not go through <a href="https://internetcomputer.org/how-it-works/consensus/">consensus</a>. This results in lower latencies, perhaps on the order of 100 milliseconds.</p>
<p>There is a limit to how much computation can be done in a single call to a query method. The current query call limit is <a href="https://internetcomputer.org/docs/current/developer-docs/production/instruction-limits">5 billion Wasm instructions</a>. Here's an example of a query method that runs the risk of reaching the limit:</p>
<pre><code class="language-python">from kybra import nat32, query


@query
def pyramid(levels: nat32) -&gt; str:
    levels_array = [0 for _ in range(levels)]
    asterisk_array = [
        [&quot;*&quot; for _ in range(i + 1)] + [&quot;\n&quot;] for i in range(len(levels_array))
    ]
    flattened_array = [element for subarray in asterisk_array for element in subarray]

    return &quot;&quot;.join(flattened_array)

</code></pre>
<p>From the <code>dfx command line</code> you can call <code>pyramid</code> like this:</p>
<pre><code class="language-bash">dfx canister call my_canister pyramid '(600)'
</code></pre>
<p>With an argument of <code>600</code>, <code>pyramid</code> will fail with an error <code>...exceeded the instruction limit for single message execution</code>.</p>
<p>Keep in mind that each query method invocation has up to 4 GiB of heap available.</p>
<p>In terms of query scalability, an individual canister <a href="https://forum.dfinity.org/t/what-is-the-theroretical-number-for-txns-per-second-on-internet-computer-right-now/14039/6">likely has an upper bound of ~36k queries per second</a>.</p>
<div style="break-before: page; page-break-before: always;"></div><h1 id="update-methods"><a class="header" href="#update-methods">Update Methods</a></h1>
<h2 id="tldr-1"><a class="header" href="#tldr-1">TLDR</a></h2>
<ul>
<li>Annotate functions with <code>@update</code></li>
<li>Read-write</li>
<li>Executed on many nodes</li>
<li>Consensus</li>
<li>Latency ~2-5 seconds</li>
<li>20 billion Wasm instruction limit</li>
<li>4 GiB heap limit</li>
<li>96 GiB stable memory limit</li>
<li>~900 updates per second per canister</li>
</ul>
<p>Update methods are similar to query methods, but state changes can be persisted. Here's an example of a simple update method:</p>
<pre><code class="language-python">from kybra import nat64, update

counter = 0


@update
def increment() -&gt; nat64:
    global counter
    counter += 1
    return counter
</code></pre>
<p>Calling <code>increment</code> will increase the value of <code>counter</code> by 1 and then return its current value. Because <code>counter</code> is a global variable, the change will be persisted to the heap, and subsequent query and update calls will have access to the new <code>counter</code> value.</p>
<p>Because the Internet Computer (IC) persists changes with certain fault tolerance guarantees, update calls are executed on many nodes and go through <a href="https://internetcomputer.org/how-it-works/consensus/">consensus</a>. This leads to latencies of ~2-5 seconds per update call.</p>
<p>Due to the latency and other expenses involved with update methods, it is best to use them only when necessary. Look at the following example:</p>
<pre><code class="language-python">from kybra import query, update, void

message = &quot;&quot;


@query
def get_message() -&gt; str:
    return message


@update
def set_message(new_message: str) -&gt; void:
    global message
    message = new_message
</code></pre>
<p>You'll notice that we use an update method, <code>set_message</code>, only to perform the change to the global <code>message</code> variable. We use <code>get_message</code>, a query method, to read the message.</p>
<p>Keep in mind that the heap is limited to 4 GiB, and thus there is an upper bound to global variable storage capacity. You can imagine how a simple database like the following would eventually run out of memory with too many entries:</p>
<pre><code class="language-python">from kybra import Opt, query, update, void

db: dict[str, str] = {}


@query
def get(key: str) -&gt; Opt[str]:
    return db.get(key)


@update
def set(key: str, value: str) -&gt; void:
    db[key] = value

</code></pre>
<p>If you need more than 4 GiB of storage, consider taking advantage of the 96 GiB of stable memory. Stable structures like <code>StableBTreeMap</code> give you a nice API for interacting with stable memory. These data structures will be <a href="./stable_structures.html">covered in more detail later</a>. Here's a simple example:</p>
<pre><code class="language-python">from kybra import Opt, query, StableBTreeMap, update, void

db = StableBTreeMap[str, str](memory_id=3, max_key_size=10, max_value_size=10)


@query
def get(key: str) -&gt; Opt[str]:
    return db.get(key)


@update
def set(key: str, value: str) -&gt; void:
    db.insert(key, value)
</code></pre>
<p>So far we have only seen how state changes can be persisted. State changes can also be discarded by implicit or explicit traps. A trap is an immediate stop to execution with the ability to provide a message to the execution environment.</p>
<p>Traps can be useful for ensuring that multiple operations are either all completed or all disregarded, or in other words atomic. Keep in mind that these guarantees do not hold once cross-canister calls are introduced, but that's a more advanced topic <a href="./cross_canister.html">covered later</a>.</p>
<p>Here's an example of how to trap and ensure atomic changes to your database:</p>
<pre><code class="language-python">from kybra import ic, Opt, query, Record, StableBTreeMap, update, Vec, void


class Entry(Record):
    key: str
    value: str


db = StableBTreeMap[str, str](memory_id=3, max_key_size=10, max_value_size=10)


@query
def get(key: str) -&gt; Opt[str]:
    return db.get(key)


@update
def set(key: str, value: str) -&gt; void:
    db.insert(key, value)


@update
def set_many(entries: Vec[Entry]) -&gt; void:
    for entry in entries:
        if entry[&quot;key&quot;] == &quot;trap&quot;:
            ic.trap(&quot;explicit trap&quot;)

        db.insert(entry[&quot;key&quot;], entry[&quot;value&quot;])
</code></pre>
<p>In addition to <code>ic.trap</code>, an explicit Python <code>raise</code> or any unhandled exception will also trap.</p>
<p>There is a limit to how much computation can be done in a single call to an update method. The current update call limit is <a href="https://internetcomputer.org/docs/current/developer-docs/production/instruction-limits">20 billion Wasm instructions</a>. If we modify our database example, we can introduce an update method that runs the risk of reaching the limit:</p>
<pre><code class="language-python">from kybra import nat64, Opt, query, Record, StableBTreeMap, update, void


class Entry(Record):
    key: str
    value: str


db = StableBTreeMap[str, str](memory_id=3, max_key_size=1_000, max_value_size=1_000)


@query
def get(key: str) -&gt; Opt[str]:
    return db.get(key)


@update
def set(key: str, value: str) -&gt; void:
    db.insert(key, value)


@update
def set_many(num_entries: nat64) -&gt; void:
    for i in range(num_entries):
        db.insert(str(i), str(i))
</code></pre>
<p>From the <code>dfx command line</code> you can call <code>set_many</code> like this:</p>
<pre><code class="language-bash">dfx canister call my_canister set_many '(100_000)'
</code></pre>
<p>With an argument of <code>100_000</code>, <code>set_many</code> will fail with an error <code>...exceeded the instruction limit for single message execution</code>.</p>
<p>In terms of update scalability, an individual canister <a href="https://forum.dfinity.org/t/what-is-the-theroretical-number-for-txns-per-second-on-internet-computer-right-now/14039/6">likely has an upper bound of ~900 updates per second</a>.</p>
<div style="break-before: page; page-break-before: always;"></div><h1 id="candid"><a class="header" href="#candid">Candid</a></h1>
<ul>
<li><a href="candid.html#text">text</a></li>
<li><a href="candid.html#blob">blob</a></li>
<li><a href="candid.html#nat">nat</a></li>
<li><a href="candid.html#nat64">nat64</a></li>
<li><a href="candid.html#nat32">nat32</a></li>
<li><a href="candid.html#nat16">nat16</a></li>
<li><a href="candid.html#nat8">nat8</a></li>
<li><a href="candid.html#int">int</a></li>
<li><a href="candid.html#int64">int64</a></li>
<li><a href="candid.html#int32">int32</a></li>
<li><a href="candid.html#int16">int16</a></li>
<li><a href="candid.html#int8">int8</a></li>
<li><a href="candid.html#float64">float64</a></li>
<li><a href="candid.html#float32">float32</a></li>
<li><a href="candid.html#bool">bool</a></li>
<li><a href="candid.html#null">null</a></li>
<li><a href="candid.html#vec">vec</a></li>
<li><a href="candid.html#opt">opt</a></li>
<li><a href="candid.html#record">record</a></li>
<li><a href="candid.html#variant">variant</a></li>
<li><a href="candid.html#func">func</a></li>
<li><a href="candid.html#service">service</a></li>
<li><a href="candid.html#principal">principal</a></li>
<li><a href="candid.html#reserved">reserved</a></li>
<li><a href="candid.html#empty">empty</a></li>
</ul>
<p><a href="https://internetcomputer.org/docs/current/developer-docs/backend/candid/">Candid</a> is an interface description language created by <a href="https://dfinity.org/">DFINITY</a>. It can be used to define interfaces between services (canisters), allowing canisters and clients written in various languages to easily interact with each other.</p>
<p>Kybra allows you to express Candid types through a combination of native and Kybra-provided Python types. These types will be necessary in various places as you define your canister. For example, Candid types must be used when defining the parameters and return types of your query and update methods.</p>
<p>It's important to note that the Candid types are represented at runtime using specific Python data structures that may differ in behavior from the description of the actual Candid type. For example, a <code>float32</code> Candid type is a <a href="https://docs.python.org/3/library/functions.html#float">Python float</a>, a <code>nat64</code> is a <a href="https://docs.python.org/3/library/functions.html#int">Python int</a>, and an <code>int</code> is also a <a href="https://docs.python.org/3/library/functions.html#int">Python int</a>.</p>
<p>Keep this in mind as it may result in unexpected behavior. Each Candid type and its equivalent Python runtime value is explained in more detail in this chapter.</p>
<p>A reference of all Candid types available on the Internet Computer (IC) can be found <a href="https://internetcomputer.org/docs/current/references/candid-ref">here</a>.</p>
<p>The following is a simple example showing how to import and use most of the Candid types available in Kybra:</p>
<pre><code class="language-python">from kybra import (
    blob,
    float64,
    float32,
    Func,
    int8,
    int16,
    int32,
    int64,
    nat,
    nat8,
    nat16,
    nat32,
    nat64,
    null,
    Opt,
    Principal,
    query,
    Query,
    Record,
    Service,
    service_query,
    service_update,
    Variant,
    Vec,
)


class Candid(Record):
    text: str
    blob: blob
    nat: nat
    nat64: nat64
    nat32: nat32
    nat16: nat16
    nat8: nat8
    int: int
    int64: int64
    int32: int32
    int16: int16
    int8: int8
    float64: float64
    float32: float32
    bool: bool
    null: null
    vec: Vec[str]
    opt: Opt[&quot;nat&quot;]
    record: &quot;CandidRecord&quot;
    variant: &quot;CandidVariant&quot;
    func: &quot;CandidFunc&quot;
    service: &quot;MyService&quot;
    principal: Principal


class CandidRecord(Record):
    first_name: str
    last_name: str
    age: nat8


class CandidVariant(Variant, total=False):
    Tag1: null
    Tag2: null
    Tag3: int


class MyService(Service):
    @service_query
    def query1(self) -&gt; bool:
        ...

    @service_update
    def update1(self) -&gt; str:
        ...


CandidFunc = Func(Query[[], Candid])


@query
def candid_types() -&gt; Candid:
    return {
        &quot;text&quot;: &quot;text&quot;,
        &quot;blob&quot;: bytes(),
        &quot;nat&quot;: 340_282_366_920_938_463_463_374_607_431_768_211_455,
        &quot;nat64&quot;: 18_446_744_073_709_551_615,
        &quot;nat32&quot;: 4_294_967_295,
        &quot;nat16&quot;: 65_535,
        &quot;nat8&quot;: 255,
        &quot;int&quot;: 170_141_183_460_469_231_731_687_303_715_884_105_727,
        &quot;int64&quot;: 9_223_372_036_854_775_807,
        &quot;int32&quot;: 2_147_483_647,
        &quot;int16&quot;: 32_767,
        &quot;int8&quot;: 127,
        &quot;float64&quot;: 0.0,
        &quot;float32&quot;: 0.0,
        &quot;bool&quot;: True,
        &quot;null&quot;: None,
        &quot;vec&quot;: [&quot;has one element&quot;],
        &quot;opt&quot;: None,
        &quot;record&quot;: {&quot;first_name&quot;: &quot;John&quot;, &quot;last_name&quot;: &quot;Doe&quot;, &quot;age&quot;: 35},
        &quot;variant&quot;: {&quot;Tag1&quot;: None},
        &quot;func&quot;: (Principal.from_str(&quot;rrkah-fqaaa-aaaaa-aaaaq-cai&quot;), &quot;candid_types&quot;),
        &quot;service&quot;: MyService(Principal.from_str(&quot;aaaaa-aa&quot;)),
        &quot;principal&quot;: Principal.from_str(&quot;ryjl3-tyaaa-aaaaa-aaaba-cai&quot;),
    }
</code></pre>
<p>Calling <code>candid_types</code> with <code>dfx</code> will return:</p>
<pre><code>(
  record {
    &quot;int&quot; = 170_141_183_460_469_231_731_687_303_715_884_105_727 : int;
    &quot;nat&quot; = 340_282_366_920_938_463_463_374_607_431_768_211_455 : nat;
    &quot;opt&quot; = null;
    &quot;vec&quot; = vec { &quot;has one element&quot; };
    &quot;service&quot; = service &quot;aaaaa-aa&quot;;
    &quot;principal&quot; = principal &quot;ryjl3-tyaaa-aaaaa-aaaba-cai&quot;;
    &quot;blob&quot; = vec {};
    &quot;bool&quot; = true;
    &quot;func&quot; = func &quot;rrkah-fqaaa-aaaaa-aaaaq-cai&quot;.candid_types;
    &quot;int8&quot; = 127 : int8;
    &quot;nat8&quot; = 255 : nat8;
    &quot;null&quot; = null : null;
    &quot;text&quot; = &quot;text&quot;;
    &quot;nat16&quot; = 65_535 : nat16;
    &quot;nat32&quot; = 4_294_967_295 : nat32;
    &quot;nat64&quot; = 18_446_744_073_709_551_615 : nat64;
    &quot;int16&quot; = 32_767 : int16;
    &quot;int32&quot; = 2_147_483_647 : int32;
    &quot;int64&quot; = 9_223_372_036_854_775_807 : int64;
    &quot;variant&quot; = variant { Tag1 };
    &quot;float32&quot; = 0 : float32;
    &quot;float64&quot; = 0 : float64;
    &quot;record&quot; = record {
      age = 35 : nat8;
      first_name = &quot;John&quot;;
      last_name = &quot;Doe&quot;;
    };
  },
)
</code></pre>
<h4 id="text"><a class="header" href="#text">text</a></h4>
<p>The Python type <code>str</code> and the Kybra type <code>text</code> both correspond to the <a href="https://internetcomputer.org/docs/current/references/candid-ref#type-text">Candid type text</a> and will become a <a href="https://docs.python.org/3/library/stdtypes.html#textseq">Python str</a> at runtime.</p>
<p>Python:</p>
<pre><code class="language-python">from kybra import ic, query


@query
def get_string() -&gt; str:
    return &quot;Hello world!&quot;


@query
def print_string(string: str) -&gt; str:
    ic.print(type(string))
    return string
</code></pre>
<p>Candid:</p>
<pre><code class="language-python">service: {
    &quot;get_string&quot;: () -&gt; (text) query;
    &quot;print_string&quot;: (text) -&gt; (text) query;
}
</code></pre>
<h4 id="blob"><a class="header" href="#blob">blob</a></h4>
<p>The Kybra type <code>blob</code> corresponds to the <a href="https://internetcomputer.org/docs/current/references/candid-ref#type-blob">Candid type blob</a> and will become a <a href="https://docs.python.org/3/library/stdtypes.html#bytes">Python bytes</a> at runtime.</p>
<p>Python:</p>
<pre><code class="language-Python">from kybra import blob, ic, query


@query
def get_blob() -&gt; blob:
    return bytes([68, 73, 68, 76, 0, 0])


@query
def print_blob(blob: blob) -&gt; blob:
    ic.print(type(blob))
    return blob
</code></pre>
<p>Candid:</p>
<pre><code>service: {
    &quot;get_blob&quot;: () -&gt; (blob) query;
    &quot;print_blob&quot;: (blob) -&gt; (blob) query;
}
</code></pre>
<h4 id="nat"><a class="header" href="#nat">nat</a></h4>
<p>The Kybra type <code>nat</code> corresponds to the <a href="https://internetcomputer.org/docs/current/references/candid-ref#type-nat">Candid type nat</a> and will become a <a href="https://docs.python.org/3/library/functions.html#int">Python int</a> at runtime.</p>
<p>Python:</p>
<pre><code class="language-python">from kybra import ic, nat, query


@query
def get_nat() -&gt; nat:
    return 340_282_366_920_938_463_463_374_607_431_768_211_455


@query
def print_nat(nat: nat) -&gt; nat:
    ic.print(type(nat))
    return nat
</code></pre>
<p>Candid:</p>
<pre><code>service: {
    &quot;get_nat&quot;: () -&gt; (nat) query;
    &quot;print_nat&quot;: (nat) -&gt; (nat) query;
}
</code></pre>
<h4 id="nat64"><a class="header" href="#nat64">nat64</a></h4>
<p>The Kybra type <code>nat64</code> corresponds to the <a href="https://internetcomputer.org/docs/current/references/candid-ref#type-natn-and-intn">Candid type nat64</a> and will become a <a href="https://docs.python.org/3/library/functions.html#int">Python int</a> at runtime.</p>
<p>Python:</p>
<pre><code class="language-python">from kybra import ic, nat64, query


@query
def get_nat64() -&gt; nat64:
    return 18_446_744_073_709_551_615


@query
def print_nat64(nat64: nat64) -&gt; nat64:
    ic.print(type(nat64))
    return nat64
</code></pre>
<p>Candid:</p>
<pre><code>service: {
    &quot;get_nat64&quot;: () -&gt; (nat64) query;
    &quot;print_nat64&quot;: (nat64) -&gt; (nat64) query;
}
</code></pre>
<h4 id="nat32"><a class="header" href="#nat32">nat32</a></h4>
<p>The Kybra type <code>nat32</code> corresponds to the <a href="https://internetcomputer.org/docs/current/references/candid-ref#type-natn-and-intn">Candid type nat32</a> and will become a <a href="https://docs.python.org/3/library/functions.html#int">Python int</a> at runtime.</p>
<p>Python:</p>
<pre><code class="language-python">from kybra import ic, nat32, query


@query
def get_nat32() -&gt; nat32:
    return 4_294_967_295


@query
def print_nat32(nat32: nat32) -&gt; nat32:
    ic.print(type(nat32))
    return nat32
</code></pre>
<p>Candid:</p>
<pre><code>service: {
    &quot;get_nat32&quot;: () -&gt; (nat32) query;
    &quot;print_nat32&quot;: (nat32) -&gt; (nat32) query;
}
</code></pre>
<h4 id="nat16"><a class="header" href="#nat16">nat16</a></h4>
<p>The Kybra type <code>nat16</code> corresponds to the <a href="https://internetcomputer.org/docs/current/references/candid-ref#type-natn-and-intn">Candid type nat16</a> and will become a <a href="https://docs.python.org/3/library/functions.html#int">Python int</a> at runtime.</p>
<p>Python:</p>
<pre><code class="language-python">from kybra import ic, nat16, query


@query
def get_nat16() -&gt; nat16:
    return 65_535


@query
def print_nat16(nat16: nat16) -&gt; nat16:
    ic.print(type(nat16))
    return nat16
</code></pre>
<p>Candid:</p>
<pre><code>service: {
    &quot;get_nat16&quot;: () -&gt; (nat16) query;
    &quot;print_nat16&quot;: (nat16) -&gt; (nat16) query;
}
</code></pre>
<h4 id="nat8"><a class="header" href="#nat8">nat8</a></h4>
<p>The Kybra type <code>nat8</code> corresponds to the <a href="https://internetcomputer.org/docs/current/references/candid-ref#type-natn-and-intn">Candid type nat8</a> and will become a <a href="https://docs.python.org/3/library/functions.html#int">Python int</a> at runtime.</p>
<p>Python:</p>
<pre><code class="language-python">from kybra import ic, nat8, query


@query
def get_nat8() -&gt; nat8:
    return 255


@query
def print_nat8(nat8: nat8) -&gt; nat8:
    ic.print(type(nat8))
    return nat8
</code></pre>
<p>Candid:</p>
<pre><code>service: {
    &quot;get_nat8&quot;: () -&gt; (nat8) query;
    &quot;print_nat8&quot;: (nat8) -&gt; (nat8) query;
}
</code></pre>
<h4 id="int"><a class="header" href="#int">int</a></h4>
<p>The Kybra type <code>int</code> corresponds to the <a href="https://internetcomputer.org/docs/current/references/candid-ref#type-int">Candid type int</a> and will become a <a href="https://docs.python.org/3/library/functions.html#int">Python int</a> at runtime.</p>
<p>Python:</p>
<pre><code class="language-python">from kybra import ic, query


@query
def get_int() -&gt; int:
    return 170_141_183_460_469_231_731_687_303_715_884_105_727


@query
def print_int(int: int) -&gt; int:
    ic.print(type(int))
    return int
</code></pre>
<p>Candid:</p>
<pre><code>service: {
    &quot;get_int&quot;: () -&gt; (int) query;
    &quot;print_int&quot;: (int) -&gt; (int) query;
}
</code></pre>
<h4 id="int64"><a class="header" href="#int64">int64</a></h4>
<p>The Kybra type <code>int64</code> corresponds to the <a href="https://internetcomputer.org/docs/current/references/candid-ref#type-natn-and-intn">Candid type int64</a> and will become a <a href="https://docs.python.org/3/library/functions.html#int">Python int</a> at runtime.</p>
<p>Python:</p>
<pre><code class="language-python">from kybra import ic, int64, query


@query
def get_int64() -&gt; int64:
    return 9_223_372_036_854_775_807


@query
def print_int64(int64: int64) -&gt; int64:
    ic.print(type(int64))
    return int64
</code></pre>
<p>Candid:</p>
<pre><code>service: {
    &quot;get_int64&quot;: () -&gt; (int64) query;
    &quot;print_int64&quot;: (int64) -&gt; (int64) query;
}
</code></pre>
<h4 id="int32"><a class="header" href="#int32">int32</a></h4>
<p>The Kybra type <code>int32</code> corresponds to the <a href="https://internetcomputer.org/docs/current/references/candid-ref#type-natn-and-intn">Candid type int32</a> and will become a <a href="https://docs.python.org/3/library/functions.html#int">Python int</a> at runtime.</p>
<p>Python:</p>
<pre><code class="language-python">from kybra import ic, int32, query


@query
def get_int32() -&gt; int32:
    return 2_147_483_647


@query
def print_int32(int32: int32) -&gt; int32:
    ic.print(type(int32))
    return int32
</code></pre>
<p>Candid:</p>
<pre><code>service: {
    &quot;get_int32&quot;: () -&gt; (int32) query;
    &quot;print_int32&quot;: (int32) -&gt; (int32) query;
}
</code></pre>
<h4 id="int16"><a class="header" href="#int16">int16</a></h4>
<p>The Kybra type <code>int16</code> corresponds to the <a href="https://internetcomputer.org/docs/current/references/candid-ref#type-natn-and-intn">Candid type int16</a> and will become a <a href="https://docs.python.org/3/library/functions.html#int">Python int</a> at runtime.</p>
<p>Python:</p>
<pre><code class="language-python">from kybra import ic, int16, query


@query
def get_int16() -&gt; int16:
    return 32_767


@query
def print_int16(int16: int16) -&gt; int16:
    ic.print(type(int16))
    return int16
</code></pre>
<p>Candid:</p>
<pre><code>service: {
    &quot;get_int16&quot;: () -&gt; (int16) query;
    &quot;print_int16&quot;: (int16) -&gt; (int16) query;
}
</code></pre>
<h4 id="int8"><a class="header" href="#int8">int8</a></h4>
<p>The Kybra type <code>int8</code> corresponds to the <a href="https://internetcomputer.org/docs/current/references/candid-ref#type-natn-and-intn">Candid type int8</a> and will become a <a href="https://docs.python.org/3/library/functions.html#int">Python int</a> at runtime.</p>
<p>Python:</p>
<pre><code class="language-python">from kybra import ic, int8, query


@query
def get_int8() -&gt; int8:
    return 127


@query
def print_int8(int8: int8) -&gt; int8:
    ic.print(type(int8))
    return int8
</code></pre>
<p>Candid:</p>
<pre><code>service: {
    &quot;get_int8&quot;: () -&gt; (int8) query;
    &quot;print_int8&quot;: (int8) -&gt; (int8) query;
}
</code></pre>
<h4 id="float64"><a class="header" href="#float64">float64</a></h4>
<p>The Kybra type <code>float64</code> corresponds to the <a href="https://internetcomputer.org/docs/current/references/candid-ref#type-float32-and-float64">Candid type float64</a> and will become a <a href="https://docs.python.org/3/library/functions.html#float">Python float</a> at runtime.</p>
<p>Python:</p>
<pre><code class="language-python">import math

from kybra import float64, ic, query


@query
def get_float64() -&gt; float64:
    return math.e


@query
def print_float64(float64: float64) -&gt; float64:
    ic.print(type(float64))
    return float64
</code></pre>
<p>Candid:</p>
<pre><code>service: {
    &quot;get_float64&quot;: () -&gt; (float64) query;
    &quot;print_float64&quot;: (float64) -&gt; (float64) query;
}
</code></pre>
<h4 id="float32"><a class="header" href="#float32">float32</a></h4>
<p>The Kybra type <code>float32</code> corresponds to the <a href="https://internetcomputer.org/docs/current/references/candid-ref#type-float32-and-float64">Candid type float32</a> and will become a <a href="https://docs.python.org/3/library/functions.html#float">Python float</a> at runtime.</p>
<p>Python:</p>
<pre><code class="language-python">import math

from kybra import float32, ic, query


@query
def get_float32() -&gt; float32:
    return math.pi


@query
def print_float32(float32: float32) -&gt; float32:
    ic.print(type(float32))
    return float32
</code></pre>
<p>Candid:</p>
<pre><code>service: {
    &quot;get_float32&quot;: () -&gt; (float32) query;
    &quot;print_float32&quot;: (float32) -&gt; (float32) query;
}
</code></pre>
<h4 id="bool"><a class="header" href="#bool">bool</a></h4>
<p>The Python type <code>bool</code> corresponds to the <a href="https://internetcomputer.org/docs/current/references/candid-ref#type-bool">Candid type bool</a> and will become a <a href="https://docs.python.org/3/library/stdtypes.html#boolean-values">Python Boolean Value</a> at runtime.</p>
<p>Python:</p>
<pre><code class="language-Python">from kybra import ic, query


@query
def get_bool() -&gt; bool:
    return True


@query
def print_bool(bool: bool) -&gt; bool:
    ic.print(type(bool))
    return bool
</code></pre>
<p>Candid:</p>
<pre><code>service: {
    &quot;get_bool&quot;: () -&gt; (bool) query;
    &quot;print_bool&quot;: (bool) -&gt; (bool) query;
}
</code></pre>
<h4 id="null"><a class="header" href="#null">null</a></h4>
<p>The Kybra type <code>null</code> corresponds to the <a href="https://internetcomputer.org/docs/current/references/candid-ref#type-null">Candid type null</a> and will become the <a href="https://docs.python.org/3/library/stdtypes.html#the-null-object">Python Null Object</a> at runtime.</p>
<p>Python:</p>
<pre><code class="language-python">from kybra import ic, null, query


@query
def get_null() -&gt; null:
    return None


@query
def print_null(none: null) -&gt; null:
    ic.print(type(none))
    return none
</code></pre>
<p>Candid:</p>
<pre><code>service: {
    &quot;get_null&quot;: () -&gt; (null) query;
    &quot;print_null&quot;: (null) -&gt; (null) query;
}
</code></pre>
<h4 id="vec"><a class="header" href="#vec">vec</a></h4>
<p>The Kybra type <code>Vec</code> corresponds to the <a href="https://internetcomputer.org/docs/current/references/candid-ref#type-vec-t">Candid type vec</a> and will become an array of the specified type at runtime.</p>
<p>Python:</p>
<pre><code class="language-python">from kybra import int32, query, Vec


@query
def get_numbers() -&gt; Vec[int32]:
    return [0, 1, 2, 3]
</code></pre>
<p>Candid:</p>
<pre><code>service: {
    &quot;get_numbers&quot;: () -&gt; (vec int32) query;
}
</code></pre>
<h4 id="opt"><a class="header" href="#opt">Opt</a></h4>
<p>The Kybra type <code>Opt</code> corresponds to the <a href="https://internetcomputer.org/docs/current/references/candid-ref#type-opt-t">Candid type opt</a> and will become the enclosed Python type or None at runtime.</p>
<p>Python:</p>
<pre><code class="language-python">from kybra import Opt, query


@query
def get_opt_some() -&gt; Opt[bool]:
    return True


@query
def get_opt_none() -&gt; Opt[bool]:
    return None
</code></pre>
<p>Candid:</p>
<pre><code>service: {
    &quot;get_opt_some&quot;: () -&gt; (opt bool) query;
    &quot;get_opt_none&quot;: () -&gt; (opt bool) query;
}
</code></pre>
<h4 id="record"><a class="header" href="#record">record</a></h4>
<p>Python classes that inherit from the Kybra type <code>Record</code> correspond to the <a href="https://internetcomputer.org/docs/current/references/candid-ref#type-record--n--t--">Candid record type</a> and will become <a href="https://docs.python.org/3/library/typing.html#typing.TypedDict">Python TypedDicts</a> at runtime.</p>
<p>Python:</p>
<pre><code class="language-python">from kybra import Record, Vec


class Post(Record):
    id: str
    author: &quot;User&quot;
    text: str
    thread: &quot;Thread&quot;


class Thread(Record):
    id: str
    author: &quot;User&quot;
    posts: Vec[Post]
    title: str


class User(Record):
    id: str
    posts: Vec[Post]
    thread: Vec[Thread]
    username: str
</code></pre>
<p>Candid:</p>
<pre><code>type Post = record {
    &quot;id&quot;: text;
    &quot;author&quot;: User;
    &quot;text&quot;: text;
    &quot;thread&quot;: Thread;
};

type Thread = record {
    &quot;id&quot;: text;
    &quot;author&quot;: User;
    &quot;posts&quot;: vec Post;
    &quot;title&quot;: text;
};

type User = record {
    &quot;id&quot;: text;
    &quot;posts&quot;: vec Post;
    &quot;threads&quot;: vec Thread;
    &quot;username&quot;: text;
};
</code></pre>
<h4 id="variant"><a class="header" href="#variant">variant</a></h4>
<p>Python classes that inherit from the Kybra type <code>Variant</code> correspond to the <a href="https://internetcomputer.org/docs/current/references/candid-ref#type-variant--n--t--">Candid variant type</a> and will become <a href="https://docs.python.org/3/library/typing.html#typing.TypedDict">Python TypedDicts</a> at runtime.</p>
<p>Python:</p>
<pre><code class="language-python">from kybra import nat32, null, Variant


class ReactionType(Variant, total=False):
    Fire: null
    ThumbsUp: null
    ThumbsDown: null
    Emotion: &quot;Emotion&quot;
    Firework: &quot;Firework&quot;


class Emotion(Variant, total=False):
    Happy: null
    Sad: null


class Firework(Variant, total=False):
    Color: str
    NumStreaks: nat32
</code></pre>
<p>Candid:</p>
<pre><code>type ReactionType = variant {
    &quot;Fire&quot;: null;
    &quot;ThumbsUp&quot;: null;
    &quot;ThumbsDown&quot;: null;
    &quot;Emotion&quot;: Emotion;
    &quot;Firework&quot;: Firework
};

type Emotion = variant {
    &quot;Happy&quot;: null;
    &quot;Sad&quot;: null
};

type Firework = record {
    &quot;Color&quot;: text;
    &quot;NumStreaks&quot;: nat32;
};
</code></pre>
<h4 id="func"><a class="header" href="#func">func</a></h4>
<p>The Kybra type <code>Func</code> corresponds to the <a href="https://internetcomputer.org/docs/current/references/candid-ref#type-func---">Candid type func</a> and at runtime will become a Python tuple with two elements, the first being an <a href="https://github.com/rocklabs-io/ic-py">ic-py Principal</a> and the second being a <a href="https://docs.python.org/3/library/stdtypes.html#textseq">Python str</a>. The <code>ic-py Principal</code> represents the <code>principal</code> of the canister/service where the function exists, and the <code>str</code> represents the function's name.</p>
<p>Python:</p>
<pre><code class="language-python">from kybra import Func, nat64, null, Principal, query, Query, Record, Update, Variant


class User(Record):
    id: str
    basic_func: &quot;BasicFunc&quot;
    complex_func: &quot;ComplexFunc&quot;


class Reaction(Variant, total=False):
    Good: null
    Bad: null
    BasicFunc: &quot;BasicFunc&quot;
    ComplexFunc: &quot;ComplexFunc&quot;


BasicFunc = Func(Query[[str], str])
ComplexFunc = Func(Update[[User, Reaction], nat64])


@query
def get_basic_func() -&gt; BasicFunc:
    return (Principal.from_str(&quot;rrkah-fqaaa-aaaaa-aaaaq-cai&quot;), &quot;simple_function_name&quot;)


@query
def get_complex_func() -&gt; ComplexFunc:
    return (Principal.from_str(&quot;ryjl3-tyaaa-aaaaa-aaaba-cai&quot;), &quot;complex_function_name&quot;)
</code></pre>
<p>Candid:</p>
<pre><code>type User = record {
    &quot;id&quot;: text;
    &quot;basic_func&quot;: BasicFunc;
    &quot;complex_func&quot;: ComplexFunc;
};
type Reaction = variant { &quot;Good&quot;: null; &quot;Bad&quot;: null; &quot;BasicFunc&quot;: BasicFunc; &quot;ComplexFunc&quot;: ComplexFunc };

type BasicFunc = func (text) -&gt; (text) query;
type ComplexFunc = func (User, Reaction) -&gt; (nat64);

service: () -&gt; {
    &quot;get_basic_func&quot;: () -&gt; (BasicFunc) query;
    &quot;get_complex_func&quot;: () -&gt; (ComplexFunc) query;
}

</code></pre>
<h4 id="service"><a class="header" href="#service">service</a></h4>
<p>Python classes that inherit from the Kybra type <code>Service</code> correspond to the <a href="https://internetcomputer.org/docs/current/references/candid-ref#type-service-">Candid service type</a> and will become child classes capable of creating instances that can perform cross-canister calls at runtime.</p>
<p>Python:</p>
<pre><code class="language-python">from kybra import (
    Async,
    CallResult,
    Principal,
    query,
    Service,
    service_query,
    service_update,
    update,
)


class SomeService(Service):
    @service_query
    def query1(self) -&gt; bool:
        ...

    @service_update
    def update1(self) -&gt; str:
        ...


@query
def get_service() -&gt; SomeService:
    return SomeService(Principal.from_str(&quot;aaaaa-aa&quot;))


@update
def call_service(service: SomeService) -&gt; Async[str]:
    result: CallResult[str] = yield service.update1()

    if result.Err is not None:
        raise Exception(f&quot;call to service.update1 failed with: {result.Err}&quot;)

    return result.Ok
</code></pre>
<p>Candid:</p>
<pre><code>service { query1 : () -&gt; (bool) query; update1 : () -&gt; (text) }
</code></pre>
<h4 id="principal"><a class="header" href="#principal">principal</a></h4>
<p>The Kybra type <code>Principal</code> corresponds to the <a href="https://internetcomputer.org/docs/current/references/candid-ref#type-principal">Candid type principal</a> and will become an <a href="https://github.com/rocklabs-io/ic-py">ic-py Principal</a> at runtime.</p>
<p>Python:</p>
<pre><code class="language-python">from kybra import ic, Principal, query


@query
def get_principal() -&gt; Principal:
    return Principal.from_str(&quot;rrkah-fqaaa-aaaaa-aaaaq-cai&quot;)


@query
def print_principal(principal: Principal) -&gt; Principal:
    ic.print(type(principal))
    return principal
</code></pre>
<p>Candid:</p>
<pre><code>service: {
    &quot;get_principal&quot;: () -&gt; (principal) query;
    &quot;print_principal&quot;: (principal) -&gt; (principal) query;
}
</code></pre>
<h4 id="reserved"><a class="header" href="#reserved">reserved</a></h4>
<p>The Kybra type <code>reserved</code> corresponds to the <a href="https://internetcomputer.org/docs/current/references/candid-ref#type-reserved">Candid type reserved</a> and will become the <a href="https://docs.python.org/3/library/stdtypes.html#the-null-object">Python Null Object</a> at runtime.</p>
<p>Python:</p>
<pre><code class="language-python">from kybra import ic, query, reserved


@query
def get_reserved() -&gt; reserved:
    return &quot;anything&quot;


@query
def print_reserved(reserved: reserved) -&gt; reserved:
    ic.print(type(reserved))
    return reserved
</code></pre>
<p>Candid:</p>
<pre><code>service: {
    &quot;get_reserved&quot;: () -&gt; (reserved) query;
    &quot;print_reserved&quot;: (reserved) -&gt; (reserved) query;
}
</code></pre>
<h4 id="empty"><a class="header" href="#empty">empty</a></h4>
<p>The Kybra type <code>empty</code> corresponds to the <a href="https://internetcomputer.org/docs/current/references/candid-ref#type-empty">Candid type empty</a> and has no Python value at runtime.</p>
<p>Python:</p>
<pre><code class="language-python">from kybra import empty, ic, query


@query
def get_empty() -&gt; empty:
    raise Exception(&quot;Anything you want&quot;)


# Note: It is impossible to call this function because it requires an argument
# but there is no way to pass an &quot;empty&quot; value as an argument.
@query
def print_empty(empty: empty) -&gt; empty:
    ic.print(type(empty))
    raise Exception(&quot;Anything you want&quot;)
</code></pre>
<p>Candid:</p>
<pre><code>service: {
    &quot;get_empty&quot;: () -&gt; (empty) query;
    &quot;print_empty&quot;: (empty) -&gt; (empty) query;
}
</code></pre>
<div style="break-before: page; page-break-before: always;"></div><h1 id="stable-structures"><a class="header" href="#stable-structures">Stable Structures</a></h1>
<h2 id="tldr-2"><a class="header" href="#tldr-2">TLDR</a></h2>
<ul>
<li>96 GiB of stable memory</li>
<li>Persistent across upgrades</li>
<li>Familiar API</li>
<li>Must specify memory id</li>
<li>Must specify maximum key size</li>
<li>Must specify maximum value size</li>
<li>No migrations per memory id</li>
</ul>
<p>Stable structures are data structures with familiar APIs that allow access to stable memory. Stable memory is a separate memory location from the heap that currently allows up to 96 GiB of storage. Stable memory persists automatically across upgrades.</p>
<p>Persistence on the Internet Computer (IC) is very important to understand. When a canister is upgraded (its code is changed after being initially deployed) its heap is wiped. This includes all global variables.</p>
<p>On the other hand, anything stored in stable memory will be preserved. Writing and reading to and from stable memory can be done with a <a href="./reference/stable_memory/stable_memory.html">low-level API</a>, but it is generally easier and preferable to use stable structures.</p>
<p>Kybra currently provides one stable structure called <code>StableBTreeMap</code>. It's similar to a Python dictionary or a map that you'd find in most languages, and has most of the common operations you'd expect such as reading, inserting, and removing values.</p>
<p>Here's how to define a simple <code>StableBTreeMap</code>. Each <code>StableBTreeMap</code> must be defined in the global scope (not within any functions or objects etc):</p>
<pre><code class="language-python">from kybra import nat8, StableBTreeMap

map = StableBTreeMap[nat8, str](memory_id=3, max_key_size=100, max_value_size=1_000)
</code></pre>
<p>This is a <code>StableBTreeMap</code> with a key of type <code>nat8</code> and a value of type <code>str</code>. Key and value types can be any <a href="./candid.html">Candid type</a>.</p>
<p>This <code>StableBTreeMap</code> also has a <code>memory id</code> of <code>3</code>, a maximum key size of <code>100</code> bytes and a maximum value size of <code>1_000</code> bytes. You must statically specify the <code>memory id</code>, maximum key size, and maximum value sizes (they cannot be variables).</p>
<p>The <code>memory id</code> can be a number between <code>0</code> and <code>254</code>, but <code>memory ids</code> <code>0</code>, <code>1</code>, <code>2</code>, <code>252</code>, <code>253</code>, and <code>254</code> are currently reserved. We hope to reduce the complexity around <code>memory id</code> in the future, and perhaps remove the need to specify it entirely.</p>
<p>Each <code>StableBTreeMap</code> instance must have a unique <code>memory id</code>. Once a <code>memory id</code> is allocated, it cannot be used with a different <code>StableBTreeMap</code>. This means you can't create another <code>StableBTreeMap</code> using the same <code>memory id</code>, and you can't change the key or value types of an existing <code>StableBTreeMap</code>. <a href="https://github.com/demergent-labs/kybra/issues/215">This problem will be addressed</a>.</p>
<p>Here's an example showing all of the basic <code>StableBTreeMap</code> operations:</p>
<pre><code class="language-python">from kybra import (
    Alias,
    nat64,
    nat8,
    Opt,
    query,
    StableBTreeMap,
    Tuple,
    update,
    Vec,
)

Key = Alias[nat8]
Value = Alias[str]


map = StableBTreeMap[Key, Value](memory_id=3, max_key_size=100, max_value_size=1_000)


@query
def contains_key(key: Key) -&gt; bool:
    return map.contains_key(key)


@query
def get(key: Key) -&gt; Opt[Value]:
    return map.get(key)


@update
def insert(key: Key, value: Value) -&gt; Opt[Value]:
    return map.insert(key, value)


@query
def is_empty() -&gt; bool:
    return map.is_empty()


@query
def items() -&gt; Vec[Tuple[Key, Value]]:
    return map.items()


@query
def keys() -&gt; Vec[Key]:
    return map.keys()


@query
def len() -&gt; nat64:
    return map.len()


@update
def remove(key: Key) -&gt; Opt[Value]:
    return map.remove(key)


@query
def values() -&gt; Vec[Value]:
    return map.values()
</code></pre>
<p>With these basic operations you can build more complex CRUD database applications:</p>
<pre><code class="language-python">import secrets

from kybra import (
    blob,
    ic,
    nat64,
    Opt,
    Principal,
    query,
    Record,
    StableBTreeMap,
    update,
    Variant,
    Vec,
)


class User(Record):
    id: Principal
    created_at: nat64
    recording_ids: Vec[Principal]
    username: str


class Recording(Record):
    id: Principal
    audio: blob
    created_at: nat64
    name: str
    user_id: Principal


users = StableBTreeMap[Principal, User](
    memory_id=3, max_key_size=38, max_value_size=100_000
)
recordings = StableBTreeMap[Principal, Recording](
    memory_id=4, max_key_size=38, max_value_size=5_000_000
)


@update
def create_user(username: str) -&gt; User:
    id = generate_id()
    user: User = {
        &quot;id&quot;: id,
        &quot;created_at&quot;: ic.time(),
        &quot;recording_ids&quot;: [],
        &quot;username&quot;: username,
    }

    users.insert(user[&quot;id&quot;], user)

    return user


@query
def read_users() -&gt; Vec[User]:
    return users.values()


@query
def read_user_by_id(id: Principal) -&gt; Opt[User]:
    return users.get(id)


class DeleteUserResult(Variant, total=False):
    Ok: User
    Err: &quot;DeleteUserErr&quot;


class DeleteUserErr(Variant, total=False):
    UserDoesNotExist: Principal


@update
def delete_user(id: Principal) -&gt; DeleteUserResult:
    user = users.get(id)

    if user is None:
        return {&quot;Err&quot;: {&quot;UserDoesNotExist&quot;: id}}

    for recording_id in user[&quot;recording_ids&quot;]:
        recordings.remove(recording_id)

    users.remove(user[&quot;id&quot;])

    return {&quot;Ok&quot;: user}


class CreateRecordingResult(Variant, total=False):
    Ok: Recording
    Err: &quot;CreateRecordingErr&quot;


class CreateRecordingErr(Variant, total=False):
    UserDoesNotExist: Principal


@update
def create_recording(
    audio: blob, name: str, user_id: Principal
) -&gt; CreateRecordingResult:
    user = users.get(user_id)

    if user is None:
        return {&quot;Err&quot;: {&quot;UserDoesNotExist&quot;: user_id}}

    id = generate_id()
    recording: Recording = {
        &quot;id&quot;: id,
        &quot;audio&quot;: audio,
        &quot;created_at&quot;: ic.time(),
        &quot;name&quot;: name,
        &quot;user_id&quot;: user_id,
    }

    recordings.insert(recording[&quot;id&quot;], recording)

    updated_user: User = {
        &quot;id&quot;: user[&quot;id&quot;],
        &quot;created_at&quot;: user[&quot;created_at&quot;],
        &quot;username&quot;: user[&quot;username&quot;],
        &quot;recording_ids&quot;: [*user[&quot;recording_ids&quot;], recording[&quot;id&quot;]],
    }

    users.insert(updated_user[&quot;id&quot;], updated_user)

    return {&quot;Ok&quot;: recording}


@query
def read_recordings() -&gt; Vec[Recording]:
    return recordings.values()


@query
def read_recording_by_id(id: Principal) -&gt; Opt[Recording]:
    return recordings.get(id)


class DeleteRecordingResult(Variant, total=False):
    Ok: Recording
    Err: &quot;DeleteRecordingError&quot;


class DeleteRecordingError(Variant, total=False):
    RecordingDoesNotExist: Principal
    UserDoesNotExist: Principal


@update
def delete_recording(id: Principal) -&gt; DeleteRecordingResult:
    recording = recordings.get(id)

    if recording is None:
        return {&quot;Err&quot;: {&quot;RecordingDoesNotExist&quot;: id}}

    user = users.get(recording[&quot;user_id&quot;])

    if user is None:
        return {&quot;Err&quot;: {&quot;UserDoesNotExist&quot;: recording[&quot;user_id&quot;]}}

    updated_user: User = {
        &quot;id&quot;: user[&quot;id&quot;],
        &quot;created_at&quot;: user[&quot;created_at&quot;],
        &quot;username&quot;: user[&quot;username&quot;],
        &quot;recording_ids&quot;: list(
            filter(
                lambda recording_id: recording_id.to_str() != recording[&quot;id&quot;].to_str(),
                user[&quot;recording_ids&quot;],
            )
        ),
    }

    users.insert(updated_user[&quot;id&quot;], updated_user)

    recordings.remove(id)

    return {&quot;Ok&quot;: recording}


def generate_id() -&gt; Principal:
    random_bytes = secrets.token_bytes(29)

    return Principal.from_hex(random_bytes.hex())
</code></pre>
<p>The example above shows a very basic audio recording backend application. There are two types of entities that need to be stored, <code>User</code> and <code>Recording</code>. These are represented as <code>Candid</code> records.</p>
<p>Each entity gets its own <code>StableBTreeMap</code>:</p>
<pre><code class="language-python">from kybra import blob, nat64, Principal, Record, StableBTreeMap, Vec


class User(Record):
    id: Principal
    created_at: nat64
    recording_ids: Vec[Principal]
    username: str


class Recording(Record):
    id: Principal
    audio: blob
    created_at: nat64
    name: str
    user_id: Principal


users = StableBTreeMap[Principal, User](
    memory_id=3, max_key_size=38, max_value_size=100_000
)
recordings = StableBTreeMap[Principal, Recording](
    memory_id=4, max_key_size=38, max_value_size=5_000_000
)
</code></pre>
<p>Notice that each <code>StableBTreeMap</code> has a unique <code>memory id</code>. The maximum key and value sizes are also set according to the expected application usage.</p>
<p>You can figure out the appropriate maximum key and value sizes by reasoning about your application and engaging in some trial and error using the <code>insert</code> method. Calling <code>insert</code> on a <code>StableBTreeMap</code> will throw an error which in some cases will have the information that you need to determine the maximum key or value size.</p>
<p>If you attempt to insert a key or value that is too large, the <code>KeyTooLarge</code> and <code>ValueTooLarge</code> errors will show you the size of the value that you attempted to insert. You can increase the maximum key or value size based on the information you receive from the <code>KeyTooLarge</code> and <code>ValueTooLarge</code> errors and try inserting again.</p>
<p>Thus through some trial and error you can whittle your way to a correct solution. In some cases all of your values will have an obvious static maximum size. In the audio recording example, trial and error revealed that <code>Principal</code> is most likely always 38 bytes, thus the maximum key size is set to 38.</p>
<p>Maximum value sizes can be more tricky to figure out, especially if the values are records or variants with dynamic fields such as arrays. <code>User</code> has one such dynamic field, <code>recording_ids</code>. Since each recording id is a <code>Principal</code>, we know that each will take up 38 bytes. The other fields on <code>User</code> shouldn't take up too many bytes so we'll ignore them for our analysis.</p>
<p>We've set the maximum value size of <code>User</code> to be 100_000 bytes. If we divide 100_00 by 38, we get ~2_631. This will result in each user being able to store around that many recordings. That's acceptable for our example, and so we'll go with it.</p>
<p>As for <code>Recording</code>, the largest dynamic field is <code>audio</code>, which will be the actual bytes of the audio recording. We've set the maximum value size here to 5_000_000, which should allow for recordings of ~5 MB in size. That seems reasonable for our example, and so we'll go with it.</p>
<p>As you can see, finding the correct maximum key and value sizes is a bit of an art right now. Combining some trial and error with reasoning about your specific application should get you a working solution in most cases. It's our hope that the need to specify maximum key and value sizes will be removed in the future.</p>
<h2 id="caveats"><a class="header" href="#caveats">Caveats</a></h2>
<h3 id="memory-ids"><a class="header" href="#memory-ids">memory ids</a></h3>
<p>The <code>memory id</code> can be a number between <code>0</code> and <code>254</code>, but <code>memory ids</code> <code>0</code>, <code>1</code>, <code>2</code>, and <code>254</code> are currently reserved. We hope to reduce the complexity around <code>memory id</code> in the future, and perhaps remove the need for it entirely.</p>
<h3 id="keys"><a class="header" href="#keys">Keys</a></h3>
<p>You should be wary when using <code>float64</code>, <code>float32</code>, <code>service</code>, or <code>func</code> in any type that is a key for a stable structure. These types do not have the ability to be strictly ordered in all cases. <code>service</code> and <code>func</code> will have no order. <code>float64</code> and <code>float32</code> will treat <code>NaN</code> as less than any other type. These caveats may impact key performance.</p>
<div style="break-before: page; page-break-before: always;"></div><h1 id="cross-canister"><a class="header" href="#cross-canister">Cross-canister</a></h1>
<p>Examples:</p>
<ul>
<li><a href="https://github.com/demergent-labs/kybra/tree/main/examples/bitcoin">bitcoin</a></li>
<li><a href="https://github.com/demergent-labs/kybra/tree/main/examples/composite_queries">composite_queries</a></li>
<li><a href="https://github.com/demergent-labs/kybra/tree/main/examples/cross_canister_calls">cross_canister_calls</a></li>
<li><a href="https://github.com/demergent-labs/kybra/tree/main/examples/cycles">cycles</a></li>
<li><a href="https://github.com/demergent-labs/kybra/tree/main/examples/ethereum_json_rpc">ethereum_json_rpc</a></li>
<li><a href="https://github.com/demergent-labs/kybra/tree/main/examples/func_types">func_types</a></li>
<li><a href="https://github.com/demergent-labs/kybra/tree/main/examples/heartbeat">heartbeat</a></li>
<li><a href="https://github.com/demergent-labs/kybra/tree/main/examples/generators">generators</a></li>
<li><a href="https://github.com/demergent-labs/kybra/tree/main/examples/ledger_canister">ledger_canister</a></li>
<li><a href="https://github.com/demergent-labs/kybra/tree/main/examples/management_canister">management_canister</a></li>
<li><a href="https://github.com/demergent-labs/kybra/tree/main/examples/outgoing_http_requests">outgoing_http_requests</a></li>
<li><a href="https://github.com/demergent-labs/kybra/tree/main/examples/threshold_ecdsa">threshold_ecdsa</a></li>
<li><a href="https://github.com/demergent-labs/kybra/tree/main/examples/rejections">rejections</a></li>
<li><a href="https://github.com/demergent-labs/kybra/tree/main/examples/timers">timers</a></li>
<li><a href="https://github.com/demergent-labs/kybra/tree/main/examples/motoko_examples/whoami">whoami</a></li>
</ul>
<p>Canisters are generally able to call the query or update methods of other canisters in any subnet. We refer to these types of calls as cross-canister calls.</p>
<p>A cross-canister call begins with a definition of the canister to be called, referred to as a service.</p>
<p>Imagine a simple service called <code>token_canister</code>:</p>
<pre><code class="language-python">from kybra import ic, nat64, Principal, StableBTreeMap, update

accounts = StableBTreeMap[Principal, nat64](
    memory_id=3, max_key_size=38, max_value_size=15
)


@update
def transfer(to: Principal, amount: nat64) -&gt; nat64:
    from_ = ic.caller()

    from_balance = accounts.get(from_) or 0
    to_balance = accounts.get(to) or 0

    accounts.insert(from_, from_balance - amount)
    accounts.insert(to, to_balance + amount)

    return amount
</code></pre>
<p>Here's how you would create its service definition:</p>
<pre><code class="language-python">from kybra import nat64, Principal, Service, service_update


class TokenCanister(Service):
    @service_update
    def transfer(self, to: Principal, amount: nat64) -&gt; nat64:
        ...
</code></pre>
<p>Once you have a service definition you can instantiate it with the service's <code>Principal</code> and then invoke its methods.</p>
<p>Here's how to instantiate <code>TokenCanister</code>:</p>
<pre><code class="language-python">token_canister = TokenCanister(
    Principal.from_str('r7inp-6aaaa-aaaaa-aaabq-cai')
)
</code></pre>
<p>And here's a more complete example of a service called <code>payout_canister</code> that performs a cross-canister call to <code>token_canister</code>:</p>
<pre><code class="language-python">from kybra import (
    Async,
    CallResult,
    match,
    nat64,
    Principal,
    Service,
    service_update,
    update,
    Variant,
)


class TokenCanister(Service):
    @service_update
    def transfer(self, to: Principal, amount: nat64) -&gt; nat64:
        ...


token_canister = TokenCanister(Principal.from_str(&quot;r7inp-6aaaa-aaaaa-aaabq-cai&quot;))


class PayoutResult(Variant, total=False):
    Ok: nat64
    Err: str


@update
def payout(to: Principal, amount: nat64) -&gt; Async[PayoutResult]:
    result: CallResult[nat64] = yield token_canister.transfer(to, amount)

    return match(result, {&quot;Ok&quot;: lambda ok: {&quot;Ok&quot;: ok}, &quot;Err&quot;: lambda err: {&quot;Err&quot;: err}})
</code></pre>
<p>Notice that the <code>token_canister.transfer</code> method, because it is a cross-canister method, returns a <code>CallResult</code>. All cross-canister calls return <code>CallResult</code>, which has an <code>Ok</code> or <code>Err</code> property depending on if the cross-canister call was successful or not.</p>
<p>The IC guarantees that cross-canister calls will return. This means that, generally speaking, you will always receive a <code>CallResult</code>. Kybra does not raise on cross-canister calls. Wrapping your cross-canister call in a <code>try...except</code> most likely won't do anything useful.</p>
<p>Let's add to our example code and explore adding some practical result-based error-handling to stop people from stealing tokens.</p>
<p><code>token_canister</code>:</p>
<pre><code class="language-python">from kybra import ic, nat64, Principal, StableBTreeMap, update, Variant

accounts = StableBTreeMap[Principal, nat64](
    memory_id=3, max_key_size=38, max_value_size=15
)


class TransferResult(Variant, total=False):
    Ok: nat64
    Err: &quot;TransferError&quot;


class TransferError(Variant, total=False):
    InsufficientBalance: nat64


@update
def transfer(to: Principal, amount: nat64) -&gt; TransferResult:
    from_ = ic.caller()

    from_balance = accounts.get(from_) or 0

    if from_balance &lt; amount:
        return {&quot;Err&quot;: {&quot;InsufficientBalance&quot;: from_balance}}

    to_balance = accounts.get(to) or 0

    accounts.insert(from_, from_balance - amount)
    accounts.insert(to, to_balance + amount)

    return {&quot;Ok&quot;: amount}
</code></pre>
<p><code>payout_canister</code>:</p>
<pre><code class="language-python">from kybra import (
    Async,
    CallResult,
    match,
    nat64,
    Principal,
    Service,
    service_update,
    update,
    Variant,
)


class TokenCanister(Service):
    @service_update
    def transfer(self, to: Principal, amount: nat64) -&gt; &quot;TransferResult&quot;:
        ...


class TransferResult(Variant, total=False):
    Ok: nat64
    Err: &quot;TransferError&quot;


class TransferError(Variant, total=False):
    InsufficientBalance: nat64


token_canister = TokenCanister(Principal.from_str(&quot;r7inp-6aaaa-aaaaa-aaabq-cai&quot;))


class PayoutResult(Variant, total=False):
    Ok: nat64
    Err: str


@update
def payout(to: Principal, amount: nat64) -&gt; Async[PayoutResult]:
    call_result: CallResult[TransferResult] = yield token_canister.transfer(to, amount)

    def handle_transfer_result_ok(transfer_result: TransferResult) -&gt; PayoutResult:
        return match(
            transfer_result,
            {
                &quot;Ok&quot;: lambda ok: {&quot;Ok&quot;: ok},
                &quot;Err&quot;: lambda err: {&quot;Err&quot;: str(err)},
            },
        )

    return match(
        call_result,
        {
            &quot;Ok&quot;: handle_transfer_result_ok,
            &quot;Err&quot;: lambda err: {&quot;Err&quot;: err},
        },
    )
</code></pre>
<p>So far we have only shown a cross-canister call from an update method. Update methods can call other update methods or query methods (but not composite query methods as discussed below). If an update method calls a query method, that query method will be called in replicated mode. Replicated mode engages the consensus process, but for queries the state will still be discarded.</p>
<p>Cross-canister calls can also be initiated from query methods. These are known as composite queries, and in Kybra they are simply query methods that return a generator using the <code>Async</code> type. Composite queries can call other composite query methods and regular query methods. Composite queries cannot call update methods.</p>
<p>Here's an example of a composite query method:</p>
<pre><code class="language-python">from kybra import (
    Async,
    CallResult,
    match,
    Principal,
    query,
    Service,
    service_query,
    Variant,
)


class SomeCanister(Service):
    @service_query
    def query_for_boolean(self) -&gt; bool:
        ...


some_canister = SomeCanister(Principal.from_str(&quot;ryjl3-tyaaa-aaaaa-aaaba-cai&quot;))


class QuerySomeCanisterResult(Variant, total=False):
    Ok: bool
    Err: str


@query
def query_some_canister() -&gt; Async[QuerySomeCanisterResult]:
    call_result: CallResult[bool] = yield some_canister.query_for_boolean()

    return match(
        call_result, {&quot;Ok&quot;: lambda ok: {&quot;Ok&quot;: ok}, &quot;Err&quot;: lambda err: {&quot;Err&quot;: err}}
    )
</code></pre>
<p>You can expect cross-canister calls within the same subnet to take up to a few seconds to complete, and cross-canister calls across subnets <a href="https://forum.dfinity.org/t/can-i-run-multiple-inter-canister-update-calls-in-parallel/13115/6">take about double that time</a>.</p>
<p>If you don't need to wait for your cross-canister call to return, you can use <code>notify</code>:</p>
<pre><code class="language-python">from kybra import (
    null,
    Principal,
    query,
    RejectionCode,
    Service,
    service_update,
    Variant,
    void,
)


class SomeCanister(Service):
    @service_update
    def receive_notification(self) -&gt; void:
        ...


some_canister = SomeCanister(Principal.from_str(&quot;ryjl3-tyaaa-aaaaa-aaaba-cai&quot;))


class ReceiveNotificationResult(Variant, total=False):
    Ok: null
    Err: RejectionCode


@query
def send_notification() -&gt; ReceiveNotificationResult:
    return some_canister.receive_notification().notify()
</code></pre>
<p>If you need to send cycles with your cross-canister call, you can call <code>with_cycles</code> before calling <code>call</code> or <code>notify</code>:</p>
<pre><code class="language-python">from kybra import (
    null,
    Principal,
    query,
    RejectionCode,
    Service,
    service_update,
    Variant,
    void,
)


class SomeCanister(Service):
    @service_update
    def receive_notification(self) -&gt; void:
        ...


some_canister = SomeCanister(Principal.from_str(&quot;ryjl3-tyaaa-aaaaa-aaaba-cai&quot;))


class ReceiveNotificationResult(Variant, total=False):
    Ok: null
    Err: RejectionCode


@query
def send_notification() -&gt; ReceiveNotificationResult:
    return some_canister.receive_notification().with_cycles(1_000_000).notify()
</code></pre>
<div style="break-before: page; page-break-before: always;"></div><h1 id="http"><a class="header" href="#http">HTTP</a></h1>
<p>This chapter is a work in progress.</p>
<h2 id="incoming-http-requests"><a class="header" href="#incoming-http-requests">Incoming HTTP requests</a></h2>
<p>Examples:</p>
<ul>
<li><a href="https://github.com/demergent-labs/kybra/tree/main/examples/motoko_examples/http_counter">http_counter</a></li>
</ul>
<pre><code class="language-python">from kybra import blob, Func, nat16, Opt, query, Query, Record, Tuple, Variant, Vec


class HttpRequest(Record):
    method: str
    url: str
    headers: Vec[&quot;Header&quot;]
    body: blob


class HttpResponse(Record):
    status_code: nat16
    headers: Vec[&quot;Header&quot;]
    body: blob
    streaming_strategy: Opt[&quot;StreamingStrategy&quot;]
    upgrade: Opt[bool]


Header = Tuple[str, str]


class StreamingStrategy(Variant):
    Callback: &quot;CallbackStrategy&quot;


class CallbackStrategy(Record):
    callback: &quot;Callback&quot;
    token: &quot;Token&quot;


Callback = Func(Query[[&quot;Token&quot;], &quot;StreamingCallbackHttpResponse&quot;])


class StreamingCallbackHttpResponse(Record):
    body: blob
    token: Opt[&quot;Token&quot;]


class Token(Record):
    arbitrary_data: str


@query
def http_request(req: HttpRequest) -&gt; HttpResponse:
    return {
        &quot;status_code&quot;: 200,
        &quot;headers&quot;: [],
        &quot;body&quot;: bytes(),
        &quot;streaming_strategy&quot;: None,
        &quot;upgrade&quot;: False,
    }
</code></pre>
<h2 id="outgoing-http-requests"><a class="header" href="#outgoing-http-requests">Outgoing HTTP requests</a></h2>
<p>Examples:</p>
<ul>
<li><a href="https://github.com/demergent-labs/kybra/tree/main/examples/ethereum_json_rpc">ethereum_json_rpc</a></li>
<li><a href="https://github.com/demergent-labs/kybra/tree/main/examples/outgoing_http_requests">outgoing_http_requests</a></li>
</ul>
<pre><code class="language-python">from kybra import (
    Alias,
    Async,
    CallResult,
    ic,
    match,
    init,
    nat32,
    query,
    StableBTreeMap,
    update,
    void,
)
from kybra.canisters.management import (
    HttpResponse,
    HttpTransformArgs,
    management_canister,
)

JSON = Alias[str]


stable_storage = StableBTreeMap[str, str](
    memory_id=3, max_key_size=20, max_value_size=1_000
)


@init
def init_(ethereum_url: str) -&gt; void:
    stable_storage.insert(&quot;ethereum_url&quot;, ethereum_url)


@update
def eth_get_balance(ethereum_address: str) -&gt; Async[JSON]:
    http_result: CallResult[HttpResponse] = yield management_canister.http_request(
        {
            &quot;url&quot;: stable_storage.get(&quot;ethereum_url&quot;) or &quot;&quot;,
            &quot;max_response_bytes&quot;: 2_000,
            &quot;method&quot;: {&quot;post&quot;: None},
            &quot;headers&quot;: [],
            &quot;body&quot;: f'{{&quot;jsonrpc&quot;:&quot;2.0&quot;,&quot;method&quot;:&quot;eth_getBalance&quot;,&quot;params&quot;:[&quot;{ethereum_address}&quot;,&quot;earliest&quot;],&quot;id&quot;:1}}'.encode(
                &quot;utf-8&quot;
            ),
            &quot;transform&quot;: {&quot;function&quot;: (ic.id(), &quot;eth_transform&quot;), &quot;context&quot;: bytes()},
        }
    ).with_cycles(50_000_000)

    return match(
        http_result,
        {&quot;Ok&quot;: lambda ok: ok[&quot;body&quot;].decode(&quot;utf-8&quot;), &quot;Err&quot;: lambda err: ic.trap(err)},
    )


@update
def eth_get_block_by_number(number: nat32) -&gt; Async[JSON]:
    http_result: CallResult[HttpResponse] = yield management_canister.http_request(
        {
            &quot;url&quot;: stable_storage.get(&quot;ethereum_url&quot;) or &quot;&quot;,
            &quot;max_response_bytes&quot;: 2_000,
            &quot;method&quot;: {&quot;post&quot;: None},
            &quot;headers&quot;: [],
            &quot;body&quot;: f'{{&quot;jsonrpc&quot;:&quot;2.0&quot;,&quot;method&quot;:&quot;eth_getBlockByNumber&quot;,&quot;params&quot;:[&quot;{hex(number)}&quot;, false],&quot;id&quot;:1}}'.encode(
                &quot;utf-8&quot;
            ),
            &quot;transform&quot;: {&quot;function&quot;: (ic.id(), &quot;eth_transform&quot;), &quot;context&quot;: bytes()},
        }
    ).with_cycles(50_000_000)

    return match(
        http_result,
        {&quot;Ok&quot;: lambda ok: ok[&quot;body&quot;].decode(&quot;utf-8&quot;), &quot;Err&quot;: lambda err: ic.trap(err)},
    )


@query
def eth_transform(args: HttpTransformArgs) -&gt; HttpResponse:
    http_response = args[&quot;response&quot;]

    http_response[&quot;headers&quot;] = []

    return http_response
</code></pre>
<div style="break-before: page; page-break-before: always;"></div><h1 id="management-canister"><a class="header" href="#management-canister">Management Canister</a></h1>
<p>This chapter is a work in progress.</p>
<p>You can access the management canister like this:</p>
<pre><code class="language-python">from kybra import Async, blob, CallResult, match, update, Variant
from kybra.canisters.management import management_canister


class RandomBytesResult(Variant, total=False):
    Ok: blob
    Err: str


@update
def random_bytes() -&gt; Async[RandomBytesResult]:
    call_result: CallResult[blob] = yield management_canister.raw_rand()

    return match(
        call_result, {&quot;Ok&quot;: lambda ok: {&quot;Ok&quot;: ok}, &quot;Err&quot;: lambda err: {&quot;Err&quot;: err}}
    )
</code></pre>
<p>See the <a href="https://github.com/demergent-labs/kybra/blob/main/kybra/canisters/management/__init__.py">management canister types</a> for all methods and their parameter and return types.</p>
<p>See the <a href="./reference/management_canister/management_canister.html">management canister reference section</a> for more information.</p>
<div style="break-before: page; page-break-before: always;"></div><h1 id="canister-lifecycle"><a class="header" href="#canister-lifecycle">Canister Lifecycle</a></h1>
<p>This chapter is a work in progress.</p>
<pre><code class="language-python">from kybra import ic, init, post_upgrade, pre_upgrade, void


@init
def init_() -&gt; void:
    ic.print(&quot;runs on first canister install&quot;)


@pre_upgrade
def pre_upgrade_() -&gt; void:
    ic.print(&quot;runs before canister upgrade&quot;)


@post_upgrade
def post_upgrade_() -&gt; void:
    ic.print(&quot;runs after canister upgrade&quot;)
</code></pre>
<div style="break-before: page; page-break-before: always;"></div><h1 id="timers"><a class="header" href="#timers">Timers</a></h1>
<p>This chapter is a work in progress.</p>
<pre><code class="language-python">from kybra import (
    Async,
    blob,
    CallResult,
    Duration,
    ic,
    match,
    nat8,
    query,
    Record,
    TimerId,
    update,
    void,
)
from kybra.canisters.management import management_canister


class StatusReport(Record):
    single: bool
    inline: nat8
    capture: str
    repeat: nat8
    single_cross_canister: blob
    repeat_cross_canister: blob


class TimerIds(Record):
    single: TimerId
    inline: TimerId
    capture: TimerId
    repeat: TimerId
    single_cross_canister: TimerId
    repeat_cross_canister: TimerId


status: StatusReport = {
    &quot;single&quot;: False,
    &quot;inline&quot;: 0,
    &quot;capture&quot;: &quot;&quot;,
    &quot;repeat&quot;: 0,
    &quot;single_cross_canister&quot;: bytes(),
    &quot;repeat_cross_canister&quot;: bytes(),
}


@update
def clear_timer(timer_id: TimerId) -&gt; void:
    ic.clear_timer(timer_id)
    ic.print(f&quot;timer {timer_id} cancelled&quot;)


@update
def set_timers(delay: Duration, interval: Duration) -&gt; TimerIds:
    captured_value = &quot;🚩&quot;

    single_id = ic.set_timer(delay, one_time_timer_callback)

    # Note: You cannot set global variables from within a lambda but you can
    # call a function that sets a global variable. So we've moved the &quot;setting&quot;
    # functionality out into helper functions while the printing is kept here in
    # the lambda.

    inline_id = ic.set_timer(
        delay,
        lambda: update_inline_status() or ic.print(&quot;Inline timer called&quot;),
    )

    capture_id = ic.set_timer(
        delay,
        lambda: update_capture_status(captured_value)
        or ic.print(f&quot;Timer captured value: {captured_value}&quot;),
    )

    repeat_id = ic.set_timer_interval(interval, repeat_timer_callback)

    single_cross_canister_id = ic.set_timer(delay, single_cross_canister_timer_callback)

    repeat_cross_canister_id = ic.set_timer_interval(
        interval, repeat_cross_canister_timer_callback
    )

    return {
        &quot;single&quot;: single_id,
        &quot;inline&quot;: inline_id,
        &quot;capture&quot;: capture_id,
        &quot;repeat&quot;: repeat_id,
        &quot;single_cross_canister&quot;: single_cross_canister_id,
        &quot;repeat_cross_canister&quot;: repeat_cross_canister_id,
    }


@query
def status_report() -&gt; StatusReport:
    return status


def one_time_timer_callback():
    status[&quot;single&quot;] = True
    ic.print(&quot;one_time_timer_callback called&quot;)


def repeat_timer_callback():
    status[&quot;repeat&quot;] += 1
    ic.print(f&quot;Repeating timer. Call {status['repeat']}&quot;)


def update_inline_status():
    status[&quot;inline&quot;] = 1


def update_capture_status(value: str):
    status[&quot;capture&quot;] = value


def single_cross_canister_timer_callback() -&gt; Async[void]:
    ic.print(&quot;single_cross_canister_timer_callback&quot;)

    result: CallResult[blob] = yield management_canister.raw_rand()

    def handle_ok(ok: blob):
        status[&quot;single_cross_canister&quot;] = ok

    match(result, {&quot;Ok&quot;: handle_ok, &quot;Err&quot;: lambda err: ic.print(err)})


def repeat_cross_canister_timer_callback() -&gt; Async[void]:
    ic.print(&quot;repeat_cross_canister_timer_callback&quot;)

    result: CallResult[blob] = yield management_canister.raw_rand()

    def handle_ok(ok: blob):
        status[&quot;repeat_cross_canister&quot;] += ok

    match(result, {&quot;Ok&quot;: handle_ok, &quot;Err&quot;: lambda err: ic.print(err)})
</code></pre>
<div style="break-before: page; page-break-before: always;"></div><h1 id="cycles"><a class="header" href="#cycles">Cycles</a></h1>
<p>This chapter is a work in progress.</p>
<p>Cycles are essentially units of computational resources such as bandwidth, memory, and CPU instructions. Costs are generally metered on the Internet Computer (IC) by cycles. You can see a breakdown of all cycle costs <a href="https://internetcomputer.org/docs/current/developer-docs/gas-cost">here</a>.</p>
<p>Currently queries do not have any cycle costs.</p>
<p>Most important to you will probably be update costs.</p>
<p>TODO break down some cycle scenarios maybe? Perhaps we should show some of our analyses for different types of applications. Maybe show how to send and receive cycles, exactly how to do it.</p>
<p>Show all of the APIs for sending or receiving cycles?</p>
<p>Perhaps we don't need to do that here, since each API will show this information.</p>
<p>Maybe here we just show the basic concept of cycles, link to the main cycles cost page, and show a few examples of how to break down these costs or estimate these costs.</p>
<div style="break-before: page; page-break-before: always;"></div><h1 id="caveats-1"><a class="header" href="#caveats-1">Caveats</a></h1>
<h2 id="unknown-security-vulnerabilities"><a class="header" href="#unknown-security-vulnerabilities">Unknown security vulnerabilities</a></h2>
<p>Kybra is a beta project using a new Python interpreter. See the <a href="./kybra.html#disclaimer">disclaimer</a> for more information.</p>
<h2 id="no-c-extensions"><a class="header" href="#no-c-extensions">No C extensions</a></h2>
<p>Any PyPI packages or other Python code that relies on C extensions will not currently work. It is a major goal for us to support C extensions in the future.</p>
<h2 id="performance"><a class="header" href="#performance">Performance</a></h2>
<p>Kybra is probably ~7-20x less performant than what you would expect from <a href="https://github.com/python/cpython">CPython</a>. We hope to eventually use <code>CPython</code> as Kybra's underlying Python interpreter.</p>
<h2 id="do-not-use-dictionary-unpacking"><a class="header" href="#do-not-use-dictionary-unpacking">Do not use dictionary unpacking</a></h2>
<p>A bug in the <a href="https://github.com/RustPython/RustPython">RustPython</a> interpreter means that dictionary unpacking should not be used until <a href="https://github.com/RustPython/RustPython/issues/4932">this issue</a> is addressed.</p>
<h2 id="reserved-memory-ids"><a class="header" href="#reserved-memory-ids">Reserved memory ids</a></h2>
<p><code>memory ids</code> <code>0</code>, <code>1</code>, <code>2</code>, and <code>254</code> are currently reserved for <code>StableBTreeMap</code>.</p>
<h2 id="print-does-not-work"><a class="header" href="#print-does-not-work">print does not work</a></h2>
<p>You should use <code>ic.print</code> instead of <code>print</code>.</p>
<h2 id="kybra-types"><a class="header" href="#kybra-types">Kybra types</a></h2>
<h3 id="imports"><a class="header" href="#imports">Imports</a></h3>
<p>Make sure to use the <code>from kybra</code> syntax when importing types from the <code>kybra</code> module, and to not rename types with <code>as</code>:</p>
<p>Correct:</p>
<pre><code class="language-python">from kybra import Record

class MyRecord(Record):
    prop1: str
    prop2: int
</code></pre>
<p>Incorrect:</p>
<pre><code class="language-python">import kybra

class MyRecord(kybra.Record):
    prop1: str
    prop2: int
</code></pre>
<p>Incorrect:</p>
<pre><code class="language-python">from kybra import Record as RenamedRecord

class MyRecord(RenamedRecord):
    prop1: str
    prop2: int
</code></pre>
<p>We wish to improve this situation in the future to handle the many various ways of importing.</p>
<h3 id="treatment-as-keywords"><a class="header" href="#treatment-as-keywords">Treatment as keywords</a></h3>
<p>You should treat Kybra types essentially as keywords, not creating types of the same name elsewhere in your codebase or in other libraries. Any types exported from <a href="https://github.com/demergent-labs/kybra/blob/main/kybra/__init__.py">this file</a> should be treated thusly.</p>
<div style="break-before: page; page-break-before: always;"></div><h1 id="reference"><a class="header" href="#reference">Reference</a></h1>
<ul>
<li><a href="reference/./call_apis/call_apis.html">Call APIs</a></li>
<li><a href="reference/./candid/candid.html">Candid</a></li>
<li><a href="reference/./canister_apis/canister_apis.html">Canister APIs</a></li>
<li><a href="reference/./canister_methods/canister_methods.html">Canister Methods</a></li>
<li><a href="reference/./guard_functions.html">Guard Functions</a></li>
<li><a href="reference/./management_canister/management_canister.html">Management Canister</a></li>
<li><a href="reference/./stable_memory/stable_memory.html">Stable Memory</a></li>
<li><a href="reference/./timers/timers.html">Timers</a></li>
</ul>
<div style="break-before: page; page-break-before: always;"></div><h1 id="call-apis"><a class="header" href="#call-apis">Call APIs</a></h1>
<ul>
<li><a href="reference/call_apis/./accept_message.html">accept message</a></li>
<li><a href="reference/call_apis/./arg_data_raw.html">arg data raw</a></li>
<li><a href="reference/call_apis/./arg_data_raw_size.html">arg data raw size</a></li>
<li><a href="reference/call_apis/./call.html">call</a></li>
<li><a href="reference/call_apis/./call_raw.html">call raw</a></li>
<li><a href="reference/call_apis/./call_raw128.html">call raw 128</a></li>
<li><a href="reference/call_apis/./call_with_payment.html">call with payment</a></li>
<li><a href="reference/call_apis/./call_with_payment128.html">call with payment 128</a></li>
<li><a href="reference/call_apis/./caller.html">caller</a></li>
<li><a href="reference/call_apis/./method_name.html">method name</a></li>
<li><a href="reference/call_apis/./msg_cycles_accept.html">msg cycles accept</a></li>
<li><a href="reference/call_apis/./msg_cycles_accept128.html">msg cycles accept 128</a></li>
<li><a href="reference/call_apis/./msg_cycles_available.html">msg cycles available</a></li>
<li><a href="reference/call_apis/./msg_cycles_available128.html">msg cycles available 128</a></li>
<li><a href="reference/call_apis/./msg_cycles_refunded.html">msg cycles refunded</a></li>
<li><a href="reference/call_apis/./msg_cycles_refunded128.html">msg cycles refunded 128</a></li>
<li><a href="reference/call_apis/./notify.html">notify</a></li>
<li><a href="reference/call_apis/./notify_raw.html">notify raw</a></li>
<li><a href="reference/call_apis/./notify_with_payment_128.html">notify with payment 128</a></li>
<li><a href="reference/call_apis/./performance_counter.html">performance counter</a></li>
<li><a href="reference/call_apis/./reject.html">reject</a></li>
<li><a href="reference/call_apis/./reject_code.html">reject code</a></li>
<li><a href="reference/call_apis/./reject_message.html">reject message</a></li>
<li><a href="reference/call_apis/./reply.html">reply</a></li>
<li><a href="reference/call_apis/./reply_raw.html">reply raw</a></li>
</ul>
<div style="break-before: page; page-break-before: always;"></div><h1 id="accept-message"><a class="header" href="#accept-message">accept message</a></h1>
<p>This section is a work in progress.</p>
<p>Examples:</p>
<ul>
<li><a href="https://github.com/demergent-labs/kybra/blob/main/examples/inspect_message/src/main.py">inspect_message</a></li>
</ul>
<pre><code class="language-python">from kybra import ic, inspect_message, void


@inspect_message
def inspect_message_() -&gt; void:
    ic.accept_message()
</code></pre>
<div style="break-before: page; page-break-before: always;"></div><h1 id="arg-data-raw"><a class="header" href="#arg-data-raw">arg data raw</a></h1>
<p>This section is a work in progress.</p>
<p>Examples:</p>
<ul>
<li><a href="https://github.com/demergent-labs/kybra/blob/main/examples/ic_api">ic_api</a></li>
</ul>
<pre><code class="language-python">from kybra import blob, ic, int8, query


# returns the argument data as bytes.
@query
def arg_data_raw(arg1: blob, arg2: int8, arg3: bool, arg4: str) -&gt; blob:
    return ic.arg_data_raw()
</code></pre>
<div style="break-before: page; page-break-before: always;"></div><h1 id="arg-data-raw-size"><a class="header" href="#arg-data-raw-size">arg data raw size</a></h1>
<p>This section is a work in progress.</p>
<p>Examples:</p>
<ul>
<li><a href="https://github.com/demergent-labs/kybra/blob/main/examples/ic_api">ic_api</a></li>
</ul>
<pre><code class="language-python">from kybra import blob, ic, int8, nat32, query


# returns the length of the argument data in bytes
@query
def arg_data_raw_size(arg1: blob, arg2: int8, arg3: bool, arg4: str) -&gt; nat32:
    return ic.arg_data_raw_size()
</code></pre>
<div style="break-before: page; page-break-before: always;"></div><h1 id="call"><a class="header" href="#call">call</a></h1>
<p>This section is a work in progress.</p>
<p>Examples:</p>
<ul>
<li><a href="https://github.com/demergent-labs/kybra/tree/main/examples/bitcoin">bitcoin</a></li>
<li><a href="https://github.com/demergent-labs/kybra/tree/main/examples/composite_queries">composite_queries</a></li>
<li><a href="https://github.com/demergent-labs/kybra/tree/main/examples/cross_canister_calls">cross_canister_calls</a></li>
<li><a href="https://github.com/demergent-labs/kybra/tree/main/examples/cycles">cycles</a></li>
<li><a href="https://github.com/demergent-labs/kybra/tree/main/examples/ethereum_json_rpc">ethereum_json_rpc</a></li>
<li><a href="https://github.com/demergent-labs/kybra/tree/main/examples/func_types">func_types</a></li>
<li><a href="https://github.com/demergent-labs/kybra/tree/main/examples/generators">generators</a></li>
<li><a href="https://github.com/demergent-labs/kybra/tree/main/examples/ledger_canister">ledger_canister</a></li>
<li><a href="https://github.com/demergent-labs/kybra/tree/main/examples/management_canister">management_canister</a></li>
<li><a href="https://github.com/demergent-labs/kybra/tree/main/examples/outgoing_http_requests">outgoing_http_requests</a></li>
<li><a href="https://github.com/demergent-labs/kybra/tree/main/examples/rejections">rejections</a></li>
<li><a href="https://github.com/demergent-labs/kybra/tree/main/examples/timers">timers</a></li>
<li><a href="https://github.com/demergent-labs/kybra/tree/main/examples/motoko_examples/whoami">whoami</a></li>
</ul>
<pre><code class="language-python">from kybra import (
    Async,
    CallResult,
    match,
    nat64,
    Principal,
    Service,
    service_update,
    update,
    Variant,
)


class TokenCanister(Service):
    @service_update
    def transfer(self, to: Principal, amount: nat64) -&gt; nat64:
        ...


token_canister = TokenCanister(Principal.from_str(&quot;r7inp-6aaaa-aaaaa-aaabq-cai&quot;))


class PayoutResult(Variant, total=False):
    Ok: nat64
    Err: str


@update
def payout(to: Principal, amount: nat64) -&gt; Async[PayoutResult]:
    result: CallResult[nat64] = yield token_canister.transfer(to, amount)

    return match(result, {&quot;Ok&quot;: lambda ok: {&quot;Ok&quot;: ok}, &quot;Err&quot;: lambda err: {&quot;Err&quot;: err}})
</code></pre>
<div style="break-before: page; page-break-before: always;"></div><h1 id="call-raw"><a class="header" href="#call-raw">call raw</a></h1>
<p>This section is a work in progress.</p>
<p>Examples:</p>
<ul>
<li><a href="https://github.com/demergent-labs/kybra/tree/main/examples/call_raw">call_raw</a></li>
<li><a href="https://github.com/demergent-labs/kybra/tree/main/examples/outgoing_http_requests">outgoing_http_requests</a></li>
</ul>
<pre><code class="language-python">from kybra import (
    Async,
    blob,
    CallResult,
    ic,
    match,
    nat64,
    Principal,
    update,
    Variant,
)


class ExecuteCallRawResult(Variant, total=False):
    Ok: str
    Err: str


@update
def execute_call_raw(
    canister_id: Principal, method: str, candid_args: str, payment: nat64
) -&gt; Async[ExecuteCallRawResult]:
    call_result: CallResult[blob] = yield ic.call_raw(
        canister_id, method, ic.candid_encode(candid_args), payment
    )

    return match(
        call_result,
        {
            &quot;Ok&quot;: lambda ok: {&quot;Ok&quot;: ic.candid_decode(ok)},
            &quot;Err&quot;: lambda err: {&quot;Err&quot;: err},
        },
    )
</code></pre>
<div style="break-before: page; page-break-before: always;"></div><h1 id="call-raw-128"><a class="header" href="#call-raw-128">call raw 128</a></h1>
<p>This section is a work in progress.</p>
<p>Examples:</p>
<ul>
<li><a href="https://github.com/demergent-labs/kybra/tree/main/examples/call_raw">call_raw</a></li>
</ul>
<pre><code class="language-python">from kybra import (
    Async,
    blob,
    CallResult,
    ic,
    match,
    nat,
    Principal,
    update,
    Variant,
)


class ExecuteCallRaw128Result(Variant, total=False):
    Ok: str
    Err: str


@update
def execute_call_raw128(
    canister_id: Principal, method: str, candid_args: str, payment: nat
) -&gt; Async[ExecuteCallRaw128Result]:
    call_result: CallResult[blob] = yield ic.call_raw128(
        canister_id, method, ic.candid_encode(candid_args), payment
    )

    return match(
        call_result,
        {
            &quot;Ok&quot;: lambda ok: {&quot;Ok&quot;: ic.candid_decode(ok)},
            &quot;Err&quot;: lambda err: {&quot;Err&quot;: err},
        },
    )
</code></pre>
<div style="break-before: page; page-break-before: always;"></div><h1 id="call-with-payment"><a class="header" href="#call-with-payment">call with payment</a></h1>
<p>This section is a work in progress.</p>
<p>Examples:</p>
<ul>
<li><a href="https://github.com/demergent-labs/kybra/tree/main/examples/bitcoin">bitcoin</a></li>
<li><a href="https://github.com/demergent-labs/kybra/tree/main/examples/cycles">cycles</a></li>
<li><a href="https://github.com/demergent-labs/kybra/tree/main/examples/ethereum_json_rpc">ethereum_json_rpc</a></li>
<li><a href="https://github.com/demergent-labs/kybra/tree/main/examples/management_canister">management_canister</a></li>
<li><a href="https://github.com/demergent-labs/kybra/tree/main/examples/outgoing_http_requests">outgoing_http_requests</a></li>
<li><a href="https://github.com/demergent-labs/kybra/tree/main/examples/motoko_examples/threshold_ecdsa">threshold_ecdsa</a></li>
</ul>
<pre><code class="language-python">from kybra import Async, blob, CallResult, match, Principal, update, Variant, void
from kybra.canisters.management import management_canister


class DefaultResult(Variant, total=False):
    Ok: bool
    Err: str


@update
def execute_install_code(
    canister_id: Principal, wasm_module: blob
) -&gt; Async[DefaultResult]:
    call_result: CallResult[void] = yield management_canister.install_code(
        {
            &quot;mode&quot;: {&quot;install&quot;: None},
            &quot;canister_id&quot;: canister_id,
            &quot;wasm_module&quot;: wasm_module,
            &quot;arg&quot;: bytes(),
        }
    ).with_cycles(100_000_000_000)

    return match(
        call_result, {&quot;Ok&quot;: lambda _: {&quot;Ok&quot;: True}, &quot;Err&quot;: lambda err: {&quot;Err&quot;: err}}
    )
</code></pre>
<div style="break-before: page; page-break-before: always;"></div><h1 id="call-with-payment-128"><a class="header" href="#call-with-payment-128">call with payment 128</a></h1>
<p>This section is a work in progress.</p>
<p>Examples:</p>
<ul>
<li><a href="https://github.com/demergent-labs/kybra/tree/main/examples/cycles">cycles</a></li>
</ul>
<pre><code class="language-python">from kybra import Async, blob, CallResult, match, Principal, update, Variant, void
from kybra.canisters.management import management_canister


class DefaultResult(Variant, total=False):
    Ok: bool
    Err: str


@update
def execute_install_code(
    canister_id: Principal, wasm_module: blob
) -&gt; Async[DefaultResult]:
    call_result: CallResult[void] = yield management_canister.install_code(
        {
            &quot;mode&quot;: {&quot;install&quot;: None},
            &quot;canister_id&quot;: canister_id,
            &quot;wasm_module&quot;: wasm_module,
            &quot;arg&quot;: bytes(),
        }
    ).with_cycles128(100_000_000_000)

    return match(
        call_result, {&quot;Ok&quot;: lambda _: {&quot;Ok&quot;: True}, &quot;Err&quot;: lambda err: {&quot;Err&quot;: err}}
    )
</code></pre>
<div style="break-before: page; page-break-before: always;"></div><h1 id="caller"><a class="header" href="#caller">caller</a></h1>
<p>This section is a work in progress.</p>
<p>Examples:</p>
<ul>
<li><a href="https://github.com/demergent-labs/kybra/tree/main/examples/ic_api">ic_api</a></li>
<li><a href="https://github.com/demergent-labs/kybra/tree/main/examples/motoko_examples/whoami">whoami</a></li>
</ul>
<pre><code class="language-python">from kybra import ic, Principal, query


# returns the principal of the identity that called this function
@query
def caller() -&gt; Principal:
    return ic.caller()
</code></pre>
<div style="break-before: page; page-break-before: always;"></div><h1 id="method-name"><a class="header" href="#method-name">method name</a></h1>
<p>This section is a work in progress.</p>
<p>Examples:</p>
<ul>
<li><a href="https://github.com/demergent-labs/kybra/tree/main/examples/inspect_message">inspect_message</a></li>
</ul>
<pre><code class="language-python">from kybra import ic, inspect_message, update, void


@inspect_message
def inspect_message_() -&gt; void:
    ic.print(&quot;inspect_message called&quot;)

    if ic.method_name() == &quot;accessible&quot;:
        ic.accept_message()
        return

    if ic.method_name() == &quot;inaccessible&quot;:
        return

    raise Exception(&quot;Method &quot; + ic.method_name() + &quot; is not allowed&quot;)


@update
def accessible() -&gt; bool:
    return True


@update
def inaccessible() -&gt; bool:
    return False


@update
def also_inaccessible() -&gt; bool:
    return False
</code></pre>
<div style="break-before: page; page-break-before: always;"></div><h1 id="msg-cycles-accept"><a class="header" href="#msg-cycles-accept">msg cycles accept</a></h1>
<p>This section is a work in progress.</p>
<p>Examples:</p>
<ul>
<li><a href="https://github.com/demergent-labs/kybra/tree/main/examples/cycles">cycles</a></li>
</ul>
<pre><code class="language-python">from kybra import ic, nat64, update


@update
def receive_cycles() -&gt; nat64:
    return ic.msg_cycles_accept(ic.msg_cycles_available() // 2)
</code></pre>
<div style="break-before: page; page-break-before: always;"></div><h1 id="msg-cycles-accept-128"><a class="header" href="#msg-cycles-accept-128">msg cycles accept 128</a></h1>
<p>This section is a work in progress.</p>
<p>Examples:</p>
<ul>
<li><a href="https://github.com/demergent-labs/kybra/tree/main/examples/cycles">cycles</a></li>
</ul>
<pre><code class="language-python">from kybra import ic, nat, update


@update
def receive_cycles128() -&gt; nat:
    return ic.msg_cycles_accept128(ic.msg_cycles_available128() // 2)
</code></pre>
<div style="break-before: page; page-break-before: always;"></div><h1 id="msg-cycles-available"><a class="header" href="#msg-cycles-available">msg cycles available</a></h1>
<p>This section is a work in progress.</p>
<p>Examples:</p>
<ul>
<li><a href="https://github.com/demergent-labs/kybra/tree/main/examples/cycles">cycles</a></li>
</ul>
<pre><code class="language-python">from kybra import ic, nat64, update


@update
def receive_cycles() -&gt; nat64:
    return ic.msg_cycles_accept(ic.msg_cycles_available() // 2)
</code></pre>
<div style="break-before: page; page-break-before: always;"></div><h1 id="msg-cycles-available-128"><a class="header" href="#msg-cycles-available-128">msg cycles available 128</a></h1>
<p>This section is a work in progress.</p>
<p>Examples:</p>
<ul>
<li><a href="https://github.com/demergent-labs/kybra/tree/main/examples/cycles">cycles</a></li>
</ul>
<pre><code class="language-python">from kybra import ic, nat, update


@update
def receive_cycles128() -&gt; nat:
    return ic.msg_cycles_accept128(ic.msg_cycles_available128() // 2)
</code></pre>
<div style="break-before: page; page-break-before: always;"></div><h1 id="msg-cycles-refunded"><a class="header" href="#msg-cycles-refunded">msg cycles refunded</a></h1>
<p>This section is a work in progress.</p>
<p>Examples:</p>
<ul>
<li><a href="https://github.com/demergent-labs/kybra/tree/main/examples/cycles">cycles</a></li>
</ul>
<pre><code class="language-python">from kybra import (
    Async,
    CallResult,
    ic,
    match,
    nat64,
    Principal,
    Service,
    service_update,
    update,
    Variant,
)


class SendCyclesResult(Variant, total=False):
    Ok: nat64
    Err: str


class Cycles(Service):
    @service_update
    def receive_cycles(self) -&gt; nat64:
        ...


cycles = Cycles(Principal.from_str(&quot;rrkah-fqaaa-aaaaa-aaaaq-cai&quot;))


# Reports the number of cycles returned from the Cycles canister
@update
def send_cycles() -&gt; Async[SendCyclesResult]:
    result: CallResult[nat64] = yield cycles.receive_cycles().with_cycles(1_000_000)
    return match(
        result,
        {
            &quot;Ok&quot;: lambda _: {&quot;Ok&quot;: ic.msg_cycles_refunded()},
            &quot;Err&quot;: lambda err: {&quot;Err&quot;: err},
        },
    )
</code></pre>
<div style="break-before: page; page-break-before: always;"></div><h1 id="msg-cycles-refunded-128"><a class="header" href="#msg-cycles-refunded-128">msg cycles refunded 128</a></h1>
<p>This section is a work in progress.</p>
<p>Examples:</p>
<ul>
<li><a href="https://github.com/demergent-labs/kybra/tree/main/examples/cycles">cycles</a></li>
</ul>
<pre><code class="language-python">from kybra import (
    Async,
    CallResult,
    ic,
    match,
    nat,
    Principal,
    Service,
    service_update,
    update,
    Variant,
)


class SendCyclesResult128(Variant, total=False):
    Ok: nat
    Err: str


class Cycles(Service):
    @service_update
    def receive_cycles128(self) -&gt; nat:
        ...


cycles = Cycles(Principal.from_str(&quot;rrkah-fqaaa-aaaaa-aaaaq-cai&quot;))


# Reports the number of cycles returned from the Cycles canister
@update
def send_cycles128() -&gt; Async[SendCyclesResult128]:
    result: CallResult[nat] = yield cycles.receive_cycles128().with_cycles128(1_000_000)

    return match(
        result,
        {
            &quot;Ok&quot;: lambda _: {&quot;Ok&quot;: ic.msg_cycles_refunded128()},
            &quot;Err&quot;: lambda err: {&quot;Err&quot;: err},
        },
    )
</code></pre>
<div style="break-before: page; page-break-before: always;"></div><h1 id="notify"><a class="header" href="#notify">notify</a></h1>
<p>This section is a work in progress.</p>
<p>Examples:</p>
<ul>
<li><a href="https://github.com/demergent-labs/kybra/tree/main/examples/cross_canister_calls">cross_canister_calls</a></li>
<li><a href="https://github.com/demergent-labs/kybra/tree/main/examples/cycles">cycles</a></li>
</ul>
<pre><code class="language-python">from kybra import NotifyResult, Principal, Service, service_update, update, void


class Canister2(Service):
    @service_update
    def receive_notification(self, message: str) -&gt; void:
        ...


canister2 = Canister2(Principal.from_str(&quot;ryjl3-tyaaa-aaaaa-aaaba-cai&quot;))


@update
def send_notification() -&gt; NotifyResult:
    return canister2.receive_notification(&quot;This is the notification&quot;).notify()
</code></pre>
<div style="break-before: page; page-break-before: always;"></div><h1 id="notify-raw"><a class="header" href="#notify-raw">notify raw</a></h1>
<p>This section is a work in progress.</p>
<p>Examples:</p>
<ul>
<li><a href="https://github.com/demergent-labs/kybra/tree/main/examples/notify_raw">notify_raw</a></li>
</ul>
<pre><code class="language-python">from kybra import ic, match, Principal, RejectionCode, update, Variant


class SendNotificationResult(Variant, total=False):
    Ok: bool
    Err: RejectionCode


@update
def send_notification() -&gt; SendNotificationResult:
    result = ic.notify_raw(
        Principal.from_str(&quot;ryjl3-tyaaa-aaaaa-aaaba-cai&quot;),
        &quot;receive_notification&quot;,
        ic.candid_encode(&quot;()&quot;),
        0,
    )

    return match(
        result, {&quot;Ok&quot;: lambda _: {&quot;Ok&quot;: True}, &quot;Err&quot;: lambda err: {&quot;Err&quot;: err}}
    )
</code></pre>
<div style="break-before: page; page-break-before: always;"></div><h1 id="notify-with-payment-128"><a class="header" href="#notify-with-payment-128">notify with payment 128</a></h1>
<p>This section is a work in progress.</p>
<p>Examples:</p>
<ul>
<li><a href="https://github.com/demergent-labs/kybra/tree/main/examples/cycles">cycles</a></li>
</ul>
<pre><code class="language-python">from kybra import nat, NotifyResult, Principal, Service, service_update, update


class Cycles(Service):
    @service_update
    def receive_cycles128(self) -&gt; nat:
        ...


cycles = Cycles(Principal.from_str(&quot;rrkah-fqaaa-aaaaa-aaaaq-cai&quot;))


@update
def send_cycles128_notify() -&gt; NotifyResult:
    return cycles.receive_cycles128().with_cycles128(1_000_000).notify()
</code></pre>
<div style="break-before: page; page-break-before: always;"></div><h1 id="performance-counter"><a class="header" href="#performance-counter">performance counter</a></h1>
<p>This section is a work in progress.</p>
<p>Examples:</p>
<ul>
<li><a href="https://github.com/demergent-labs/kybra/tree/main/examples/ic_api">ic_api</a></li>
</ul>
<pre><code class="language-python">from kybra import ic, nat64, query


@query
def performance_counter() -&gt; nat64:
    return ic.performance_counter(0)
</code></pre>
<div style="break-before: page; page-break-before: always;"></div><h1 id="reject"><a class="header" href="#reject">reject</a></h1>
<p>This section is a work in progress.</p>
<p>Examples:</p>
<ul>
<li><a href="https://github.com/demergent-labs/kybra/tree/main/examples/ic_api">ic_api</a></li>
<li><a href="https://github.com/demergent-labs/kybra/tree/main/examples/manual_reply">manual_reply</a></li>
<li><a href="https://github.com/demergent-labs/kybra/tree/main/examples/rejections">rejections</a></li>
</ul>
<pre><code class="language-python">from kybra import empty, ic, Manual, query


@query
def reject(message: str) -&gt; Manual[empty]:
    ic.reject(message)
</code></pre>
<div style="break-before: page; page-break-before: always;"></div><h1 id="reject-code"><a class="header" href="#reject-code">reject code</a></h1>
<p>This section is a work in progress.</p>
<p>Examples:</p>
<ul>
<li><a href="https://github.com/demergent-labs/kybra/tree/main/examples/rejections">rejections</a></li>
</ul>
<pre><code class="language-python">from kybra import (
    Async,
    ic,
    Principal,
    RejectionCode,
    Service,
    service_update,
    update,
    void,
)


class Nonexistent(Service):
    @service_update
    def method(self) -&gt; void:
        ...


nonexistent_canister = Nonexistent(Principal.from_str(&quot;rkp4c-7iaaa-aaaaa-aaaca-cai&quot;))


@update
def get_rejection_code_destination_invalid() -&gt; Async[RejectionCode]:
    yield nonexistent_canister.method()
    return ic.reject_code()
</code></pre>
<div style="break-before: page; page-break-before: always;"></div><h1 id="reject-message"><a class="header" href="#reject-message">reject message</a></h1>
<p>This section is a work in progress.</p>
<p>Examples:</p>
<ul>
<li><a href="https://github.com/demergent-labs/kybra/tree/main/examples/rejections">rejections</a></li>
</ul>
<pre><code class="language-python">from kybra import Async, ic, Principal, Service, service_update, update, void


class SomeService(Service):
    @service_update
    def reject(self, message: str) -&gt; void:
        ...


some_service = SomeService(Principal.from_str(&quot;rkp4c-7iaaa-aaaaa-aaaca-cai&quot;))


@update
def get_rejection_message(message: str) -&gt; Async[str]:
    yield some_service.reject(message)
    return ic.reject_message()
</code></pre>
<div style="break-before: page; page-break-before: always;"></div><h1 id="reply"><a class="header" href="#reply">reply</a></h1>
<p>This section is a work in progress.</p>
<p>Examples:</p>
<ul>
<li><a href="https://github.com/demergent-labs/kybra/tree/main/examples/composite_queries">composite_queries</a></li>
<li><a href="https://github.com/demergent-labs/kybra/tree/main/examples/manual_reply">manual_reply</a></li>
</ul>
<pre><code class="language-python">from kybra import blob, ic, Manual, update


@update
def update_blob() -&gt; Manual[blob]:
    ic.reply(bytes([83, 117, 114, 112, 114, 105, 115, 101, 33]))
</code></pre>
<div style="break-before: page; page-break-before: always;"></div><h1 id="reply-raw"><a class="header" href="#reply-raw">reply raw</a></h1>
<p>This section is a work in progress.</p>
<p>Examples:</p>
<ul>
<li><a href="https://github.com/demergent-labs/kybra/tree/main/examples/manual_reply">manual_reply</a></li>
<li><a href="https://github.com/demergent-labs/kybra/tree/main/examples/outgoing_http_requests">outgoing_http_requests</a></li>
</ul>
<pre><code class="language-python">from kybra import blob, ic, Manual, null, query, Record, Variant


class RawReply(Record):
    int: int
    text: str
    bool: bool
    blob: blob
    variant: &quot;Options&quot;


class Options(Variant, total=False):
    Small: null
    Medium: null
    Large: null


@query
def reply_raw() -&gt; Manual[RawReply]:
    ic.reply_raw(
        ic.candid_encode(
            '(record { &quot;int&quot; = 42; &quot;text&quot; = &quot;text&quot;; &quot;bool&quot; = true; &quot;blob&quot; = blob &quot;Surprise!&quot;; &quot;variant&quot; = variant { Medium } })'
        )
    )
</code></pre>
<div style="break-before: page; page-break-before: always;"></div><h1 id="candid-1"><a class="header" href="#candid-1">Candid</a></h1>
<ul>
<li><a href="reference/candid/./blob.html">blob</a></li>
<li><a href="reference/candid/./bool.html">bool</a></li>
<li><a href="reference/candid/./empty.html">empty</a></li>
<li><a href="reference/candid/./float32.html">float32</a></li>
<li><a href="reference/candid/./float64.html">float64</a></li>
<li><a href="reference/candid/./func.html">func</a></li>
<li><a href="reference/candid/./int.html">int</a></li>
<li><a href="reference/candid/./int8.html">int8</a></li>
<li><a href="reference/candid/./int16.html">int16</a></li>
<li><a href="reference/candid/./int32.html">int32</a></li>
<li><a href="reference/candid/./int64.html">int64</a></li>
<li><a href="reference/candid/./nat.html">nat</a></li>
<li><a href="reference/candid/./nat8.html">nat8</a></li>
<li><a href="reference/candid/./nat16.html">nat16</a></li>
<li><a href="reference/candid/./nat32.html">nat32</a></li>
<li><a href="reference/candid/./nat64.html">nat64</a></li>
<li><a href="reference/candid/./null.html">null</a></li>
<li><a href="reference/candid/./opt.html">opt</a></li>
<li><a href="reference/candid/./principal.html">principal</a></li>
<li><a href="reference/candid/./record.html">record</a></li>
<li><a href="reference/candid/./reserved.html">reserved</a></li>
<li><a href="reference/candid/./service.html">service</a></li>
<li><a href="reference/candid/./text.html">text</a></li>
<li><a href="reference/candid/./variant.html">variant</a></li>
<li><a href="reference/candid/./vec.html">vec</a></li>
</ul>
<div style="break-before: page; page-break-before: always;"></div><h1 id="blob-1"><a class="header" href="#blob-1">blob</a></h1>
<p>This section is a work in progress.</p>
<p>The Kybra type <code>blob</code> corresponds to the <a href="https://internetcomputer.org/docs/current/references/candid-ref#type-blob">Candid type blob</a> and will become a <a href="https://docs.python.org/3/library/stdtypes.html#bytes">Python bytes</a> at runtime.</p>
<p>Python:</p>
<pre><code class="language-python">from kybra import blob, ic, query


@query
def get_blob() -&gt; blob:
    return bytes([68, 73, 68, 76, 0, 0])


@query
def print_blob(blob: blob) -&gt; blob:
    ic.print(type(blob))
    return blob
</code></pre>
<p>Candid:</p>
<pre><code>service: {
    &quot;get_blob&quot;: () -&gt; (blob) query;
    &quot;print_blob&quot;: (blob) -&gt; (blob) query;
}
</code></pre>
<div style="break-before: page; page-break-before: always;"></div><h1 id="bool-1"><a class="header" href="#bool-1">bool</a></h1>
<p>This section is a work in progress.</p>
<p>The Python type <code>bool</code> corresponds to the <a href="https://internetcomputer.org/docs/current/references/candid-ref#type-bool">Candid type bool</a> and will become a <a href="https://docs.python.org/3/library/stdtypes.html#boolean-values">Python Boolean Value</a> at runtime.</p>
<p>Python:</p>
<pre><code class="language-python">from kybra import ic, query


@query
def get_bool() -&gt; bool:
    return True


@query
def print_bool(bool: bool) -&gt; bool:
    ic.print(type(bool))
    return bool
</code></pre>
<p>Candid:</p>
<pre><code>service: {
    &quot;get_bool&quot;: () -&gt; (bool) query;
    &quot;print_bool&quot;: (bool) -&gt; (bool) query;
}
</code></pre>
<div style="break-before: page; page-break-before: always;"></div><h1 id="empty-1"><a class="header" href="#empty-1">empty</a></h1>
<p>This section is a work in progress.</p>
<p>The Kybra type <code>empty</code> corresponds to the <a href="https://internetcomputer.org/docs/current/references/candid-ref#type-empty">Candid type empty</a> and has no Python value at runtime.</p>
<p>Python:</p>
<pre><code class="language-python">from kybra import empty, ic, query


def get_empty() -&gt; empty:
    raise Exception(&quot;Anything you want&quot;)


# Note: It is impossible to call this function because it requires an argument
# but there is no way to pass an &quot;empty&quot; value as an argument.
@query
def print_empty(empty: empty) -&gt; empty:
    ic.print(type(empty))
    raise Exception(&quot;Anything you want&quot;)
</code></pre>
<p>Candid:</p>
<pre><code>service: {
    &quot;get_empty&quot;: () -&gt; (empty) query;
    &quot;print_empty&quot;: (empty) -&gt; (empty) query;
}
</code></pre>
<div style="break-before: page; page-break-before: always;"></div><h1 id="float32-1"><a class="header" href="#float32-1">float32</a></h1>
<p>This section is a work in progress.</p>
<p>The Kybra type <code>float32</code> corresponds to the <a href="https://internetcomputer.org/docs/current/references/candid-ref#type-float32-and-float64">Candid type float32</a> and will become a <a href="https://docs.python.org/3/library/functions.html#float">Python float</a> at runtime.</p>
<p>Python:</p>
<pre><code class="language-python">import math

from kybra import float32, ic, query


@query
def get_float32() -&gt; float32:
    return math.pi


@query
def print_float32(float32: float32) -&gt; float32:
    ic.print(type(float32))
    return float32
</code></pre>
<p>Candid:</p>
<pre><code>service: {
    &quot;get_float32&quot;: () -&gt; (float32) query;
    &quot;print_float32&quot;: (float32) -&gt; (float32) query;
}
</code></pre>
<div style="break-before: page; page-break-before: always;"></div><h1 id="float64-1"><a class="header" href="#float64-1">float64</a></h1>
<p>This section is a work in progress.</p>
<p>The Kybra type <code>float64</code> corresponds to the <a href="https://internetcomputer.org/docs/current/references/candid-ref#type-float32-and-float64">Candid type float64</a> and will become a <a href="https://docs.python.org/3/library/functions.html#float">Python float</a> at runtime.</p>
<p>Python:</p>
<pre><code class="language-python">import math

from kybra import float64, ic, query


@query
def get_float64() -&gt; float64:
    return math.e


@query
def print_float64(float64: float64) -&gt; float64:
    ic.print(type(float64))
    return float64
</code></pre>
<p>Candid:</p>
<pre><code>service: {
    &quot;get_float64&quot;: () -&gt; (float64) query;
    &quot;print_float64&quot;: (float64) -&gt; (float64) query;
}
</code></pre>
<div style="break-before: page; page-break-before: always;"></div><h1 id="func-1"><a class="header" href="#func-1">func</a></h1>
<p>This section is a work in progress.</p>
<p>The Kybra type <code>Func</code> corresponds to the <a href="https://internetcomputer.org/docs/current/references/candid-ref#type-func---">Candid type func</a> and at runtime will become a Python tuple with two elements, the first being an <a href="https://github.com/rocklabs-io/ic-py">ic-py Principal</a> and the second being a <a href="https://docs.python.org/3/library/stdtypes.html#textseq">Python str</a>. The <code>ic-py Principal</code> represents the <code>principal</code> of the canister/service where the function exists, and the <code>str</code> represents the function's name.</p>
<p>Python:</p>
<pre><code class="language-python">from kybra import Func, nat64, null, Principal, query, Query, Record, Update, Variant


class User(Record):
    id: str
    basic_func: &quot;BasicFunc&quot;
    complex_func: &quot;ComplexFunc&quot;


class Reaction(Variant, total=False):
    Good: null
    Bad: null
    BasicFunc: &quot;BasicFunc&quot;
    ComplexFunc: &quot;ComplexFunc&quot;


BasicFunc = Func(Query[[str], str])
ComplexFunc = Func(Update[[User, Reaction], nat64])


@query
def get_basic_func() -&gt; BasicFunc:
    return (Principal.from_str(&quot;rrkah-fqaaa-aaaaa-aaaaq-cai&quot;), &quot;simple_function_name&quot;)


@query
def get_complex_func() -&gt; ComplexFunc:
    return (Principal.from_str(&quot;ryjl3-tyaaa-aaaaa-aaaba-cai&quot;), &quot;complex_function_name&quot;)
</code></pre>
<p>Candid:</p>
<pre><code>type User = record {
    &quot;id&quot;: text;
    &quot;basic_func&quot;: BasicFunc;
    &quot;complex_func&quot;: ComplexFunc;
};
type Reaction = variant { &quot;Good&quot;: null; &quot;Bad&quot;: null; &quot;BasicFunc&quot;: BasicFunc; &quot;ComplexFunc&quot;: ComplexFunc };

type BasicFunc = func (text) -&gt; (text) query;
type ComplexFunc = func (User, Reaction) -&gt; (nat64);

service: () -&gt; {
    &quot;get_basic_func&quot;: () -&gt; (BasicFunc) query;
    &quot;get_complex_func&quot;: () -&gt; (ComplexFunc) query;
}
</code></pre>
<div style="break-before: page; page-break-before: always;"></div><h1 id="int-1"><a class="header" href="#int-1">int</a></h1>
<p>This section is a work in progress.</p>
<p>The Kybra type <code>int</code> corresponds to the <a href="https://internetcomputer.org/docs/current/references/candid-ref#type-int">Candid type int</a> and will become a <a href="https://docs.python.org/3/library/functions.html#int">Python int</a> at runtime.</p>
<p>Python:</p>
<pre><code class="language-python">from kybra import ic, query


@query
def get_int() -&gt; int:
    return 170_141_183_460_469_231_731_687_303_715_884_105_727


@query
def print_int(int: int) -&gt; int:
    ic.print(type(int))
    return int
</code></pre>
<p>Candid:</p>
<pre><code>service: {
    &quot;get_int&quot;: () -&gt; (int) query;
    &quot;print_int&quot;: (int) -&gt; (int) query;
}
</code></pre>
<div style="break-before: page; page-break-before: always;"></div><h1 id="int8-1"><a class="header" href="#int8-1">int8</a></h1>
<p>This section is a work in progress.</p>
<p>The Kybra type <code>int8</code> corresponds to the <a href="https://internetcomputer.org/docs/current/references/candid-ref#type-natn-and-intn">Candid type int8</a> and will become a <a href="https://docs.python.org/3/library/functions.html#int">Python int</a> at runtime.</p>
<p>Python:</p>
<pre><code class="language-python">from kybra import ic, int8, query


@query
def get_int8() -&gt; int8:
    return 127


@query
def print_int8(int8: int8) -&gt; int8:
    ic.print(type(int8))
    return int8
</code></pre>
<p>Candid:</p>
<pre><code>service: {
    &quot;get_int8&quot;: () -&gt; (int8) query;
    &quot;print_int8&quot;: (int8) -&gt; (int8) query;
}
</code></pre>
<div style="break-before: page; page-break-before: always;"></div><h1 id="int16-1"><a class="header" href="#int16-1">int16</a></h1>
<p>This section is a work in progress.</p>
<p>The Kybra type <code>int16</code> corresponds to the <a href="https://internetcomputer.org/docs/current/references/candid-ref#type-natn-and-intn">Candid type int16</a> and will become a <a href="https://docs.python.org/3/library/functions.html#int">Python int</a> at runtime.</p>
<p>Python:</p>
<pre><code class="language-python">from kybra import ic, int16, query


@query
def get_int16() -&gt; int16:
    return 32_767


@query
def print_int16(int16: int16) -&gt; int16:
    ic.print(type(int16))
    return int16
</code></pre>
<p>Candid:</p>
<pre><code>service: {
    &quot;get_int16&quot;: () -&gt; (int16) query;
    &quot;print_int16&quot;: (int16) -&gt; (int16) query;
}
</code></pre>
<div style="break-before: page; page-break-before: always;"></div><h1 id="int32-1"><a class="header" href="#int32-1">int32</a></h1>
<p>This section is a work in progress.</p>
<p>The Kybra type <code>int32</code> corresponds to the <a href="https://internetcomputer.org/docs/current/references/candid-ref#type-natn-and-intn">Candid type int32</a> and will become a <a href="https://docs.python.org/3/library/functions.html#int">Python int</a> at runtime.</p>
<p>Python:</p>
<pre><code class="language-python">from kybra import ic, int32, query


@query
def get_int32() -&gt; int32:
    return 2_147_483_647


@query
def print_int32(int32: int32) -&gt; int32:
    ic.print(type(int32))
    return int32
</code></pre>
<p>Candid:</p>
<pre><code>service: {
    &quot;get_int32&quot;: () -&gt; (int32) query;
    &quot;print_int32&quot;: (int32) -&gt; (int32) query;
}
</code></pre>
<div style="break-before: page; page-break-before: always;"></div><h1 id="int64-1"><a class="header" href="#int64-1">int64</a></h1>
<p>This section is a work in progress.</p>
<p>The Kybra type <code>int64</code> corresponds to the <a href="https://internetcomputer.org/docs/current/references/candid-ref#type-natn-and-intn">Candid type int64</a> and will become a <a href="https://docs.python.org/3/library/functions.html#int">Python int</a> at runtime.</p>
<p>Python:</p>
<pre><code class="language-python">from kybra import ic, int64, query


@query
def get_int64() -&gt; int64:
    return 9_223_372_036_854_775_807


@query
def print_int64(int64: int64) -&gt; int64:
    ic.print(type(int64))
    return int64
</code></pre>
<p>Candid:</p>
<pre><code>service: {
    &quot;get_int64&quot;: () -&gt; (int64) query;
    &quot;print_int64&quot;: (int64) -&gt; (int64) query;
}
</code></pre>
<div style="break-before: page; page-break-before: always;"></div><h1 id="nat-1"><a class="header" href="#nat-1">nat</a></h1>
<p>This section is a work in progress.</p>
<p>The Kybra type <code>nat</code> corresponds to the <a href="https://internetcomputer.org/docs/current/references/candid-ref#type-nat">Candid type nat</a> and will become a <a href="https://docs.python.org/3/library/functions.html#int">Python int</a> at runtime.</p>
<p>Python:</p>
<pre><code class="language-python">from kybra import ic, nat, query


@query
def get_nat() -&gt; nat:
    return 340_282_366_920_938_463_463_374_607_431_768_211_455


@query
def print_nat(nat: nat) -&gt; nat:
    ic.print(type(nat))
    return nat
</code></pre>
<p>Candid:</p>
<pre><code>service: {
    &quot;get_nat&quot;: () -&gt; (nat) query;
    &quot;print_nat&quot;: (nat) -&gt; (nat) query;
}
</code></pre>
<div style="break-before: page; page-break-before: always;"></div><h1 id="nat8-1"><a class="header" href="#nat8-1">nat8</a></h1>
<p>This section is a work in progress.</p>
<p>The Kybra type <code>nat8</code> corresponds to the <a href="https://internetcomputer.org/docs/current/references/candid-ref#type-natn-and-intn">Candid type nat8</a> and will become a <a href="https://docs.python.org/3/library/functions.html#int">Python int</a> at runtime.</p>
<p>Python:</p>
<pre><code class="language-python">from kybra import ic, nat8, query


@query
def get_nat8() -&gt; nat8:
    return 255


@query
def print_nat8(nat8: nat8) -&gt; nat8:
    ic.print(type(nat8))
    return nat8
</code></pre>
<p>Candid:</p>
<pre><code>service: {
    &quot;get_nat8&quot;: () -&gt; (nat8) query;
    &quot;print_nat8&quot;: (nat8) -&gt; (nat8) query;
}
</code></pre>
<div style="break-before: page; page-break-before: always;"></div><h1 id="nat16-1"><a class="header" href="#nat16-1">nat16</a></h1>
<p>This section is a work in progress.</p>
<p>The Kybra type <code>nat16</code> corresponds to the <a href="https://internetcomputer.org/docs/current/references/candid-ref#type-natn-and-intn">Candid type nat16</a> and will become a <a href="https://docs.python.org/3/library/functions.html#int">Python int</a> at runtime.</p>
<p>Python:</p>
<pre><code class="language-python">from kybra import ic, nat16, query


@query
def get_nat16() -&gt; nat16:
    return 65_535


@query
def print_nat16(nat16: nat16) -&gt; nat16:
    ic.print(type(nat16))
    return nat16
</code></pre>
<p>Candid:</p>
<pre><code>service: {
    &quot;get_nat16&quot;: () -&gt; (nat16) query;
    &quot;print_nat16&quot;: (nat16) -&gt; (nat16) query;
}
</code></pre>
<div style="break-before: page; page-break-before: always;"></div><h1 id="nat32-1"><a class="header" href="#nat32-1">nat32</a></h1>
<p>This section is a work in progress.</p>
<p>The Kybra type <code>nat32</code> corresponds to the <a href="https://internetcomputer.org/docs/current/references/candid-ref#type-natn-and-intn">Candid type nat32</a> and will become a <a href="https://docs.python.org/3/library/functions.html#int">Python int</a> at runtime.</p>
<p>Python:</p>
<pre><code class="language-python">from kybra import ic, nat32, query


@query
def get_nat32() -&gt; nat32:
    return 4_294_967_295


@query
def print_nat32(nat32: nat32) -&gt; nat32:
    ic.print(type(nat32))
    return nat32
</code></pre>
<p>Candid:</p>
<pre><code>service: {
    &quot;get_nat32&quot;: () -&gt; (nat32) query;
    &quot;print_nat32&quot;: (nat32) -&gt; (nat32) query;
}
</code></pre>
<div style="break-before: page; page-break-before: always;"></div><h1 id="nat64-1"><a class="header" href="#nat64-1">nat64</a></h1>
<p>This section is a work in progress.</p>
<p>The Kybra type <code>nat64</code> corresponds to the <a href="https://internetcomputer.org/docs/current/references/candid-ref#type-natn-and-intn">Candid type nat64</a> and will become a <a href="https://docs.python.org/3/library/functions.html#int">Python int</a> at runtime.</p>
<p>Python:</p>
<pre><code class="language-python">from kybra import ic, nat64, query


@query
def get_nat64() -&gt; nat64:
    return 18_446_744_073_709_551_615


@query
def print_nat64(nat64: nat64) -&gt; nat64:
    ic.print(type(nat64))
    return nat64
</code></pre>
<p>Candid:</p>
<pre><code>service: {
    &quot;get_nat64&quot;: () -&gt; (nat64) query;
    &quot;print_nat64&quot;: (nat64) -&gt; (nat64) query;
}
</code></pre>
<div style="break-before: page; page-break-before: always;"></div><h1 id="null-1"><a class="header" href="#null-1">null</a></h1>
<p>This section is a work in progress.</p>
<p>The Python type <code>None</code> and the Kybra type <code>null</code> both correspond to the <a href="https://internetcomputer.org/docs/current/references/candid-ref#type-null">Candid type null</a> and will become the <a href="https://docs.python.org/3/library/stdtypes.html#the-null-object">Python Null Object</a> at runtime.</p>
<p>Python:</p>
<pre><code class="language-python">from kybra import ic, query


@query
def get_null() -&gt; None:
    return None


@query
def print_null(none: None) -&gt; None:
    ic.print(type(none))
    return none
</code></pre>
<p>Candid:</p>
<pre><code>service: {
    &quot;get_null&quot;: () -&gt; (null) query;
    &quot;print_null&quot;: (null) -&gt; (null) query;
}
</code></pre>
<div style="break-before: page; page-break-before: always;"></div><h1 id="opt-1"><a class="header" href="#opt-1">opt</a></h1>
<p>This section is a work in progress.</p>
<p>The Kybra type <code>Opt</code> corresponds to the <a href="https://internetcomputer.org/docs/current/references/candid-ref#type-opt-t">Candid type opt</a> and will become the enclosed Python type or None at runtime.</p>
<p>Python:</p>
<pre><code class="language-python">from kybra import Opt, query


@query
def get_opt_some() -&gt; Opt[bool]:
    return True


@query
def get_opt_none() -&gt; Opt[bool]:
    return None
</code></pre>
<p>Candid:</p>
<pre><code>service: {
    &quot;get_opt_some&quot;: () -&gt; (opt bool) query;
    &quot;get_opt_none&quot;: () -&gt; (opt bool) query;
}
</code></pre>
<div style="break-before: page; page-break-before: always;"></div><h1 id="principal-1"><a class="header" href="#principal-1">principal</a></h1>
<p>This section is a work in progress.</p>
<p>The Kybra type <code>Principal</code> corresponds to the <a href="https://internetcomputer.org/docs/current/references/candid-ref#type-principal">Candid type principal</a> and will become an <a href="https://github.com/rocklabs-io/ic-py">ic-py Principal</a> at runtime.</p>
<p>Python:</p>
<pre><code class="language-python">from kybra import ic, Principal, query


@query
def get_principal() -&gt; Principal:
    return Principal.from_str(&quot;rrkah-fqaaa-aaaaa-aaaaq-cai&quot;)


@query
def print_principal(principal: Principal) -&gt; Principal:
    ic.print(type(principal))
    return principal
</code></pre>
<p>Candid:</p>
<pre><code>service: {
    &quot;get_principal&quot;: () -&gt; (principal) query;
    &quot;print_principal&quot;: (principal) -&gt; (principal) query;
}
</code></pre>
<div style="break-before: page; page-break-before: always;"></div><h1 id="record-1"><a class="header" href="#record-1">record</a></h1>
<p>This section is a work in progress.</p>
<p>Python classes that inherit from the Kybra type <code>Record</code> correspond to the <a href="https://internetcomputer.org/docs/current/references/candid-ref#type-record--n--t--">Candid record type</a> and will become <a href="https://docs.python.org/3/library/typing.html#typing.TypedDict">Python TypedDicts</a> at runtime.</p>
<p>Python:</p>
<pre><code class="language-python">from kybra import Record, Vec


class Post(Record):
    id: str
    author: &quot;User&quot;
    text: str
    thread: &quot;Thread&quot;


class Thread(Record):
    id: str
    author: &quot;User&quot;
    posts: Vec[Post]
    title: str


class User(Record):
    id: str
    posts: Vec[Post]
    thread: Vec[Thread]
    username: str
</code></pre>
<p>Candid:</p>
<pre><code>type Post = record {
    &quot;id&quot;: text;
    &quot;author&quot;: User;
    &quot;text&quot;: text;
    &quot;thread&quot;: Thread;
};

type Thread = record {
    &quot;id&quot;: text;
    &quot;author&quot;: User;
    &quot;posts&quot;: vec Post;
    &quot;title&quot;: text;
};

type User = record {
    &quot;id&quot;: text;
    &quot;posts&quot;: vec Post;
    &quot;threads&quot;: vec Thread;
    &quot;username&quot;: text;
};
</code></pre>
<div style="break-before: page; page-break-before: always;"></div><h1 id="reserved-1"><a class="header" href="#reserved-1">reserved</a></h1>
<p>This section is a work in progress.</p>
<p>The Kybra type <code>reserved</code> corresponds to the <a href="https://internetcomputer.org/docs/current/references/candid-ref#type-reserved">Candid type reserved</a> and will become the <a href="https://docs.python.org/3/library/stdtypes.html#the-null-object">Python Null Object</a> at runtime.</p>
<p>Python:</p>
<pre><code class="language-python">from kybra import ic, query, reserved


@query
def get_reserved() -&gt; reserved:
    return &quot;anything&quot;


@query
def print_reserved(reserved: reserved) -&gt; reserved:
    ic.print(type(reserved))
    return reserved
</code></pre>
<p>Candid:</p>
<pre><code>service: {
    &quot;get_reserved&quot;: () -&gt; (reserved) query;
    &quot;print_reserved&quot;: (reserved) -&gt; (reserved) query;
}
</code></pre>
<div style="break-before: page; page-break-before: always;"></div><h1 id="service-1"><a class="header" href="#service-1">service</a></h1>
<p>This section is a work in progress.</p>
<p>Python classes that inherit from the Kybra type <code>Service</code> correspond to the <a href="https://internetcomputer.org/docs/current/references/candid-ref#type-service-">Candid service type</a> and will become child classes capable of creating instances that can perform cross-canister calls at runtime.</p>
<p>Python:</p>
<pre><code class="language-python">from kybra import (
    Async,
    CallResult,
    Principal,
    query,
    Service,
    service_query,
    service_update,
    update,
)


class SomeService(Service):
    @service_query
    def query1(self) -&gt; bool:
        ...

    @service_update
    def update1(self) -&gt; str:
        ...


@query
def get_service() -&gt; SomeService:
    return SomeService(Principal.from_str(&quot;aaaaa-aa&quot;))


@update
def call_service(service: SomeService) -&gt; Async[str]:
    result: CallResult[str] = yield service.update1()

    if result.Err is not None:
        raise Exception(f&quot;call to service.update1 failed with: {result.Err}&quot;)

    return result.Ok
</code></pre>
<p>Candid:</p>
<pre><code>service { query1 : () -&gt; (bool) query; update1 : () -&gt; (text) }
</code></pre>
<div style="break-before: page; page-break-before: always;"></div><h1 id="text-1"><a class="header" href="#text-1">text</a></h1>
<p>This section is a work in progress.</p>
<p>The Python type <code>str</code> and the Kybra type <code>text</code> both correspond to the <a href="https://internetcomputer.org/docs/current/references/candid-ref#type-text">Candid type text</a> and will become a <a href="https://docs.python.org/3/library/stdtypes.html#textseq">Python str</a> at runtime.</p>
<p>Python:</p>
<pre><code class="language-python">from kybra import ic, query


@query
def get_string() -&gt; str:
    return &quot;Hello world!&quot;


@query
def print_string(string: str) -&gt; str:
    ic.print(type(string))
    return string

</code></pre>
<p>Candid:</p>
<pre><code>service: {
    &quot;get_string&quot;: () -&gt; (text) query;
    &quot;print_string&quot;: (text) -&gt; (text) query;
}
</code></pre>
<div style="break-before: page; page-break-before: always;"></div><h1 id="variant-1"><a class="header" href="#variant-1">variant</a></h1>
<p>This section is a work in progress.</p>
<p>Python classes that inherit from the Kybra type <code>Variant</code> correspond to the <a href="https://internetcomputer.org/docs/current/references/candid-ref#type-variant--n--t--">Candid variant type</a> and will become <a href="https://docs.python.org/3/library/typing.html#typing.TypedDict">Python TypedDicts</a> at runtime.</p>
<p>Python:</p>
<pre><code class="language-python">from kybra import nat32, Variant


class ReactionType(Variant, total=False):
    Fire: None
    ThumbsUp: None
    ThumbsDown: None
    Emotion: &quot;Emotion&quot;
    Firework: &quot;Firework&quot;


class Emotion(Variant, total=False):
    Happy: None
    Sad: None


class Firework(Variant, total=False):
    Color: str
    NumStreaks: nat32
</code></pre>
<p>Candid:</p>
<pre><code>type ReactionType = variant {
    &quot;Fire&quot;: null;
    &quot;ThumbsUp&quot;: null;
    &quot;ThumbsDown&quot;: null;
    &quot;Emotion&quot;: Emotion;
    &quot;Firework&quot;: Firework
};

type Emotion = variant {
    &quot;Happy&quot;: null;
    &quot;Sad&quot;: null
};

type Firework = record {
    &quot;Color&quot;: text;
    &quot;NumStreaks&quot;: nat32;
};
</code></pre>
<div style="break-before: page; page-break-before: always;"></div><h1 id="vec-1"><a class="header" href="#vec-1">vec</a></h1>
<p>This section is a work in progress.</p>
<p>The Kybra type <code>Vec</code> corresponds to the <a href="https://internetcomputer.org/docs/current/references/candid-ref#type-vec-t">Candid type vec</a> and will become an array of the specified type at runtime.</p>
<p>Python:</p>
<pre><code class="language-python">from kybra import int32, query, Vec


@query
def get_numbers() -&gt; Vec[int32]:
    return [0, 1, 2, 3]
</code></pre>
<p>Candid:</p>
<pre><code>service: {
    &quot;get_numbers&quot;: () -&gt; (vec int32) query;
}
</code></pre>
<div style="break-before: page; page-break-before: always;"></div><h1 id="canister-apis"><a class="header" href="#canister-apis">Canister APIs</a></h1>
<ul>
<li><a href="reference/canister_apis/./candid_decode.html">candid decode</a></li>
<li><a href="reference/canister_apis/./candid_encode.html">candid encode</a></li>
<li><a href="reference/canister_apis/./canister_balance.html">canister balance</a></li>
<li><a href="reference/canister_apis/./canister_balance128.html">canister balance 128</a></li>
<li><a href="reference/canister_apis/./canister_id.html">canister id</a></li>
<li><a href="reference/canister_apis/./data_certificate.html">data certificate</a></li>
<li><a href="reference/canister_apis/./print.html">print</a></li>
<li><a href="reference/canister_apis/./set_certified_data.html">set certified data</a></li>
<li><a href="reference/canister_apis/./time.html">time</a></li>
<li><a href="reference/canister_apis/./trap.html">trap</a></li>
</ul>
<div style="break-before: page; page-break-before: always;"></div><h1 id="candid-decode"><a class="header" href="#candid-decode">candid decode</a></h1>
<p>This section is a work in progress.</p>
<p>Examples:</p>
<ul>
<li><a href="https://github.com/demergent-labs/kybra/tree/main/examples/call_raw">call_raw</a></li>
<li><a href="https://github.com/demergent-labs/kybra/tree/main/examples/candid_encoding">candid_encoding</a></li>
</ul>
<pre><code class="language-python">from kybra import blob, ic, query


# decodes Candid bytes to a Candid string
@query
def candid_decode(candid_encoded: blob) -&gt; str:
    return ic.candid_decode(candid_encoded)
</code></pre>
<div style="break-before: page; page-break-before: always;"></div><h1 id="candid-encode"><a class="header" href="#candid-encode">candid encode</a></h1>
<p>This section is a work in progress.</p>
<p>Examples:</p>
<ul>
<li><a href="https://github.com/demergent-labs/kybra/tree/main/examples/call_raw">call_raw</a></li>
<li><a href="https://github.com/demergent-labs/kybra/tree/main/examples/candid_encoding">candid_encoding</a></li>
<li><a href="https://github.com/demergent-labs/kybra/tree/main/examples/manual_reply">manual_reply</a></li>
<li><a href="https://github.com/demergent-labs/kybra/tree/main/examples/notify_raw">notify_raw</a></li>
<li><a href="https://github.com/demergent-labs/kybra/tree/main/examples/outgoing_http_requests">outgoing_http_requests</a></li>
</ul>
<pre><code class="language-python">from kybra import blob, ic, query


# encodes a Candid string to Candid bytes
@query
def candid_encode(candid_string: str) -&gt; blob:
    return ic.candid_encode(candid_string)
</code></pre>
<div style="break-before: page; page-break-before: always;"></div><h1 id="canister-balance"><a class="header" href="#canister-balance">canister balance</a></h1>
<p>This section is a work in progress.</p>
<p>Examples:</p>
<ul>
<li><a href="https://github.com/demergent-labs/kybra/tree/main/examples/cycles">cycles</a></li>
<li><a href="https://github.com/demergent-labs/kybra/tree/main/examples/ic_api">ic_api</a></li>
</ul>
<pre><code class="language-python">from kybra import ic, nat64, query


# returns the amount of cycles available in the canister
@query
def canister_balance() -&gt; nat64:
    return ic.canister_balance()
</code></pre>
<div style="break-before: page; page-break-before: always;"></div><h1 id="canister-balance-128"><a class="header" href="#canister-balance-128">canister balance 128</a></h1>
<p>This section is a work in progress.</p>
<p>Examples:</p>
<ul>
<li><a href="https://github.com/demergent-labs/kybra/tree/main/examples/cycles">cycles</a></li>
<li><a href="https://github.com/demergent-labs/kybra/tree/main/examples/ic_api">ic_api</a></li>
</ul>
<pre><code class="language-python">from kybra import ic, nat, query


# returns the amount of cycles available in the canister
@query
def canister_balance128() -&gt; nat:
    return ic.canister_balance128()
</code></pre>
<div style="break-before: page; page-break-before: always;"></div><h1 id="canister-id"><a class="header" href="#canister-id">canister id</a></h1>
<p>This section is a work in progress.</p>
<p>Examples:</p>
<ul>
<li><a href="https://github.com/demergent-labs/kybra/tree/main/examples/ethereum_json_rpc">ethereum_json_rpc</a></li>
<li><a href="https://github.com/demergent-labs/kybra/tree/main/examples/ic_api">ic_api</a></li>
<li><a href="https://github.com/demergent-labs/kybra/tree/main/examples/motoko_examples/http_counter">http_counter</a></li>
<li><a href="https://github.com/demergent-labs/kybra/tree/main/examples/outgoing_http_requests">outgoing_http_requests</a></li>
<li><a href="https://github.com/demergent-labs/kybra/tree/main/examples/motoko_examples/whoami">whoami</a></li>
</ul>
<pre><code class="language-python">from kybra import ic, Principal, query


# returns this canister's id
@query
def id() -&gt; Principal:
    return ic.id()
</code></pre>
<div style="break-before: page; page-break-before: always;"></div><h1 id="data-certificate"><a class="header" href="#data-certificate">data certificate</a></h1>
<p>This section is a work in progress.</p>
<p>Examples:</p>
<ul>
<li><a href="https://github.com/demergent-labs/kybra/tree/main/examples/ic_api">ic_api</a></li>
</ul>
<pre><code class="language-python">from kybra import blob, ic, Opt, query


# When called from a query call, returns the data certificate authenticating certified_data set by this canister. Returns None if not called from a query call.
@query
def data_certificate() -&gt; Opt[blob]:
    return ic.data_certificate()
</code></pre>
<div style="break-before: page; page-break-before: always;"></div><h1 id="print"><a class="header" href="#print">print</a></h1>
<p>This section is a work in progress.</p>
<p>Examples:</p>
<ul>
<li><a href="https://github.com/demergent-labs/kybra/tree/main/examples/ic_api">ic_api</a></li>
<li><a href="https://github.com/demergent-labs/kybra/tree/main/examples/null_example">null_example</a></li>
</ul>
<p>You should always use <code>ic.print</code> instead of <code>print</code>.</p>
<pre><code class="language-python">from kybra import ic, query


# prints a message through the local replica's output
@query
def print(message: str) -&gt; bool:
    ic.print(message)

    return True
</code></pre>
<div style="break-before: page; page-break-before: always;"></div><h1 id="set-certified-data"><a class="header" href="#set-certified-data">set certified data</a></h1>
<p>This section is a work in progress.</p>
<p>Examples:</p>
<ul>
<li><a href="https://github.com/demergent-labs/kybra/tree/main/examples/ic_api">ic_api</a></li>
</ul>
<pre><code class="language-python">from kybra import blob, ic, update, void


# sets up to 32 bytes of certified data
@update
def set_certified_data(data: blob) -&gt; void:
    ic.set_certified_data(data)
</code></pre>
<div style="break-before: page; page-break-before: always;"></div><h1 id="time"><a class="header" href="#time">time</a></h1>
<p>This section is a work in progress.</p>
<p>Examples:</p>
<ul>
<li><a href="https://github.com/demergent-labs/kybra/tree/main/examples/audio_recorder">audio_recorder</a></li>
<li><a href="https://github.com/demergent-labs/kybra/tree/main/examples/ic_api">ic_api</a></li>
</ul>
<pre><code class="language-python">from kybra import ic, nat64, query


# returns the current timestamp
@query
def time() -&gt; nat64:
    return ic.time()
</code></pre>
<div style="break-before: page; page-break-before: always;"></div><h1 id="trap"><a class="header" href="#trap">trap</a></h1>
<p>This section is a work in progress.</p>
<p>Examples:</p>
<ul>
<li><a href="https://github.com/demergent-labs/kybra/tree/main/examples/cross_canister_calls">cross_canister_calls</a></li>
<li><a href="https://github.com/demergent-labs/kybra/tree/main/examples/ethereum_json_rpc">ethereum_json_rpc</a></li>
<li><a href="https://github.com/demergent-labs/kybra/tree/main/examples/motoko_examples/http_counter">http_counter</a></li>
<li><a href="https://github.com/demergent-labs/kybra/tree/main/examples/ic_api">ic_api</a></li>
<li><a href="https://github.com/demergent-labs/kybra/tree/main/examples/outgoing_http_requests">outgoing_http_requests</a></li>
</ul>
<pre><code class="language-python">from kybra import ic, query


# traps with a message, stopping execution and discarding all state within the call
@query
def trap(message: str) -&gt; bool:
    ic.trap(message)

    return True
</code></pre>
<div style="break-before: page; page-break-before: always;"></div><h1 id="canister-methods"><a class="header" href="#canister-methods">Canister Methods</a></h1>
<ul>
<li><a href="reference/canister_methods/./heartbeat.html">heartbeat</a></li>
<li><a href="reference/canister_methods/./http_request.html">http_request</a></li>
<li><a href="reference/canister_methods/./http_request_update.html">http_request_update</a></li>
<li><a href="reference/canister_methods/./init.html">init</a></li>
<li><a href="reference/canister_methods/./inspect_message.html">inspect message</a></li>
<li><a href="reference/canister_methods/./post_upgrade.html">post upgrade</a></li>
<li><a href="reference/canister_methods/./pre_upgrade.html">pre upgrade</a></li>
<li><a href="reference/canister_methods/./query.html">query</a></li>
<li><a href="reference/canister_methods/./update.html">update</a></li>
</ul>
<div style="break-before: page; page-break-before: always;"></div><h1 id="heartbeat"><a class="header" href="#heartbeat">heartbeat</a></h1>
<p>This section is a work in progress.</p>
<p>Examples:</p>
<ul>
<li><a href="https://github.com/demergent-labs/kybra/tree/main/examples/heartbeat">heartbeat</a></li>
</ul>
<pre><code class="language-python">from kybra import heartbeat, ic, void


@heartbeat
def heartbeat_() -&gt; void:
    ic.print(&quot;this runs ~1 time per second&quot;)
</code></pre>
<div style="break-before: page; page-break-before: always;"></div><h1 id="http_request"><a class="header" href="#http_request">http_request</a></h1>
<p>This section is a work in progress.</p>
<p>Examples:</p>
<ul>
<li><a href="https://github.com/demergent-labs/kybra/tree/main/examples/motoko_examples/http_counter">http_counter</a></li>
</ul>
<pre><code class="language-python">from kybra import blob, Func, nat16, Opt, query, Query, Record, Tuple, Variant, Vec


class HttpRequest(Record):
    method: str
    url: str
    headers: Vec[&quot;Header&quot;]
    body: blob


class HttpResponse(Record):
    status_code: nat16
    headers: Vec[&quot;Header&quot;]
    body: blob
    streaming_strategy: Opt[&quot;StreamingStrategy&quot;]
    upgrade: Opt[bool]


Header = Tuple[str, str]


class StreamingStrategy(Variant):
    Callback: &quot;CallbackStrategy&quot;


class CallbackStrategy(Record):
    callback: &quot;Callback&quot;
    token: &quot;Token&quot;


Callback = Func(Query[[&quot;Token&quot;], &quot;StreamingCallbackHttpResponse&quot;])


class StreamingCallbackHttpResponse(Record):
    body: blob
    token: Opt[&quot;Token&quot;]


class Token(Record):
    arbitrary_data: str


@query
def http_request(req: HttpRequest) -&gt; HttpResponse:
    return {
        &quot;status_code&quot;: 200,
        &quot;headers&quot;: [],
        &quot;body&quot;: bytes(),
        &quot;streaming_strategy&quot;: None,
        &quot;upgrade&quot;: False,
    }
</code></pre>
<div style="break-before: page; page-break-before: always;"></div><h1 id="http_request_update"><a class="header" href="#http_request_update">http_request_update</a></h1>
<p>This section is a work in progress.</p>
<p>Examples:</p>
<ul>
<li><a href="https://github.com/demergent-labs/kybra/tree/main/examples/motoko_examples/http_counter">http_counter</a></li>
</ul>
<pre><code class="language-python">from kybra import blob, Func, nat16, Opt, query, Query, Record, Tuple, Variant, Vec


class HttpRequest(Record):
    method: str
    url: str
    headers: Vec[&quot;Header&quot;]
    body: blob


class HttpResponse(Record):
    status_code: nat16
    headers: Vec[&quot;Header&quot;]
    body: blob
    streaming_strategy: Opt[&quot;StreamingStrategy&quot;]
    upgrade: Opt[bool]


Header = Tuple[str, str]


class StreamingStrategy(Variant):
    Callback: &quot;CallbackStrategy&quot;


class CallbackStrategy(Record):
    callback: &quot;Callback&quot;
    token: &quot;Token&quot;


Callback = Func(Query[[&quot;Token&quot;], &quot;StreamingCallbackHttpResponse&quot;])


class StreamingCallbackHttpResponse(Record):
    body: blob
    token: Opt[&quot;Token&quot;]


class Token(Record):
    arbitrary_data: str


@query
def http_request_update(req: HttpRequest) -&gt; HttpResponse:
    return {
        &quot;status_code&quot;: 200,
        &quot;headers&quot;: [],
        &quot;body&quot;: bytes(),
        &quot;streaming_strategy&quot;: None,
        &quot;upgrade&quot;: False,
    }
</code></pre>
<div style="break-before: page; page-break-before: always;"></div><h1 id="init"><a class="header" href="#init">init</a></h1>
<p>This section is a work in progress.</p>
<p>Examples:</p>
<ul>
<li><a href="https://github.com/demergent-labs/kybra/tree/main/examples/ethereum_json_rpc">ethereum_json_rpc</a></li>
<li><a href="https://github.com/demergent-labs/kybra/tree/main/examples/func_types">func_types</a></li>
<li><a href="https://github.com/demergent-labs/kybra/tree/main/examples/init">init</a></li>
<li><a href="https://github.com/demergent-labs/kybra/tree/main/examples/motoko_examples/persistent-storage">persistent-storage</a></li>
<li><a href="https://github.com/demergent-labs/kybra/tree/main/examples/pre_and_post_upgrade">pre_and_post_upgrade</a></li>
<li><a href="https://github.com/demergent-labs/kybra/tree/main/examples/motoko_examples/whoami">whoami</a></li>
</ul>
<pre><code class="language-python">from kybra import ic, init, void


@init
def init_() -&gt; void:
    ic.print(&quot;This runs once when the canister is first initialized&quot;)
</code></pre>
<div style="break-before: page; page-break-before: always;"></div><h1 id="inspect-message"><a class="header" href="#inspect-message">inspect message</a></h1>
<p>This section is a work in progress.</p>
<p>Examples:</p>
<ul>
<li><a href="https://github.com/demergent-labs/kybra/tree/main/examples/inspect_message">inspect_message</a></li>
</ul>
<pre><code class="language-python">from kybra import ic, inspect_message, update, void


@inspect_message
def inspect_message_() -&gt; void:
    ic.print(&quot;inspect_message called&quot;)

    if ic.method_name() == &quot;accessible&quot;:
        ic.accept_message()
        return

    if ic.method_name() == &quot;inaccessible&quot;:
        return

    raise Exception(&quot;Method &quot; + ic.method_name() + &quot; is not allowed&quot;)


@update
def accessible() -&gt; bool:
    return True


@update
def inaccessible() -&gt; bool:
    return False


@update
def also_inaccessible() -&gt; bool:
    return False
</code></pre>
<div style="break-before: page; page-break-before: always;"></div><h1 id="post-upgrade"><a class="header" href="#post-upgrade">post upgrade</a></h1>
<p>This section is a work in progress.</p>
<p>Examples:</p>
<ul>
<li><a href="https://github.com/demergent-labs/kybra/tree/main/examples/pre_and_post_upgrade">pre_and_post_upgrade</a></li>
<li><a href="https://github.com/demergent-labs/kybra/tree/main/examples/motoko_examples/whoami">whoami</a></li>
</ul>
<pre><code class="language-python">from kybra import ic, post_upgrade, void


@post_upgrade
def post_upgrade_() -&gt; void:
    ic.print(&quot;This runs after every canister upgrade&quot;)
</code></pre>
<div style="break-before: page; page-break-before: always;"></div><h1 id="pre-upgrade"><a class="header" href="#pre-upgrade">pre upgrade</a></h1>
<p>This section is a work in progress.</p>
<p>Examples:</p>
<ul>
<li><a href="https://github.com/demergent-labs/kybra/tree/main/examples/pre_and_post_upgrade">pre_and_post_upgrade</a></li>
</ul>
<pre><code class="language-python">from kybra import ic, pre_upgrade, void


@pre_upgrade
def pre_upgrade_() -&gt; void:
    ic.print(&quot;This runs before every canister upgrade&quot;)
</code></pre>
<div style="break-before: page; page-break-before: always;"></div><h1 id="query"><a class="header" href="#query">query</a></h1>
<p>This section is a work in progress.</p>
<pre><code class="language-python">from kybra import query


@query
def simple_query() -&gt; str:
    return &quot;This is a query method&quot;
</code></pre>
<div style="break-before: page; page-break-before: always;"></div><h1 id="update"><a class="header" href="#update">update</a></h1>
<p>This section is a work in progress.</p>
<pre><code class="language-python">from kybra import query, update, void

message = &quot;&quot;


@query
def get_message() -&gt; str:
    return message


@update
def set_message(new_message: str) -&gt; void:
    global message
    message = new_message
</code></pre>
<div style="break-before: page; page-break-before: always;"></div><h1 id="guard-functions"><a class="header" href="#guard-functions">Guard Functions</a></h1>
<p>Guard functions allow you to protect your <code>query</code> and <code>update</code> methods.</p>
<p>Guard functions return a <code>GuardResult</code> that looks like this:</p>
<pre><code class="language-python">class GuardResult(Variant, total=False):
    Ok: null
    Err: str
</code></pre>
<p>Returning <code>Ok</code> will allow the protected method to proceed with execution. Returning <code>Err</code> will reject the canister method call.</p>
<p>Here's a contrived example where the world is protected only 50% of the time:</p>
<pre><code class="language-python">import random

from kybra import GuardResult, update


def protect_the_world() -&gt; GuardResult:
    if random.random() &gt; 0.5:
        return {&quot;Ok&quot;: None}
    else:
        return {&quot;Err&quot;: &quot;The world must be protected&quot;}


@update(guard=protect_the_world)
def hello_world() -&gt; str:
    return &quot;Hello world!&quot;
</code></pre>
<div style="break-before: page; page-break-before: always;"></div><h1 id="management-canister-1"><a class="header" href="#management-canister-1">Management Canister</a></h1>
<ul>
<li><a href="reference/management_canister/./bitcoin_get_balance.html">bitcoin_get_balance</a></li>
<li><a href="reference/management_canister/./bitcoin_get_current_fee_percentiles.html">bitcoin_get_current_fee_percentiles</a></li>
<li><a href="reference/management_canister/./bitcoin_get_utxos.html">bitcoin_get_utxos</a></li>
<li><a href="reference/management_canister/./bitcoin_send_transaction.html">bitcoin_send_transaction</a></li>
<li><a href="reference/management_canister/./canister_status.html">canister_status</a></li>
<li><a href="reference/management_canister/./create_canister.html">create_canister</a></li>
<li><a href="reference/management_canister/./delete_canister.html">delete_canister</a></li>
<li><a href="reference/management_canister/./deposit_cycles.html">deposit_cycles</a></li>
<li><a href="reference/management_canister/./ecdsa_public_key.html">ecdsa_public_key</a></li>
<li><a href="reference/management_canister/./http_request.html">http_request</a></li>
<li><a href="reference/management_canister/./install_code.html">install_code</a></li>
<li><a href="reference/management_canister/./provisional_create_canister_with_cycles.html">provisional_create_canister_with_cycles</a></li>
<li><a href="reference/management_canister/./provisional_top_up_canister.html">provisional_top_up_canister</a></li>
<li><a href="reference/management_canister/./raw_rand.html">raw_rand</a></li>
<li><a href="reference/management_canister/./sign_with_ecdsa.html">sign_with_ecdsa</a></li>
<li><a href="reference/management_canister/./start_canister.html">start_canister</a></li>
<li><a href="reference/management_canister/./stop_canister.html">stop_canister</a></li>
<li><a href="reference/management_canister/./uninstall_code.html">uninstall_code</a></li>
<li><a href="reference/management_canister/./update_settings.html">update_settings</a></li>
</ul>
<div style="break-before: page; page-break-before: always;"></div><h1 id="bitcoin_get_balance"><a class="header" href="#bitcoin_get_balance">bitcoin_get_balance</a></h1>
<p>This section is a work in progress.</p>
<p>Examples:</p>
<ul>
<li><a href="https://github.com/demergent-labs/kybra/tree/main/examples/bitcoin">bitcoin</a></li>
</ul>
<pre><code class="language-python">from kybra import Async, CallResult, match, update, Variant
from kybra.canisters.management import management_canister, Satoshi

BITCOIN_API_CYCLE_COST = 100_000_000


class ExecuteGetBalanceResult(Variant, total=False):
    Ok: Satoshi
    Err: str


@update
def get_balance(address: str) -&gt; Async[ExecuteGetBalanceResult]:
    call_result: CallResult[Satoshi] = yield management_canister.bitcoin_get_balance(
        {&quot;address&quot;: address, &quot;min_confirmations&quot;: None, &quot;network&quot;: {&quot;Regtest&quot;: None}}
    ).with_cycles(BITCOIN_API_CYCLE_COST)

    return match(
        call_result, {&quot;Ok&quot;: lambda ok: {&quot;Ok&quot;: ok}, &quot;Err&quot;: lambda err: {&quot;Err&quot;: err}}
    )
</code></pre>
<div style="break-before: page; page-break-before: always;"></div><h1 id="bitcoin_get_current_fee_percentiles"><a class="header" href="#bitcoin_get_current_fee_percentiles">bitcoin_get_current_fee_percentiles</a></h1>
<p>This section is a work in progress.</p>
<p>Examples:</p>
<ul>
<li><a href="https://github.com/demergent-labs/kybra/tree/main/examples/bitcoin">bitcoin</a></li>
</ul>
<pre><code class="language-python">from kybra import Async, CallResult, match, update, Variant, Vec
from kybra.canisters.management import management_canister, MillisatoshiPerByte

BITCOIN_API_CYCLE_COST = 100_000_000


class GetCurrentFeePercentilesResult(Variant, total=False):
    Ok: Vec[MillisatoshiPerByte]
    Err: str


@update
def get_current_fee_percentiles() -&gt; Async[GetCurrentFeePercentilesResult]:
    call_result: CallResult[
        Vec[MillisatoshiPerByte]
    ] = yield management_canister.bitcoin_get_current_fee_percentiles(
        {&quot;network&quot;: {&quot;Regtest&quot;: None}}
    ).with_cycles(
        BITCOIN_API_CYCLE_COST
    )

    return match(
        call_result, {&quot;Ok&quot;: lambda ok: {&quot;Ok&quot;: ok}, &quot;Err&quot;: lambda err: {&quot;Err&quot;: err}}
    )
</code></pre>
<div style="break-before: page; page-break-before: always;"></div><h1 id="bitcoin_get_utxos"><a class="header" href="#bitcoin_get_utxos">bitcoin_get_utxos</a></h1>
<p>This section is a work in progress.</p>
<p>Examples:</p>
<ul>
<li><a href="https://github.com/demergent-labs/kybra/tree/main/examples/bitcoin">bitcoin</a></li>
</ul>
<pre><code class="language-python">from kybra import Async, CallResult, match, update, Variant
from kybra.canisters.management import GetUtxosResult, management_canister

BITCOIN_API_CYCLE_COST = 100_000_000


class ExecuteGetUtxosResult(Variant, total=False):
    Ok: GetUtxosResult
    Err: str


@update
def get_utxos(address: str) -&gt; Async[ExecuteGetUtxosResult]:
    call_result: CallResult[
        GetUtxosResult
    ] = yield management_canister.bitcoin_get_utxos(
        {&quot;address&quot;: address, &quot;filter&quot;: None, &quot;network&quot;: {&quot;Regtest&quot;: None}}
    ).with_cycles(
        BITCOIN_API_CYCLE_COST
    )

    return match(
        call_result, {&quot;Ok&quot;: lambda ok: {&quot;Ok&quot;: ok}, &quot;Err&quot;: lambda err: {&quot;Err&quot;: err}}
    )
</code></pre>
<div style="break-before: page; page-break-before: always;"></div><h1 id="bitcoin_send_transaction"><a class="header" href="#bitcoin_send_transaction">bitcoin_send_transaction</a></h1>
<p>This section is a work in progress.</p>
<p>Examples:</p>
<ul>
<li><a href="https://github.com/demergent-labs/kybra/tree/main/examples/bitcoin">bitcoin</a></li>
</ul>
<pre><code class="language-python">from kybra import Async, blob, CallResult, match, null, update, Variant, void
from kybra.canisters.management import management_canister

BITCOIN_BASE_TRANSACTION_COST = 5_000_000_000
BITCOIN_CYCLE_COST_PER_TRANSACTION_BYTE = 20_000_000


class SendTransactionResult(Variant, total=False):
    Ok: null
    Err: str


@update
def send_transaction(transaction: blob) -&gt; Async[SendTransactionResult]:
    transaction_fee = (
        BITCOIN_BASE_TRANSACTION_COST
        + len(transaction) * BITCOIN_CYCLE_COST_PER_TRANSACTION_BYTE
    )

    call_result: CallResult[void] = yield management_canister.bitcoin_send_transaction(
        {&quot;transaction&quot;: transaction, &quot;network&quot;: {&quot;Regtest&quot;: None}}
    ).with_cycles(transaction_fee)

    return match(
        call_result, {&quot;Ok&quot;: lambda ok: {&quot;Ok&quot;: ok}, &quot;Err&quot;: lambda err: {&quot;Err&quot;: err}}
    )
</code></pre>
<div style="break-before: page; page-break-before: always;"></div><h1 id="canister_status"><a class="header" href="#canister_status">canister_status</a></h1>
<p>This section is a work in progress.</p>
<p>Examples:</p>
<ul>
<li><a href="https://github.com/demergent-labs/kybra/tree/main/examples/management_canister">management_canister</a></li>
</ul>
<pre><code class="language-python">from kybra import Async, CallResult, match, update, Variant
from kybra.canisters.management import (
    CanisterStatusArgs,
    CanisterStatusResult,
    management_canister,
)


class GetCanisterStatusResult(Variant, total=False):
    Ok: CanisterStatusResult
    Err: str


@update
def get_canister_status(args: CanisterStatusArgs) -&gt; Async[GetCanisterStatusResult]:
    canister_status_result_call_result: CallResult[
        CanisterStatusResult
    ] = yield management_canister.canister_status({&quot;canister_id&quot;: args[&quot;canister_id&quot;]})

    return match(
        canister_status_result_call_result,
        {&quot;Ok&quot;: lambda ok: {&quot;Ok&quot;: ok}, &quot;Err&quot;: lambda err: {&quot;Err&quot;: err}},
    )
</code></pre>
<div style="break-before: page; page-break-before: always;"></div><h1 id="create_canister"><a class="header" href="#create_canister">create_canister</a></h1>
<p>This section is a work in progress.</p>
<p>Examples:</p>
<ul>
<li><a href="https://github.com/demergent-labs/kybra/tree/main/examples/management_canister">management_canister</a></li>
</ul>
<pre><code class="language-python">from kybra import Async, CallResult, match, update, Variant
from kybra.canisters.management import CreateCanisterResult, management_canister


class ExecuteCreateCanisterResult(Variant, total=False):
    Ok: CreateCanisterResult
    Err: str


@update
def execute_create_canister() -&gt; Async[ExecuteCreateCanisterResult]:
    create_canister_result_call_result: CallResult[
        CreateCanisterResult
    ] = yield management_canister.create_canister({&quot;settings&quot;: None}).with_cycles(
        50_000_000_000_000
    )

    return match(
        create_canister_result_call_result,
        {&quot;Ok&quot;: lambda ok: {&quot;Ok&quot;: ok}, &quot;Err&quot;: lambda err: {&quot;Err&quot;: err}},
    )
</code></pre>
<div style="break-before: page; page-break-before: always;"></div><h1 id="delete_canister"><a class="header" href="#delete_canister">delete_canister</a></h1>
<p>This section is a work in progress.</p>
<p>Examples:</p>
<ul>
<li><a href="https://github.com/demergent-labs/kybra/tree/main/examples/management_canister">management_canister</a></li>
</ul>
<pre><code class="language-python">from kybra import (
    Async,
    CallResult,
    match,
    Principal,
    update,
    Variant,
    void,
)
from kybra.canisters.management import management_canister


class DefaultResult(Variant, total=False):
    Ok: bool
    Err: str


@update
def execute_delete_canister(canister_id: Principal) -&gt; Async[DefaultResult]:
    call_result: CallResult[void] = yield management_canister.delete_canister(
        {&quot;canister_id&quot;: canister_id}
    )

    return match(
        call_result, {&quot;Ok&quot;: lambda _: {&quot;Ok&quot;: True}, &quot;Err&quot;: lambda err: {&quot;Err&quot;: err}}
    )
</code></pre>
<div style="break-before: page; page-break-before: always;"></div><h1 id="deposit_cycles"><a class="header" href="#deposit_cycles">deposit_cycles</a></h1>
<p>This section is a work in progress.</p>
<p>Examples:</p>
<ul>
<li><a href="https://github.com/demergent-labs/kybra/tree/main/examples/management_canister">management_canister</a></li>
</ul>
<pre><code class="language-python">from kybra import Async, CallResult, match, Principal, update, Variant, void
from kybra.canisters.management import management_canister


class DefaultResult(Variant, total=False):
    Ok: bool
    Err: str


@update
def execute_deposit_cycles(canister_id: Principal) -&gt; Async[DefaultResult]:
    call_result: CallResult[void] = yield management_canister.deposit_cycles(
        {&quot;canister_id&quot;: canister_id}
    ).with_cycles(1_000_000)

    return match(
        call_result, {&quot;Ok&quot;: lambda _: {&quot;Ok&quot;: True}, &quot;Err&quot;: lambda err: {&quot;Err&quot;: err}}
    )
</code></pre>
<div style="break-before: page; page-break-before: always;"></div><h1 id="ecdsa_public_key"><a class="header" href="#ecdsa_public_key">ecdsa_public_key</a></h1>
<p>This section is a work in progress.</p>
<p>Examples:</p>
<ul>
<li><a href="https://github.com/demergent-labs/kybra/tree/main/examples/motoko_examples/threshold_ecdsa">threshold_ecdsa</a></li>
</ul>
<pre><code class="language-python">from kybra import Async, blob, CallResult, ic, match, Record, update, Variant
from kybra.canisters.management import management_canister, EcdsaPublicKeyResult


class PublicKey(Record):
    public_key: blob


class PublicKeyResult(Variant, total=False):
    Ok: PublicKey
    Err: str


@update
def public_key() -&gt; Async[PublicKeyResult]:
    caller = ic.caller().bytes
    call_result: CallResult[
        EcdsaPublicKeyResult
    ] = yield management_canister.ecdsa_public_key(
        {
            &quot;canister_id&quot;: None,
            &quot;derivation_path&quot;: [caller],
            &quot;key_id&quot;: {&quot;curve&quot;: {&quot;secp256k1&quot;: None}, &quot;name&quot;: &quot;dfx_test_key&quot;},
        }
    )

    return match(
        call_result, {&quot;Ok&quot;: lambda ok: {&quot;Ok&quot;: ok}, &quot;Err&quot;: lambda err: {&quot;Err&quot;: err}}
    )
</code></pre>
<div style="break-before: page; page-break-before: always;"></div><h1 id="http_request-1"><a class="header" href="#http_request-1">http_request</a></h1>
<p>This section is a work in progress.</p>
<p>Examples:</p>
<ul>
<li><a href="https://github.com/demergent-labs/kybra/tree/main/examples/ethereum_json_rpc">ethereum_json_rpc</a></li>
<li><a href="https://github.com/demergent-labs/kybra/tree/main/examples/outgoing_http_requests">outgoing_http_requests</a></li>
</ul>
<pre><code class="language-python">from kybra import Async, CallResult, match, ic, query, update
from kybra.canisters.management import (
    HttpResponse,
    HttpTransformArgs,
    management_canister,
)


@update
def xkcd() -&gt; Async[HttpResponse]:
    max_response_bytes = 1_000

    # TODO this is just a heuristic for cost, might change when the feature is officially released: https://forum.dfinity.org/t/enable-canisters-to-make-http-s-requests/9670/130
    cycle_cost_base = 400_000_000
    cycle_cost_per_byte = 300_000  # TODO not sure on this exact cost
    cycle_cost_total = cycle_cost_base + cycle_cost_per_byte * max_response_bytes

    http_result: CallResult[HttpResponse] = yield management_canister.http_request(
        {
            &quot;url&quot;: &quot;https://xkcd.com/642/info.0.json&quot;,
            &quot;max_response_bytes&quot;: max_response_bytes,
            &quot;method&quot;: {&quot;get&quot;: None},
            &quot;headers&quot;: [],
            &quot;body&quot;: None,
            &quot;transform&quot;: {&quot;function&quot;: (ic.id(), &quot;xkcd_transform&quot;), &quot;context&quot;: bytes()},
        }
    ).with_cycles(cycle_cost_total)

    return match(http_result, {&quot;Ok&quot;: lambda ok: ok, &quot;Err&quot;: lambda err: ic.trap(err)})


@query
def xkcd_transform(args: HttpTransformArgs) -&gt; HttpResponse:
    http_response = args[&quot;response&quot;]

    http_response[&quot;headers&quot;] = []

    return http_response
</code></pre>
<div style="break-before: page; page-break-before: always;"></div><h1 id="install_code"><a class="header" href="#install_code">install_code</a></h1>
<p>This section is a work in progress.</p>
<p>Examples:</p>
<ul>
<li><a href="https://github.com/demergent-labs/kybra/tree/main/examples/management_canister">management_canister</a></li>
</ul>
<pre><code class="language-python">from kybra import (
    Async,
    blob,
    CallResult,
    match,
    Principal,
    update,
    Variant,
    void,
)
from kybra.canisters.management import management_canister


class DefaultResult(Variant, total=False):
    Ok: bool
    Err: str


@update
def execute_install_code(
    canister_id: Principal, wasm_module: blob
) -&gt; Async[DefaultResult]:
    call_result: CallResult[void] = yield management_canister.install_code(
        {
            &quot;mode&quot;: {&quot;install&quot;: None},
            &quot;canister_id&quot;: canister_id,
            &quot;wasm_module&quot;: wasm_module,
            &quot;arg&quot;: bytes(),
        }
    ).with_cycles(100_000_000_000)

    return match(
        call_result, {&quot;Ok&quot;: lambda _: {&quot;Ok&quot;: True}, &quot;Err&quot;: lambda err: {&quot;Err&quot;: err}}
    )
</code></pre>
<div style="break-before: page; page-break-before: always;"></div><h1 id="provisional_create_canister_with_cycles"><a class="header" href="#provisional_create_canister_with_cycles">provisional_create_canister_with_cycles</a></h1>
<p>This section is a work in progress.</p>
<p>Examples:</p>
<ul>
<li><a href="https://github.com/demergent-labs/kybra/tree/main/examples/management_canister">management_canister</a></li>
</ul>
<pre><code class="language-python">from kybra import Async, CallResult, match, update, Variant
from kybra.canisters.management import (
    CreateCanisterResult,
    management_canister,
    ProvisionalCreateCanisterWithCyclesResult,
)


class ExecuteProvisionalCreateCanisterWithCyclesResult(Variant, total=False):
    Ok: CreateCanisterResult
    Err: str


@update
def provisional_create_canister_with_cycles() -&gt; (
    Async[ExecuteProvisionalCreateCanisterWithCyclesResult]
):
    call_result: CallResult[
        ProvisionalCreateCanisterWithCyclesResult
    ] = yield management_canister.provisional_create_canister_with_cycles(
        {&quot;amount&quot;: None, &quot;settings&quot;: None}
    )

    return match(
        call_result, {&quot;Ok&quot;: lambda ok: {&quot;Ok&quot;: ok}, &quot;Err&quot;: lambda err: {&quot;Err&quot;: err}}
    )
</code></pre>
<div style="break-before: page; page-break-before: always;"></div><h1 id="provisional_top_up_canister"><a class="header" href="#provisional_top_up_canister">provisional_top_up_canister</a></h1>
<p>This section is a work in progress.</p>
<p>Examples:</p>
<ul>
<li><a href="https://github.com/demergent-labs/kybra/tree/main/examples/management_canister">management_canister</a></li>
</ul>
<pre><code class="language-python">from kybra import (
    Async,
    CallResult,
    match,
    nat,
    Principal,
    update,
    Variant,
    void,
)
from kybra.canisters.management import management_canister


class DefaultResult(Variant, total=False):
    Ok: bool
    Err: str


@update
def provisional_top_up_canister(
    canister_id: Principal, amount: nat
) -&gt; Async[DefaultResult]:
    call_result: CallResult[
        void
    ] = yield management_canister.provisional_top_up_canister(
        {&quot;canister_id&quot;: canister_id, &quot;amount&quot;: amount}
    )

    return match(
        call_result, {&quot;Ok&quot;: lambda _: {&quot;Ok&quot;: True}, &quot;Err&quot;: lambda err: {&quot;Err&quot;: err}}
    )
</code></pre>
<div style="break-before: page; page-break-before: always;"></div><h1 id="raw_rand"><a class="header" href="#raw_rand">raw_rand</a></h1>
<p>This section is a work in progress.</p>
<p>Examples:</p>
<ul>
<li><a href="https://github.com/demergent-labs/kybra/tree/main/examples/generators">generators</a></li>
<li><a href="https://github.com/demergent-labs/kybra/tree/main/examples/heartbeat">heartbeat</a></li>
<li><a href="https://github.com/demergent-labs/kybra/tree/main/examples/management_canister">management_canister</a></li>
<li><a href="https://github.com/demergent-labs/kybra/tree/main/examples/timers">timers</a></li>
</ul>
<pre><code class="language-python">from kybra import Async, blob, CallResult, match, update
from kybra.canisters.management import management_canister


@update
def get_randomness_directly() -&gt; Async[blob]:
    randomness_result: CallResult[blob] = yield management_canister.raw_rand()

    return match(randomness_result, {&quot;Ok&quot;: lambda ok: ok, &quot;Err&quot;: lambda err: err})
</code></pre>
<div style="break-before: page; page-break-before: always;"></div><h1 id="sign_with_ecdsa"><a class="header" href="#sign_with_ecdsa">sign_with_ecdsa</a></h1>
<p>This section is a work in progress.</p>
<p>Examples:</p>
<ul>
<li><a href="https://github.com/demergent-labs/kybra/tree/main/examples/motoko_examples/threshold_ecdsa">threshold_ecdsa</a></li>
</ul>
<pre><code class="language-python">from kybra import Async, blob, CallResult, ic, match, Record, update, Variant
from kybra.canisters.management import (
    management_canister,
    SignWithEcdsaResult,
)


class Signature(Record):
    signature: blob


class SignResult(Variant, total=False):
    Ok: Signature
    Err: str


@update
def sign(message_hash: blob) -&gt; Async[SignResult]:
    if len(message_hash) != 32:
        ic.trap(&quot;message_hash must be 32 bytes&quot;)

    caller = ic.caller().bytes

    call_result: CallResult[
        SignWithEcdsaResult
    ] = yield management_canister.sign_with_ecdsa(
        {
            &quot;message_hash&quot;: message_hash,
            &quot;derivation_path&quot;: [caller],
            &quot;key_id&quot;: {&quot;curve&quot;: {&quot;secp256k1&quot;: None}, &quot;name&quot;: &quot;dfx_test_key&quot;},
        }
    ).with_cycles(
        10_000_000_000
    )

    return match(
        call_result, {&quot;Ok&quot;: lambda ok: {&quot;Ok&quot;: ok}, &quot;Err&quot;: lambda err: {&quot;Err&quot;: err}}
    )
</code></pre>
<div style="break-before: page; page-break-before: always;"></div><h1 id="start_canister"><a class="header" href="#start_canister">start_canister</a></h1>
<p>This section is a work in progress.</p>
<p>Examples:</p>
<ul>
<li><a href="https://github.com/demergent-labs/kybra/tree/main/examples/management_canister">management_canister</a></li>
</ul>
<pre><code class="language-python">from kybra import (
    Async,
    CallResult,
    match,
    Principal,
    update,
    Variant,
    void,
)
from kybra.canisters.management import management_canister


class DefaultResult(Variant, total=False):
    Ok: bool
    Err: str


@update
def execute_start_canister(canister_id: Principal) -&gt; Async[DefaultResult]:
    call_result: CallResult[void] = yield management_canister.start_canister(
        {&quot;canister_id&quot;: canister_id}
    )

    return match(
        call_result, {&quot;Ok&quot;: lambda _: {&quot;Ok&quot;: True}, &quot;Err&quot;: lambda err: {&quot;Err&quot;: err}}
    )
</code></pre>
<div style="break-before: page; page-break-before: always;"></div><h1 id="stop_canister"><a class="header" href="#stop_canister">stop_canister</a></h1>
<p>This section is a work in progress.</p>
<p>Examples:</p>
<ul>
<li><a href="https://github.com/demergent-labs/kybra/tree/main/examples/management_canister">management_canister</a></li>
</ul>
<pre><code class="language-python">from kybra import (
    Async,
    CallResult,
    match,
    Principal,
    update,
    Variant,
    void,
)
from kybra.canisters.management import management_canister


class DefaultResult(Variant, total=False):
    Ok: bool
    Err: str


@update
def execute_stop_canister(canister_id: Principal) -&gt; Async[DefaultResult]:
    call_result: CallResult[void] = yield management_canister.stop_canister(
        {&quot;canister_id&quot;: canister_id}
    )

    return match(
        call_result, {&quot;Ok&quot;: lambda _: {&quot;Ok&quot;: True}, &quot;Err&quot;: lambda err: {&quot;Err&quot;: err}}
    )
</code></pre>
<div style="break-before: page; page-break-before: always;"></div><h1 id="uninstall_code"><a class="header" href="#uninstall_code">uninstall_code</a></h1>
<p>This section is a work in progress.</p>
<p>Examples:</p>
<ul>
<li><a href="https://github.com/demergent-labs/kybra/tree/main/examples/management_canister">management_canister</a></li>
</ul>
<pre><code class="language-python">from kybra import Async, CallResult, match, Principal, update, Variant, void
from kybra.canisters.management import management_canister


class DefaultResult(Variant, total=False):
    Ok: bool
    Err: str


@update
def execute_uninstall_code(canister_id: Principal) -&gt; Async[DefaultResult]:
    call_result: CallResult[void] = yield management_canister.uninstall_code(
        {&quot;canister_id&quot;: canister_id}
    )

    return match(
        call_result, {&quot;Ok&quot;: lambda _: {&quot;Ok&quot;: True}, &quot;Err&quot;: lambda err: {&quot;Err&quot;: err}}
    )
</code></pre>
<div style="break-before: page; page-break-before: always;"></div><h1 id="update_settings"><a class="header" href="#update_settings">update_settings</a></h1>
<p>This section is a work in progress.</p>
<p>Examples:</p>
<ul>
<li><a href="https://github.com/demergent-labs/kybra/tree/main/examples/management_canister">management_canister</a></li>
</ul>
<pre><code class="language-python">from kybra import Async, CallResult, match, Principal, update, Variant, void
from kybra.canisters.management import management_canister


class DefaultResult(Variant, total=False):
    Ok: bool
    Err: str


@update
def execute_update_settings(canister_id: Principal) -&gt; Async[DefaultResult]:
    call_result: CallResult[void] = yield management_canister.update_settings(
        {
            &quot;canister_id&quot;: canister_id,
            &quot;settings&quot;: {
                &quot;controllers&quot;: None,
                &quot;compute_allocation&quot;: 1,
                &quot;memory_allocation&quot;: 3_000_000,
                &quot;freezing_threshold&quot;: 2_000_000,
            },
        }
    )

    return match(
        call_result, {&quot;Ok&quot;: lambda _: {&quot;Ok&quot;: True}, &quot;Err&quot;: lambda err: {&quot;Err&quot;: err}}
    )
</code></pre>
<div style="break-before: page; page-break-before: always;"></div><h1 id="stable-memory"><a class="header" href="#stable-memory">Stable Memory</a></h1>
<ul>
<li><a href="reference/stable_memory/./stable_structures.html">stable structures</a></li>
<li><a href="reference/stable_memory/./stable_bytes.html">stable bytes</a></li>
<li><a href="reference/stable_memory/./stable_grow.html">stable grow</a></li>
<li><a href="reference/stable_memory/./stable_read.html">stable read</a></li>
<li><a href="reference/stable_memory/./stable_size.html">stable size</a></li>
<li><a href="reference/stable_memory/./stable_write.html">stable write</a></li>
<li><a href="reference/stable_memory/./stable64_grow.html">stable64 grow</a></li>
<li><a href="reference/stable_memory/./stable64_read.html">stable64 read</a></li>
<li><a href="reference/stable_memory/./stable64_size.html">stable64 size</a></li>
<li><a href="reference/stable_memory/./stable64_write.html">stable64 write</a></li>
</ul>
<div style="break-before: page; page-break-before: always;"></div><h1 id="stable-structures-1"><a class="header" href="#stable-structures-1">stable structures</a></h1>
<p>This section is a work in progress.</p>
<p>Examples:</p>
<ul>
<li><a href="https://github.com/demergent-labs/kybra/tree/main/examples/audio_recorder">audio_recorder</a></li>
<li><a href="https://github.com/demergent-labs/kybra/tree/main/examples/ethereum_json_rpc">ethereum_json_rpc</a></li>
<li><a href="https://github.com/demergent-labs/kybra/tree/main/examples/func_types">func_types</a></li>
<li><a href="https://github.com/demergent-labs/kybra/tree/main/examples/motoko_examples/http_counter">http_counter</a></li>
<li><a href="https://github.com/demergent-labs/kybra/tree/main/examples/motoko_examples/persistent-storage">persistent-storage</a></li>
<li><a href="https://github.com/demergent-labs/kybra/tree/main/examples/pre_and_post_upgrade">pre_and_post_upgrade</a></li>
<li><a href="https://github.com/demergent-labs/kybra/tree/main/examples/stable_structures">stable_structures</a></li>
</ul>
<pre><code class="language-python">from kybra import (
    Alias,
    nat64,
    nat8,
    Opt,
    query,
    StableBTreeMap,
    Tuple,
    update,
    Vec,
)

Key = Alias[nat8]
Value = Alias[str]


map = StableBTreeMap[Key, Value](memory_id=3, max_key_size=100, max_value_size=1_000)


@query
def contains_key(key: Key) -&gt; bool:
    return map.contains_key(key)


@query
def get(key: Key) -&gt; Opt[Value]:
    return map.get(key)


@update
def insert(key: Key, value: Value) -&gt; Opt[Value]:
    return map.insert(key, value)


@query
def is_empty() -&gt; bool:
    return map.is_empty()


@query
def items() -&gt; Vec[Tuple[Key, Value]]:
    return map.items()


@query
def keys() -&gt; Vec[Key]:
    return map.keys()


@query
def len() -&gt; nat64:
    return map.len()


@update
def remove(key: Key) -&gt; Opt[Value]:
    return map.remove(key)


@query
def values() -&gt; Vec[Value]:
    return map.values()
</code></pre>
<div style="break-before: page; page-break-before: always;"></div><h1 id="stable-bytes"><a class="header" href="#stable-bytes">stable bytes</a></h1>
<p>This section is a work in progress.</p>
<p>Examples:</p>
<ul>
<li><a href="https://github.com/demergent-labs/kybra/tree/main/examples/stable_memory">stable_memory</a></li>
</ul>
<pre><code class="language-python">from kybra import blob, ic, query


@query
def stable_bytes() -&gt; blob:
    return ic.stable_bytes()
</code></pre>
<div style="break-before: page; page-break-before: always;"></div><h1 id="stable-grow"><a class="header" href="#stable-grow">stable grow</a></h1>
<p>This section is a work in progress.</p>
<p>Examples:</p>
<ul>
<li><a href="https://github.com/demergent-labs/kybra/tree/main/examples/stable_memory">stable_memory</a></li>
</ul>
<pre><code class="language-python">from kybra import ic, nat32, StableGrowResult, update


@update
def stable_grow(new_pages: nat32) -&gt; StableGrowResult:
    return ic.stable_grow(new_pages)
</code></pre>
<div style="break-before: page; page-break-before: always;"></div><h1 id="stable-read"><a class="header" href="#stable-read">stable read</a></h1>
<p>This section is a work in progress.</p>
<p>Examples:</p>
<ul>
<li><a href="https://github.com/demergent-labs/kybra/tree/main/examples/stable_memory">stable_memory</a></li>
</ul>
<pre><code class="language-python">from kybra import blob, ic, nat32, query


@query
def stable_read(offset: nat32, length: nat32) -&gt; blob:
    return ic.stable_read(offset, length)
</code></pre>
<div style="break-before: page; page-break-before: always;"></div><h1 id="stable-size"><a class="header" href="#stable-size">stable size</a></h1>
<p>This section is a work in progress.</p>
<p>Examples:</p>
<ul>
<li><a href="https://github.com/demergent-labs/kybra/tree/main/examples/stable_memory">stable_memory</a></li>
</ul>
<pre><code class="language-python">from kybra import ic, nat32, query


@query
def stable_size() -&gt; nat32:
    return ic.stable_size()
</code></pre>
<div style="break-before: page; page-break-before: always;"></div><h1 id="stable-write"><a class="header" href="#stable-write">stable write</a></h1>
<p>This section is a work in progress.</p>
<p>Examples:</p>
<ul>
<li><a href="https://github.com/demergent-labs/kybra/tree/main/examples/stable_memory">stable_memory</a></li>
</ul>
<pre><code class="language-python">from kybra import blob, ic, nat32, update, void


@update
def stable_write(offset: nat32, buf: blob) -&gt; void:
    ic.stable_write(offset, buf)
</code></pre>
<div style="break-before: page; page-break-before: always;"></div><h1 id="stable64-grow"><a class="header" href="#stable64-grow">stable64 grow</a></h1>
<p>This section is a work in progress.</p>
<p>Examples:</p>
<ul>
<li><a href="https://github.com/demergent-labs/kybra/tree/main/examples/stable_memory">stable_memory</a></li>
</ul>
<pre><code class="language-python">from kybra import ic, nat64, Stable64GrowResult, update


@update
def stable_grow(new_pages: nat64) -&gt; Stable64GrowResult:
    return ic.stable_grow(new_pages)
</code></pre>
<div style="break-before: page; page-break-before: always;"></div><h1 id="stable64-read"><a class="header" href="#stable64-read">stable64 read</a></h1>
<p>This section is a work in progress.</p>
<p>Examples:</p>
<ul>
<li><a href="https://github.com/demergent-labs/kybra/tree/main/examples/stable_memory">stable_memory</a></li>
</ul>
<pre><code class="language-python">from kybra import blob, ic, nat64, query


@query
def stable64_read(offset: nat64, length: nat64) -&gt; blob:
    return ic.stable64_read(offset, length)
</code></pre>
<div style="break-before: page; page-break-before: always;"></div><h1 id="stable64-size"><a class="header" href="#stable64-size">stable64 size</a></h1>
<p>This section is a work in progress.</p>
<p>Examples:</p>
<ul>
<li><a href="https://github.com/demergent-labs/kybra/tree/main/examples/stable_memory">stable_memory</a></li>
</ul>
<pre><code class="language-python">from kybra import ic, nat64, query


@query
def stable64_size() -&gt; nat64:
    return ic.stable64_size()
</code></pre>
<div style="break-before: page; page-break-before: always;"></div><h1 id="stable64-write"><a class="header" href="#stable64-write">stable64 write</a></h1>
<p>This section is a work in progress.</p>
<p>Examples:</p>
<ul>
<li><a href="https://github.com/demergent-labs/kybra/tree/main/examples/stable_memory">stable_memory</a></li>
</ul>
<pre><code class="language-python">from kybra import blob, ic, nat64, update, void


@update
def stable64_write(offset: nat64, buf: blob) -&gt; void:
    ic.stable64_write(offset, buf)
</code></pre>
<div style="break-before: page; page-break-before: always;"></div><h1 id="timers-1"><a class="header" href="#timers-1">Timers</a></h1>
<ul>
<li><a href="reference/timers/./clear_timer.html">clear timer</a></li>
<li><a href="reference/timers/./set_timer.html">set timer</a></li>
<li><a href="reference/timers/./set_timer_interval.html">set timer interval</a></li>
</ul>
<div style="break-before: page; page-break-before: always;"></div><h1 id="clear-timer"><a class="header" href="#clear-timer">clear timer</a></h1>
<p>This section is a work in progress.</p>
<p>Examples:</p>
<ul>
<li><a href="https://github.com/demergent-labs/kybra/tree/main/examples/timers">timers</a></li>
</ul>
<pre><code class="language-python">from kybra import ic, TimerId, update, void


@update
def clear_timer(timer_id: TimerId) -&gt; void:
    ic.clear_timer(timer_id)
    ic.print(f&quot;timer {timer_id} cancelled&quot;)
</code></pre>
<div style="break-before: page; page-break-before: always;"></div><h1 id="set-timer"><a class="header" href="#set-timer">set timer</a></h1>
<p>This section is a work in progress.</p>
<p>Examples:</p>
<ul>
<li><a href="https://github.com/demergent-labs/kybra/tree/main/examples/timers">timers</a></li>
</ul>
<pre><code class="language-python">from kybra import (
    Duration,
    ic,
    TimerId,
    update,
)


@update
def set_timer(delay: Duration) -&gt; TimerId:
    return ic.set_timer(delay, timer_callback)


def timer_callback():
    ic.print(&quot;timer_callback&quot;)
</code></pre>
<div style="break-before: page; page-break-before: always;"></div><h1 id="set-timer-interval"><a class="header" href="#set-timer-interval">set timer interval</a></h1>
<p>This section is a work in progress.</p>
<p>Examples:</p>
<ul>
<li><a href="https://github.com/demergent-labs/kybra/tree/main/examples/timers">timers</a></li>
</ul>
<pre><code class="language-python">from kybra import (
    Duration,
    ic,
    TimerId,
    update,
)

counter = 0


@update
def set_timer_interval(interval: Duration) -&gt; TimerId:
    return ic.set_timer_interval(interval, timer_callback)


def timer_callback():
    global counter
    counter += 1

    ic.print(f&quot;timer_callback: {counter}&quot;)
</code></pre>

                    </main>

                    <nav class="nav-wrapper" aria-label="Page navigation">
                        <!-- Mobile navigation buttons -->


                        <div style="clear: both"></div>
                    </nav>
                </div>
            </div>

            <nav class="nav-wide-wrapper" aria-label="Page navigation">

            </nav>

        </div>




        <script>
            window.playground_copyable = true;
        </script>


        <script src="elasticlunr.min.js"></script>
        <script src="mark.min.js"></script>
        <script src="searcher.js"></script>

        <script src="clipboard.min.js"></script>
        <script src="highlight.js"></script>
        <script src="book.js"></script>

        <!-- Custom JS scripts -->

        <script>
        window.addEventListener('load', function() {
            window.setTimeout(window.print, 100);
        });
        </script>

    </div>
    </body>
</html>
